<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>HELPER • Permisiuni (ACL)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body{margin:0;font-family:Calibri,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);border-radius:18px;padding:18px 18px 14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.06);font-weight:700;font-size:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.16);background:rgba(255,255,255,0.08);color:#fff;font-weight:800;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.12)}
    select,input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(0,0,0,0.25);color:#fff;outline:none}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:14px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,0.10);font-size:13px}
    th{position:sticky;top:0;background:rgba(255,255,255,0.07);text-align:left}
    tr:hover td{background:rgba(255,255,255,0.04)}
    .chk{width:18px;height:18px}
    .muted{opacity:.75}
    .danger{color:#fecaca}
    .ok{color:#bbf7d0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (max-width:900px){
      .top{flex-direction:column;align-items:flex-start;gap:10px}
      th,td{font-size:12px}
    }
  </style>
</head>
<body>
<div class="wrap">
<div class="card">
<div class="top">
<div class="row">
<div class="pill">HELPER • Permisiuni pe pagini (ACL)</div>
<div class="pill muted" id="status">Cloud: …</div>
<div class="pill muted" id="me">Utilizator: …</div>
</div>
<div class="row">
<button class="btn" onclick="location.href='index.html'">← Dashboard</button>
<button class="btn" onclick="reloadAcl()">Reîncarcă</button>
<button class="btn" onclick="saveAcl()">Salvează</button>
</div>
</div>
<div class="row" style="margin-top:8px">
<label class="muted">Rol:</label>
<select id="roleSel">
<option value="admin">admin</option>
<option value="editor">editor</option>
<option value="viewer">viewer</option>
</select>
<label class="muted">Filtru pagină:</label>
<input id="pageFilter" placeholder="ex: numeralkod / intrari_otel / debit..."/>
<span class="muted">Bifezi ce are voie rolul ales pe fiecare pagină.</span>
</div>
<div class="grid">
<table id="aclTable">
<thead>
<tr>
<th style="width:220px">Pagină (page_key)</th>
<th>can_view</th>
<th>can_edit_data</th>
<th>import btn</th>
<th>add btn</th>
<th>delete btn</th>
<th>reset btn</th>
<th>export</th>
<th>filter</th>
<th>sync</th>
</tr>
</thead>
<tbody id="aclBody"></tbody>
</table>
<div class="muted" id="hint" style="margin-top:6px">
        Notă: acest ecran e admin-only. Dacă vezi “403/Unauthorized”, înseamnă că rolul nu este admin sau lipsește policy pe profiles/rf_acl.
      </div>
</div>
</div><div class="card">
<div class="h1">Dashboard • Butoane vizibile</div>
<div class="muted">Bifezi ce butoane/meniuri din Dashboard sunt vizibile pentru fiecare rol. Se salvează în <span class="mono">rf_documents</span> cu <span class="mono">doc_key = dashboard_acl_v1</span>.</div>
<div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
<button class="btn" id="btnDashReload">Reload</button>
<button class="btn primary" id="btnDashSave">Salvează</button>
<button class="btn danger" id="btnDashReset">Reset (toate vizibile)</button>
<span class="muted" id="dashStatus"></span>
</div>
<table class="tbl" style="margin-top:10px">
<thead>
<tr>
<th>Buton (href)</th>
<th>Admin</th>
<th>Editor</th>
<th>Viewer</th>
</tr>
</thead>
<tbody id="dashAclBody"></tbody>
</table>
<div class="muted" style="margin-top:6px">
  Notă: pentru <b>admin</b> recomand să lași totul bifat. <b>HELPER</b>, <b>HELPER (Date)</b> și <b>ACL</b> rămân oricum doar admin.
</div>
</div>
</div>
<script>
  // ===== CONFIG: completează cu valorile tale (aceleași ca în celelalte pagini) =====
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // <-- Anon Key (Legacy)
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PAGES = [
    "numeralkod",
    "intrari_otel",
    "debitate",
    "forjate",
    "magnaflux",
    "helper",
    "inventar_otel",
    "inventar_debitat",
    "inventar_forjat",
    "kpi",
    "rebut",
    "probleme_raportate",
    "urmarire_zale",
    "amb_9k_6628_6629","amb_229_6909_6910","amb_503_0761_0762",
    "amb_106_1625_1626","amb_378_8241_8242","amb_248_2307_2308",
    "amb_417_3595_3596","amb_418_2091_2092"
  ];

  const FIELDS = [
    "can_view","can_edit_data","show_import_buttons","show_add_buttons","show_delete_buttons",
    "show_reset_buttons","can_export","can_filter","can_sync_cloud"
  ];

  let ME = { role:"viewer", email:"", id:null };
  let ACL_ROWS = []; // loaded for role

  function setStatus(txt, ok=false){
    const el = document.getElementById("status");
    el.textContent = txt;
    el.classList.toggle("ok", !!ok);
    el.classList.toggle("danger", !ok && (txt||"").toLowerCase().includes("eroare"));
  }

  async function getMe(){
    const { data: s } = await supa.auth.getSession();
    const sess = s?.session;
    if(!sess) return null;
    const { data, error } = await supa.from("profiles").select("role").eq("id", sess.user.id).maybeSingle();
    if(error) throw error;
    return { id: sess.user.id, email: sess.user.email || "", role: (data?.role || "viewer") };
  }

  function rowKey(page_key){ return page_key + "|" + document.getElementById("roleSel").value; }

  function render(){
    const role = document.getElementById("roleSel").value;
    const filter = (document.getElementById("pageFilter").value || "").trim().toLowerCase();

    const body = document.getElementById("aclBody");
    body.innerHTML = "";

    const pages = PAGES.filter(p => !filter || p.toLowerCase().includes(filter));

    for(const page_key of pages){
      const current = ACL_ROWS.find(r => r.page_key === page_key && r.role === role) || {
        page_key, role,
        can_view:true, can_edit_data:false,
        show_import_buttons:false, show_add_buttons:false, show_delete_buttons:false, show_reset_buttons:false,
        can_export:true, can_filter:true, can_sync_cloud:false
      };

      const tr = document.createElement("tr");
      tr.dataset.page = page_key;

      const td0 = document.createElement("td");
      td0.innerHTML = "<b>"+page_key+"</b>";
      tr.appendChild(td0);

      const mk = (field) => {
        const td = document.createElement("td");
        const c = document.createElement("input");
        c.type = "checkbox";
        c.className = "chk";
        c.checked = !!current[field];
        c.onchange = () => {
          current[field] = c.checked;
          // keep in ACL_ROWS (upsert in memory)
          const idx = ACL_ROWS.findIndex(r => r.page_key===page_key && r.role===role);
          if(idx === -1) ACL_ROWS.push(current);
          else ACL_ROWS[idx] = current;
        };
        td.appendChild(c);
        return td;
      };

      tr.appendChild(mk("can_view"));
      tr.appendChild(mk("can_edit_data"));
      tr.appendChild(mk("show_import_buttons"));
      tr.appendChild(mk("show_add_buttons"));
      tr.appendChild(mk("show_delete_buttons"));
      tr.appendChild(mk("show_reset_buttons"));
      tr.appendChild(mk("can_export"));
      tr.appendChild(mk("can_filter"));
      tr.appendChild(mk("can_sync_cloud"));

      body.appendChild(tr);
    }
  }

  async function reloadAcl(){
    setStatus("Cloud: încarc…", true);
    const role = document.getElementById("roleSel").value;

    // load all rows for this role
    const { data, error } = await supa.from("rf_acl").select("*").eq("role", role);
    if(error) throw error;
    ACL_ROWS = data || [];
    setStatus("Cloud: OK", true);
    render();
  }

  async function saveAcl(){
    setStatus("Cloud: salvez…", true);
    const role = document.getElementById("roleSel").value;
    const toSave = ACL_ROWS.filter(r => r.role === role).map(r => ({...r, updated_at: new Date().toISOString(), updated_by: ME.id}));

    if(!toSave.length){
      setStatus("Cloud: nimic de salvat", true);
      return;
    }

    const { error } = await supa.from("rf_acl").upsert(toSave, { onConflict: "page_key,role" });
    if(error) throw error;

    setStatus("Cloud: salvat", true);
    await reloadAcl();
      await reloadDashAcl();
      document.getElementById('btnDashReload')?.addEventListener('click', reloadDashAcl);
      document.getElementById('btnDashSave')?.addEventListener('click', saveDashAcl);
      document.getElementById('btnDashReset')?.addEventListener('click', resetDashAcl);

  }

  

  /* ===============================
     DASHBOARD ACL (button visibility)
     saved in rf_documents.doc_key = 'dashboard_acl_v1'
     =============================== */
  const DASH_ITEMS = [{"href": "probleme-raportate.html", "label": "PROBLEME RAPORTATE"}, {"href": "rebut.html", "label": "REBUT"}, {"href": "kpi.html", "label": "KPI"}, {"href": "helper.html", "label": "HELPER"}, {"href": "helper-data.html", "label": "HELPER (Date)"}, {"href": "helper-acl.html", "label": "PERMISIUNI (ACL)"}, {"href": "numeralkod.html", "label": "NUMERALKOD"}, {"href": "intrari-otel.html", "label": "INTRĂRI OȚEL"}, {"href": "debitate.html", "label": "DEBITATE"}, {"href": "forjate.html", "label": "FORJATE"}, {"href": "magnaflux.html", "label": "MAGNAFLUX"}, {"href": "zale-9k-6628-29.html", "label": "9K‑6628/29"}, {"href": "zale-229-6909-10.html", "label": "229‑6909/10"}, {"href": "zale-503-0761-62.html", "label": "503‑0761/62"}, {"href": "zale-106-1625-26.html", "label": "106‑1625/26"}, {"href": "zale-378-8241-42.html", "label": "378‑8241/42"}, {"href": "zale-248-2307-08.html", "label": "248‑2307/08"}, {"href": "zale-417-3595-96.html", "label": "417‑3595/96"}, {"href": "zale-418-2091-92.html", "label": "418‑2091/92"}, {"href": "ambalare-9k-6628-29.html", "label": "AMBALARE 9K‑6628/29"}, {"href": "ambalare-229-6909-10.html", "label": "AMBALARE 229‑6909/10"}, {"href": "ambalare-503-0761-62.html", "label": "AMBALARE 503‑0761/62"}, {"href": "ambalare-106-1625-26.html", "label": "AMBALARE 106‑1625/26"}, {"href": "ambalare-378-8241-42.html", "label": "AMBALARE 378‑8241/42"}, {"href": "ambalare-248-2307-08.html", "label": "AMBALARE 248‑2307/08"}, {"href": "ambalare-417-3595-96.html", "label": "AMBALARE 417‑3595/96"}, {"href": "ambalare-418-2091-92.html", "label": "AMBALARE 418‑2091/92"}, {"href": "inventar-otel.html", "label": "INVENTAR OȚEL"}, {"href": "inventar-debitat.html", "label": "INVENTAR DEBITAT"}, {"href": "inventar-forjat.html", "label": "INVENTAR FORJAT"}];

  const DASH_DOC_TABLE = "rf_documents";
  const DASH_DOC_KEY = "dashboard_acl_v1";
  let DASH_ACL = null;

  function setDashStatus(msg, ok){
    const el = document.getElementById("dashStatus");
    if(!el) return;
    el.textContent = msg || "";
    el.style.color = ok ? "#1f7a4c" : "#a1252b";
  }

  function defaultDashAcl(){
    const grants = { admin: {}, editor: {}, viewer: {} };
    DASH_ITEMS.forEach(it => {
      grants.admin[it.href] = true;
      grants.editor[it.href] = true;
      grants.viewer[it.href] = true;
    });
    // hard admin-only
    ["helper.html","helper-acl.html","helper-data.html"].forEach(h => {
      grants.editor[h] = false;
      grants.viewer[h] = false;
      grants.admin[h] = true;
    });
    return {
      version: 1,
      updated_at: new Date().toISOString(),
      items: DASH_ITEMS,
      grants
    };
  }

  function renderDashAcl(){
    const body = document.getElementById("dashAclBody");
    if(!body) return;
    body.innerHTML = "";
    const cfg = DASH_ACL || defaultDashAcl();

    function mkCb(role, href){
      const td = document.createElement("td");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = cfg.grants?.[role]?.[href] !== false; // default true
      cb.addEventListener("change", ()=>{
        cfg.grants = cfg.grants || {admin:{},editor:{},viewer:{}};
        cfg.grants[role] = cfg.grants[role] || {};
        cfg.grants[role][href] = cb.checked;

        // enforce admin-only items
        if(href === "helper.html" || href === "helper-acl.html" || href === "helper-data.html"){
          cfg.grants.editor[href] = false;
          cfg.grants.viewer[href] = false;
          cfg.grants.admin[href] = true;
          cb.checked = (role === "admin");
        }
        DASH_ACL = cfg;
      });
      td.appendChild(cb);
      return td;
    }

    cfg.items = (cfg.items && cfg.items.length) ? cfg.items : DASH_ITEMS;

    for(const it of cfg.items){
      const tr = document.createElement("tr");
      const td0 = document.createElement("td");
      td0.innerHTML = `<b>${it.label || it.href}</b><div class="muted mono">${it.href}</div>`;
      tr.appendChild(td0);
      tr.appendChild(mkCb("admin", it.href));
      tr.appendChild(mkCb("editor", it.href));
      tr.appendChild(mkCb("viewer", it.href));
      body.appendChild(tr);
    }
  }

  async function reloadDashAcl(){
    setDashStatus("Încarc…", true);
    const { data, error } = await supa.from(DASH_DOC_TABLE).select("data,updated_at").eq("doc_key", DASH_DOC_KEY).maybeSingle();
    if(error) throw error;
    DASH_ACL = data?.data || null;
    if(!DASH_ACL) DASH_ACL = defaultDashAcl();
    setDashStatus("OK", true);
    renderDashAcl();
  }

  async function saveDashAcl(){
    setDashStatus("Salvez…", true);
    const payload = DASH_ACL || defaultDashAcl();
    payload.updated_at = new Date().toISOString();
    payload.items = DASH_ITEMS;
    // enforce admin-only
    ["helper.html","helper-acl.html","helper-data.html"].forEach(h => {
      payload.grants.admin[h] = true;
      payload.grants.editor[h] = false;
      payload.grants.viewer[h] = false;
    });

    const up = { doc_key: DASH_DOC_KEY, data: payload, updated_at: payload.updated_at };
    const { error } = await supa.from(DASH_DOC_TABLE).upsert(up, { onConflict:"doc_key" });
    if(error) throw error;
    setDashStatus("Salvat", true);
    await reloadDashAcl();
  }

  async function resetDashAcl(){
    DASH_ACL = defaultDashAcl();
    renderDashAcl();
    setDashStatus("Reset local (apasă Salvează)", true);
  }

async function boot(){
    try{
      setStatus("Cloud: conectare…", true);
      ME = await getMe();
      if(!ME){
        setStatus("Neautentificat", false);
        document.getElementById("me").textContent = "Neautentificat";
        return;
      }
      document.getElementById("me").textContent = `Utilizator: ${ME.email} • ${ME.role}`;

      if(ME.role !== "admin"){
        setStatus("Eroare: doar admin", false);
        document.getElementById("hint").innerHTML = "<span class='danger'><b>Doar admin</b> poate edita ACL.</span>";
        // still allow view if you want; but we stop here
        return;
      }

      document.getElementById("roleSel").addEventListener("change", reloadAcl);
      document.getElementById("pageFilter").addEventListener("input", render);

      await reloadAcl();
      await reloadDashAcl();
      document.getElementById('btnDashReload')?.addEventListener('click', reloadDashAcl);
      document.getElementById('btnDashSave')?.addEventListener('click', saveDashAcl);
      document.getElementById('btnDashReset')?.addEventListener('click', resetDashAcl);

    }catch(e){
      console.error(e);
      setStatus("Eroare: " + (e?.message || e), false);
    }
  }

  boot();
</script>
</body>
</html>