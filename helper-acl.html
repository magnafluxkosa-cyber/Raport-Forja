<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HELPER • Permisiuni (ACL)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{margin:0;font-family:Calibri,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.10);border-radius:18px;padding:18px 18px 14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.06);font-weight:700;font-size:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.16);background:rgba(255,255,255,0.08);color:#fff;font-weight:800;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.12)}
    select,input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(0,0,0,0.25);color:#fff;outline:none}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:14px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,0.10);font-size:13px}
    th{position:sticky;top:0;background:rgba(255,255,255,0.07);text-align:left}
    tr:hover td{background:rgba(255,255,255,0.04)}
    .chk{width:18px;height:18px}
    .muted{opacity:.75}
    .danger{color:#fecaca}
    .ok{color:#bbf7d0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (max-width:900px){
      .top{flex-direction:column;align-items:flex-start;gap:10px}
      th,td{font-size:12px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div class="row">
        <div class="pill">HELPER • Permisiuni pe pagini (ACL)</div>
        <div id="status" class="pill muted">Cloud: …</div>
        <div id="me" class="pill muted">Utilizator: …</div>
      </div>
      <div class="row">
        <button class="btn" onclick="location.href='index.html'">← Dashboard</button>
        <button class="btn" onclick="reloadAcl()">Reîncarcă</button>
        <button class="btn" onclick="saveAcl()">Salvează</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <label class="muted">Rol:</label>
      <select id="roleSel">
        <option value="admin">admin</option>
        <option value="editor">editor</option>
        <option value="viewer">viewer</option>
      </select>

      <label class="muted">Filtru pagină:</label>
      <input id="pageFilter" placeholder="ex: numeralkod / intrari_otel / debit..." />
      <span class="muted">Bifezi ce are voie rolul ales pe fiecare pagină.</span>
    </div>

    <div class="grid">
      <table id="aclTable">
        <thead>
          <tr>
            <th style="width:220px">Pagină (page_key)</th>
            <th>can_view</th>
            <th>can_edit_data</th>
            <th>import btn</th>
            <th>add btn</th>
            <th>delete btn</th>
            <th>reset btn</th>
            <th>export</th>
            <th>filter</th>
            <th>sync</th>
          </tr>
        </thead>
        <tbody id="aclBody"></tbody>
      </table>
      <div class="muted" id="hint" style="margin-top:6px">
        Notă: acest ecran e admin-only. Dacă vezi “403/Unauthorized”, înseamnă că rolul nu este admin sau lipsește policy pe profiles/rf_acl.
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG: completează cu valorile tale (aceleași ca în celelalte pagini) =====
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // <-- Anon Key (Legacy)
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const PAGES = [
    "numeralkod",
    "intrari_otel",
    "debitate",
    "forjate",
    "magnaflux",
    "helper",
    "inventar_otel",
    "inventar_debitat",
    "inventar_forjat",
    "kpi",
    "rebut",
    "probleme_raportate",
    "urmarire_zale",
    "amb_9k_6628_6629","amb_229_6909_6910","amb_503_0761_0762",
    "amb_106_1625_1626","amb_378_8241_8242","amb_248_2307_2308",
    "amb_417_3595_3596","amb_418_2091_2092"
  ];

  const FIELDS = [
    "can_view","can_edit_data","show_import_buttons","show_add_buttons","show_delete_buttons",
    "show_reset_buttons","can_export","can_filter","can_sync_cloud"
  ];

  let ME = { role:"viewer", email:"", id:null };
  let ACL_ROWS = []; // loaded for role

  function setStatus(txt, ok=false){
    const el = document.getElementById("status");
    el.textContent = txt;
    el.classList.toggle("ok", !!ok);
    el.classList.toggle("danger", !ok && (txt||"").toLowerCase().includes("eroare"));
  }

  async function getMe(){
    const { data: s } = await supa.auth.getSession();
    const sess = s?.session;
    if(!sess) return null;
    const { data, error } = await supa.from("profiles").select("role").eq("id", sess.user.id).maybeSingle();
    if(error) throw error;
    return { id: sess.user.id, email: sess.user.email || "", role: (data?.role || "viewer") };
  }

  function rowKey(page_key){ return page_key + "|" + document.getElementById("roleSel").value; }

  function render(){
    const role = document.getElementById("roleSel").value;
    const filter = (document.getElementById("pageFilter").value || "").trim().toLowerCase();

    const body = document.getElementById("aclBody");
    body.innerHTML = "";

    const pages = PAGES.filter(p => !filter || p.toLowerCase().includes(filter));

    for(const page_key of pages){
      const current = ACL_ROWS.find(r => r.page_key === page_key && r.role === role) || {
        page_key, role,
        can_view:true, can_edit_data:false,
        show_import_buttons:false, show_add_buttons:false, show_delete_buttons:false, show_reset_buttons:false,
        can_export:true, can_filter:true, can_sync_cloud:false
      };

      const tr = document.createElement("tr");
      tr.dataset.page = page_key;

      const td0 = document.createElement("td");
      td0.innerHTML = "<b>"+page_key+"</b>";
      tr.appendChild(td0);

      const mk = (field) => {
        const td = document.createElement("td");
        const c = document.createElement("input");
        c.type = "checkbox";
        c.className = "chk";
        c.checked = !!current[field];
        c.onchange = () => {
          current[field] = c.checked;
          // keep in ACL_ROWS (upsert in memory)
          const idx = ACL_ROWS.findIndex(r => r.page_key===page_key && r.role===role);
          if(idx === -1) ACL_ROWS.push(current);
          else ACL_ROWS[idx] = current;
        };
        td.appendChild(c);
        return td;
      };

      tr.appendChild(mk("can_view"));
      tr.appendChild(mk("can_edit_data"));
      tr.appendChild(mk("show_import_buttons"));
      tr.appendChild(mk("show_add_buttons"));
      tr.appendChild(mk("show_delete_buttons"));
      tr.appendChild(mk("show_reset_buttons"));
      tr.appendChild(mk("can_export"));
      tr.appendChild(mk("can_filter"));
      tr.appendChild(mk("can_sync_cloud"));

      body.appendChild(tr);
    }
  }

  async function reloadAcl(){
    setStatus("Cloud: încarc…", true);
    const role = document.getElementById("roleSel").value;

    // load all rows for this role
    const { data, error } = await supa.from("rf_acl").select("*").eq("role", role);
    if(error) throw error;
    ACL_ROWS = data || [];
    setStatus("Cloud: OK", true);
    render();
  }

  async function saveAcl(){
    setStatus("Cloud: salvez…", true);
    const role = document.getElementById("roleSel").value;
    const toSave = ACL_ROWS.filter(r => r.role === role).map(r => ({...r, updated_at: new Date().toISOString(), updated_by: ME.id}));

    if(!toSave.length){
      setStatus("Cloud: nimic de salvat", true);
      return;
    }

    const { error } = await supa.from("rf_acl").upsert(toSave, { onConflict: "page_key,role" });
    if(error) throw error;

    setStatus("Cloud: salvat", true);
    await reloadAcl();
  }

  async function boot(){
    try{
      setStatus("Cloud: conectare…", true);
      ME = await getMe();
      if(!ME){
        setStatus("Neautentificat", false);
        document.getElementById("me").textContent = "Neautentificat";
        return;
      }
      document.getElementById("me").textContent = `Utilizator: ${ME.email} • ${ME.role}`;

      if(ME.role !== "admin"){
        setStatus("Eroare: doar admin", false);
        document.getElementById("hint").innerHTML = "<span class='danger'><b>Doar admin</b> poate edita ACL.</span>";
        // still allow view if you want; but we stop here
        return;
      }

      document.getElementById("roleSel").addEventListener("change", reloadAcl);
      document.getElementById("pageFilter").addEventListener("input", render);

      await reloadAcl();
    }catch(e){
      console.error(e);
      setStatus("Eroare: " + (e?.message || e), false);
    }
  }

  boot();
</script>
</body>
</html>