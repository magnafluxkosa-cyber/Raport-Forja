<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEBITATE</title>
  <style>
    .topnav{display:none!important;} .stage{padding-top:0!important;} iframe{height:100vh!important;}

    :root{
      --bg:#b7d7f0;
      --hdr:#cfe3f6;
      --grid:#000;
      --white:#fff;
      --btn:#2b6cb0;
      --btn2:#1e5a96;
      --focus:#2563eb;
      --shadow: rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color:#0b1220;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
    }
    .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:8px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 2px 6px var(--shadow);
    }
    .btn.primary{
      background: var(--btn);
      color:#fff;
      border-color: rgba(0,0,0,.15);
    }
    .btn.primary:hover{ background: var(--btn2); }
    .status{
      font-size:12px;
      color:#0b1220;
      opacity:.75;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      background: rgba(255,255,255,.75);
      font-size:12px;
      font-weight:700;
    }
    .wrap{
      padding: 0 12px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .tablewrap{
      background: rgba(255,255,255,.35);
      border-radius:10px;
      overflow:auto;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      border:1px solid rgba(0,0,0,.2);
      box-shadow: 0 2px 10px var(--shadow);

      /* Flex layout */
      flex: 1 1 auto;
      min-width: 0;
      width: 100%;
      display: block;
      max-width: none;
    }

    .sidePanel{
      flex: 0 0 420px;
      width: 420px;
      max-width: 420px;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      overflow:auto;
      padding-right:2px;
    }
    .card{
      background: rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 10px;
      margin-bottom: 12px;
    }
    .cardTitle{
      font-weight: 900;
      font-size: 13px;
      margin: 2px 0 10px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .field label{ display:block; font-size:12px; font-weight:800; margin: 0 0 4px; }
    .field select, .field input{
      width:100%;
      border:1px solid rgba(0,0,0,.25);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      font-weight:800;
      font-size:12px;
      outline:none;
    }
    .btnRow{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .btn.small{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btn.ghost{ background: rgba(255,255,255,.4); }
    .note{ margin-top:8px; font-size:12px; opacity:.82; }
    .sumWrap{ margin-top:10px; background: rgba(255,255,255,.55); border-radius:10px; border:1px solid rgba(0,0,0,.12); overflow-y:auto; overflow-x:hidden; max-height: 300px; }
    .sumTable{ border-collapse: collapse; width:100%; table-layout:fixed; background:#fff; }
    .sumTable th, .sumTable td{ border:1px solid rgba(0,0,0,.35); padding:4px 6px; font-size:12px; line-height:1.15; white-space:nowrap; overflow-wrap:normal; word-break:normal; vertical-align:middle; }
    .sumTable th{ background: var(--hdr); position: sticky; top:0; z-index: 1; }
    .sumTable th:nth-child(4), .sumTable th:nth-child(5),
    .sumTable td:nth-child(4), .sumTable td:nth-child(5){
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .sumTable th:nth-child(2), .sumTable td:nth-child(2){ text-align:center; }
    .sumTable th:nth-child(1), .sumTable td:nth-child(1){ width: 28%; }
    .sumTable th:nth-child(2), .sumTable td:nth-child(2){ width: 14%; }
    .sumTable th:nth-child(3), .sumTable td:nth-child(3){ width: 30%; }
    .sumTable th:nth-child(4), .sumTable td:nth-child(4){ width: 14%; }
    .sumTable th:nth-child(5), .sumTable td:nth-child(5){ width: 14%; }

    .sumTable th:nth-child(1), .sumTable td:nth-child(1),
    .sumTable th:nth-child(3), .sumTable td:nth-child(3){
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    table{
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
      background: var(--white);
    }
    th, td{
      border: 1px solid var(--grid);
      padding: 1px 3px;
      font-size: 10px;
      line-height: 1.0;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: middle;
    }
    thead th{
      background: var(--hdr);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space: pre-line;
      text-align:center;
    }
    th:last-child{ padding:0 !important; }
    td:last-child{ padding:0 !important; }
    
    thead tr.filters th{ display:none;
      top: 26px;
      z-index: 1;
      background: #e8f3ff;
      padding: 2px 4px;
    }
    .finput, .fselect{
      width: 100%;
      border: 1px solid rgba(0,0,0,.35);
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 10px;
      background:#fff;
      height: 22px;
    }
    .cellinput{
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      font-size: 10px;
      padding: 0;
      height: 18px;
    }
    .cellinput:focus{
      outline: 2px solid rgba(37,99,235,.35);
      border-radius: 4px;
      background: rgba(37,99,235,.06);
    }
    .num{text-align:right; font-variant-numeric: tabular-nums;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .center{text-align:center;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .rowActions{
      display:flex;
      gap:0;
      justify-content:center;
    }
    .actCell{ padding:0 !important; }
    .actCell .rowActions{ padding:0; }
    .iconbtn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:6px;
      width:18px;
      height:18px;
      padding:0;
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .iconbtn.danger{ background:#fff1f2; }
    .hint{
      font-size:12px;
      opacity:.8;
    }
    
    .modalback{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(1100px, 100%);
      background: #fff;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
      overflow: hidden;
    }
    .modal header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      background: var(--hdr);
      border-bottom: 1px solid rgba(0,0,0,.2);
      font-weight: 900;
    }
    .modal .content{
      padding: 12px;
      background: #fff;
    }
    .modal .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .modal label{
      display:grid;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
    }
    .modal input, .modal select{
      border:1px solid rgba(0,0,0,.35);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background:#fff;
      width:100%;
    }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 12px;
    }
    .modal .err{
      color: #b00020;
      font-size: 12px;
      font-weight: 800;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .modal .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .modal .grid{ grid-template-columns: 1fr; }
    }

    .hidden{ display:none !important; }
  
    .chk{ grid-column: 1 / -1; display:flex; align-items:center; gap:10px; font-size:12px; padding:6px 8px; background: rgba(255,255,255,.55); border: 1px dashed rgba(0,0,0,.25); border-radius:10px;}
    .chk input{ width:16px; height:16px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .roleBadge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.2);background:rgba(255,255,255,.75);font-size:12px;font-weight:700}
    .roleBadge.err{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  </style>

<script>
function goDashboard(){ window.location.href='index.html'; }
</script>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <button class="btn" onclick="goDashboard()">‚¨Ö Dashboard</button>
      <button class="btn primary" onclick="openAddModal()" data-acl="add">‚ûï AdaugƒÉ</button>
      <div class="status">
        <span class="pill" id="pillRows">0 r√¢nduri</span>
        <span class="pill" id="pillTotalKg">0 kg total</span>
        <span class="pill" id="pillSave">autosave: idle</span>

        <button class="btn" id="btnPrevPage" title="Pagina anterioarƒÉ">‚óÄ</button>
        <span class="pill" id="pillPage">pagina 1/1</span>
        <button class="btn" id="btnNextPage" title="Pagina urmƒÉtoare">‚ñ∂</button>

        <span class="roleBadge" id="roleBadge">rol: ...</span>
      </div>
    </div>
    <div class="right">
      <button class="btn" onclick="exportXLSX()" data-acl="export">‚§ì Export Excel</button>
      <button class="btn" onclick="importXLSX()" data-acl="import">‚§í Import Excel</button>
      <button class="btn" onclick="exportJSON()" data-acl="export">‚§ì Export JSON</button>
      <button class="btn" onclick="resetAll()" data-acl="reset" title="»òterge toate datele salvate local">Reset</button>
      <button class="btn" id="btnDebCloudSync" onclick="debitateCloud.syncNow()" data-acl="sync" title="Sync Cloud">üîÅ Sync Cloud</button>
      <span class="pill" id="pillCloud">cloud: local</span>
    </div>
  </div>

  <div class="wrap">
    <div class="tablewrap" id="tablewrap">
      <table id="tbl">
        <colgroup id="colgroup"></colgroup>
        <thead>
          <tr id="hdr"></tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
    <div class="sidePanel" aria-label="Filtre »ôi sumar">
      <div class="card">
        <div class="cardTitle">Filtre (tabel)</div>
        <div class="grid2">
          <div class="field">
            <label for="fltYear">An</label>
            <select id="fltYear"></select>
          </div>
          <div class="field">
            <label for="fltMonth">LunƒÉ</label>
            <select id="fltMonth"></select>
          </div>
        </div>
        <div class="btnRow">
          <button class="btn small" onclick="applyUIFilters()" data-acl="filter">FiltreazƒÉ</button>
          <button class="btn small ghost" onclick="resetUIFilters()" data-acl="filter">Reset filtre</button>
        </div>
        <div class="note">FiltreazƒÉ r√¢ndurile din tabel dupƒÉ An »ôi LunƒÉ.</div>
      </div>

      <div class="card">
        <div class="cardTitle">SumƒÉ debitate pe Reper + Diametru + Calitate</div>
        <div class="grid2">
          <div class="field">
            <label for="sumYear">An</label>
            <select id="sumYear"></select>
          </div>
          <div class="field">
            <label for="sumMonth">LunƒÉ</label>
            <select id="sumMonth"></select>
          </div>
        </div>
        <div class="note">Sumarul folose»ôte doar An/LunƒÉ de aici (independent de filtrele tabelului).</div>
        <div class="sumWrap">
          <table class="sumTable">
            <thead>
              <tr>
                <th>Reper</th>
                <th>Diametru</th>
                <th>Calitate</th>
                <th class="num">Total buc</th>
                <th class="num">Total kg</th>
              </tr>
            </thead>
            <tbody id="sumBody">
              <tr><td colspan="5" class="center">SelecteazƒÉ Anul aici pentru a calcula sumarul.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal AdaugƒÉ r√¢nd -->
    <div class="modalback hidden" id="modalBack" onclick="if(event.target.id==='modalBack') closeAddModal()">
      <div class="modal" role="dialog" aria-modal="true" aria-label="AdaugƒÉ debitare">
        <header>
          <div>AdaugƒÉ debitare</div>
          <button class="btn" type="button" onclick="closeAddModal()">‚úï</button>
        </header>
        <div class="content">
          <div class="grid">
            <label>Data
              <input id="mData" type="date" onchange="syncAnLunaFromDate()" data-edit>
            </label>
            <label>An (auto)
              <input id="mAn" type="text" readonly data-edit>
            </label>
            <label>LunƒÉ (auto)
              <input id="mLuna" type="text" readonly data-edit>
            </label>
            <label>Echipament
              <input id="mEchip" type="text" list="dlUtilajeDebitare" placeholder="ex: 1 SCPK 500 / EVERSING" data-edit>
            </label>

            <label>Reper
              <input id="mReper" type="text" list="dlRepereDebitare" placeholder="ex: 248-2307/08" data-edit>
            </label>

            <label class="chk">
              <input id="mOverride" type="checkbox" data-edit>
              Override manual (Diametru / Calitate / Kg/buc / Lungime)
            </label>
            <label>Diametru o»õel
              <input id="mDiam" type="text" placeholder="ex: √ò71 / 71" readonly data-edit>
            </label>
            <label>CALITATE
              <input id="mCal" type="text" placeholder="ex: 1E-1287/15B34" readonly data-edit>
            </label>
            <label>Kg/buc.
              <input id="mKgBuc" type="text" placeholder="ex: 8,5" readonly data-edit>
            </label>

            <label>Lungime debitat (mm)
              <input id="mLungime" type="text" placeholder="ex: 264" readonly data-edit>
            </label>
            <label>Sarja
              <input id="mSarja" type="text" placeholder="ex: DAR / DRM" data-edit>
            </label>
            <label>Planificat
              <input id="mPlan" type="text" placeholder="ex: 1.056" data-edit>
            </label>
            <label>Cantitate
              <input id="mCant" type="text" placeholder="ex: 1.056" data-edit>
            </label>

            <label>Schimbul
              <input id="mSchimb" type="text" placeholder="1" data-edit>
            </label>
            <label>Operator
              <input id="mOper" type="text" placeholder="ex: Nagy Robert" data-edit>
            </label>
            <label>Ore lucrate
              <input id="mOre" type="text" placeholder="8,0" data-edit>
            </label>
            <div></div>
          </div>

          <div class="err" id="mErr"></div>

          <div class="actions">
            <button class="btn" type="button" onclick="closeAddModal()">AnuleazƒÉ</button>
            <button class="btn primary" type="button" onclick="saveAddModal()" data-edit-btn>SalveazƒÉ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const STORAGE_KEY = "DEBITATE_autosave_v1";
  const LUNI = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];

  function storageAvailable(){
    try{
      const x = "__st__" + Math.random();
      localStorage.setItem(x, x);
      localStorage.removeItem(x);
      return true;
    } catch(e){
      return false;
    }
  }
  const CAN_STORE = storageAvailable();


  const COLUMNS = [
    { key:"an", label:"Anul", type:"year", align:"center" },
    { key:"luna", label:"Luna", type:"text" },
    { key:"data", label:"Data", type:"date" },
    { key:"echipament", label:"Echipament", type:"text" },
    { key:"reper", label:"Reper", type:"text" },
    { key:"diametru", label:"Diametru o»õel", type:"diam" },
    { key:"calitate", label:"CALITATE", type:"text" },
    { key:"kgBuc", label:"Kg/buc.", type:"dec2", align:"num" },
    { key:"lungime", label:"Lungime debitat mm", type:"int", align:"num" },
    { key:"sarja", label:"Sarja", type:"text" },
    { key:"planificat", label:"Plani\nficat", type:"int", align:"num" },
    { key:"cantitate", label:"Canti\ntate", type:"int", align:"num" },
    { key:"schimbul", label:"Schim\nbul", type:"int", align:"center" },
    { key:"totalKg", label:"total kg\ndebitat", type:"int", align:"num", readonly:true },
    { key:"weekNr", label:"week\nnr.", type:"int", align:"center", readonly:true },
    { key:"operator", label:"Operator", type:"text" },
    { key:"procentNorma", label:"Procent norma %", type:"pct", align:"center", readonly:true },
    { key:"oreLucrate", label:"Ore lucrate", type:"dec1", align:"center" }
  ];

  const COL_WIDTHS = {
    an: 58, luna: 78, data: 88, echipament: 86, reper: 86,
    diametru: 78, calitate: 104, kgBuc: 62, lungime: 86,
    sarja: 72, planificat: 70, cantitate: 70, schimbul: 54,
    totalKg: 84, weekNr: 54, operator: 96, procentNorma: 98, oreLucrate: 78
  };
  const ACTION_COL_W = 28;

  // ===== STATE =====
  let rows = [];
  let filters = null;
  let saveTimer = null;

  // ===== PAGING =====
  const PAGE_SIZE = 200;
  let currentPage = 0;

  const $ = (id) => document.getElementById(id);
  const pillRows = $("pillRows");
  const pillTotalKg = $("pillTotalKg");
  const pillSave = $("pillSave");
  const pillPage = $("pillPage");
  const btnPrevPage = $("btnPrevPage");
  const btnNextPage = $("btnNextPage");

  // ===== HELPERE =====
  const HELPERS_KEY = "RF_HELPERS_v1";
  let _helpers = null;
  let _mapRepDebitare = null;

  function loadHelpers(){
    if (_helpers) return _helpers;
    try {
      const raw = localStorage.getItem(HELPERS_KEY);
      if (!raw) return null;
      _helpers = JSON.parse(raw);
      return _helpers;
    } catch(e) {
      console.warn("Helpere corupte / lipsƒÉ:", e);
      return null;
    }
  }

  (function watchHelpers(){
    let last = "";
    try{ last = localStorage.getItem(HELPERS_KEY) || ""; }catch(_e){}
    function tick(){
      try{
        const cur = localStorage.getItem(HELPERS_KEY) || "";
        if(cur !== last){
          last = cur;
          _helpers = null; _mapRepDebitare = null;
          try{ buildHelperMaps(); }catch(e){}
          try{ refreshHelperDatalists(); }catch(e){}
        }
      }catch(_e){}
    }
    setInterval(tick, 1200);
    try{
      const bc = new BroadcastChannel("rf_sync");
      bc.onmessage = (ev)=>{ if(ev && ev.data && ev.data.type==="HELPERS_UPDATED"){ tick(); } };
    }catch(_e){}
  })();

  function buildHelperMaps(){
    const h = loadHelpers();
    _mapRepDebitare = new Map();
    const dlR = $("dlRepereDebitare");
    const dlU = $("dlUtilajeDebitare");
    if (dlR) dlR.innerHTML = "";
    if (dlU) dlU.innerHTML = "";

    if (!h) return;

    (h.repere_debitare || []).forEach(row => {
      const k = (row.REPER_DEBITARE ?? "").toString().trim();
      if (!k) return;
      _mapRepDebitare.set(k, {
        reper: k,
        diam: row.DIAMETRU_OTEL,
        cal: (row.CALITATE_OTEL ?? "").toString().trim(),
        kgBuc: row.KG_BUC_DEBITAT,
        lung: row.LUNGIME_DEBITARE_MM
      });
    });

    if (dlR){
      Array.from(_mapRepDebitare.keys()).sort().forEach(k => {
        const o = document.createElement("option");
        o.value = k;
        dlR.appendChild(o);
      });
    }

    if (dlU){
      (h.utilaje_debitare || []).forEach(u => {
        const v = (u ?? "").toString().trim();
        if (!v) return;
        const o = document.createElement("option");
        o.value = v;
        dlU.appendChild(o);
      });
    }
  }

  window.addEventListener('message', (ev) => {
    if (!ev || !ev.data) return;
    if (ev.data.type === 'HELPERS_UPDATED') {
      _helpers = null;
      _mapRepDebitare = null;
      try{ buildHelperMaps(); }catch(e){}
    }
  });

  function setAutofillReadonly(isReadonly){
    ["mDiam","mCal","mKgBuc","mLungime"].forEach(id => {
      const el = $(id);
      if (!el) return;
      if (isReadonly) el.setAttribute("readonly","readonly");
      else el.removeAttribute("readonly");
    });
  }

  function applyReperAutofill(){
    const override = $("mOverride")?.checked;
    if (override) return;
    if (!_mapRepDebitare) buildHelperMaps();
    const key = $("mReper")?.value?.trim();
    if (!key || !_mapRepDebitare || !_mapRepDebitare.has(key)) return;
    const info = _mapRepDebitare.get(key);

    if ($("mDiam")) $("mDiam").value = (info.diam ?? "") === "" ? "" : String(info.diam);
    if ($("mCal")) $("mCal").value = info.cal || "";

    if ($("mKgBuc")) {
      const n = Number(info.kgBuc);
      $("mKgBuc").value = Number.isFinite(n) ? String(n).replace(".", ",") : "";
    }

    if ($("mLungime")) {
      const n = Number(info.lung);
      $("mLungime").value = Number.isFinite(n) ? String(Math.trunc(n)) : "";
    }
  }

  // ===== HELPERS =====
  function goMenu(){ goDashboard(); }

  function monthLower(s){
    return (s ?? "").toString().trim().toLowerCase();
  }

  function stripDia(s){
    return (s ?? "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeDiam(v){
    if (v == null) return "";
    let s = (""+v).trim();
    s = s.replace(/√ò/gi,"").replace(/\s+/g,"").replace(/mm$/i,"");
    return s;
  }

  function parseNumberRO(v){
    if (v == null) return NaN;
    if (typeof v === "number") return v;
    let s = (""+v).trim();
    if (!s) return NaN;
    s = s.replace(/\s+/g,"");
    const hasComma = s.includes(",");
    if (hasComma){
      s = s.replace(/\./g,"").replace(",",".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }
    if (/^\d{1,3}(\.\d{3})+$/.test(s)){
      const n = Number(s.replace(/\./g,""));
      return Number.isFinite(n) ? n : NaN;
    }
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtIntDots(n){
    if (!Number.isFinite(n)) return "";
    const sign = n < 0 ? "-" : "";
    n = Math.abs(Math.trunc(n));
    const s = String(n);
    return sign + s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function fmtDecComma(n, decimals){
    if (!Number.isFinite(n)) return "";
    const fixed = n.toFixed(decimals);
    let s = fixed.replace(".", ",");
    if (decimals > 1){
      s = s.replace(/,0+$/,"");
      s = s.replace(/,(\d*[1-9])0+$/," ,$1").replace(" ","");
    }
    return s;
  }

  function fmtPct(n){
    if (!Number.isFinite(n)) return "";
    return String(Math.round(n)) + "%";
  }

  function parseDateAny(v){
    if (v == null || v === "") return "";
    if (typeof v === "number"){
      const excelEpoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(excelEpoch.getTime() + v * 86400000);
      return toISODate(d);
    }
    const s = (""+v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m1 = s.match(/^([0-3]?\d)\.([01]?\d)\.(\d{4})$/);
    if (m1){
      return `${m1[3]}-${m1[2].padStart(2,"0")}-${m1[1].padStart(2,"0")}`;
    }
    const m2 = s.match(/^([0-3]?\d)\/([01]?\d)\/(\d{4})$/);
    if (m2){
      return `${m2[3]}-${m2[2].padStart(2,"0")}-${m2[1].padStart(2,"0")}`;
    }
    const d = new Date(s);
    if (!isNaN(d.getTime())) return toISODate(d);
    return "";
  }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function fmtDateRO(iso){
    if (!iso) return "";
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function isoWeekNumber(iso){
    if (!iso) return "";
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return "";
    const d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function recalcRow(r){
    const y = parseNumberRO(r.an);
    if (Number.isFinite(y)) r.an = Math.trunc(y);
    if (r.luna != null) r.luna = monthLower(r.luna);
    if (r.data) r.data = parseDateAny(r.data);
    if (r.data){
      const yy2 = Number(r.data.slice(0,4));
      const mm2 = Number(r.data.slice(5,7));
      if (!r.an) r.an = yy2;
      if (!r.luna) r.luna = LUNI[mm2-1] || "";
    }

    const kgBuc = Number(r.kgBuc);
    const cant = Number(r.cantitate);
    if (Number.isFinite(kgBuc) && Number.isFinite(cant)){
      r.totalKg = Math.round(kgBuc * cant);
    } else {
      r.totalKg = "";
    }
    r.weekNr = r.data ? isoWeekNumber(r.data) : "";
    const plan = Number(r.planificat);
    if (Number.isFinite(plan) && plan > 0 && Number.isFinite(cant)){
      r.procentNorma = Math.round((cant / plan) * 100);
    } else {
      r.procentNorma = "";
    }
    return r;
  }

  function scheduleSave(){
    if (!CAN_STORE){
      pillSave.textContent = "autosave: OFF (storage blocat)";
      return;
    }
    pillSave.textContent = "autosave: saving‚Ä¶";
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ rows }));
        pillSave.textContent = "autosave: saved";
      } catch(e){
        console.error(e);
        pillSave.textContent = "autosave: failed";
      }
    }, 350);
  }

  function load(){
    if (!CAN_STORE){
      pillSave.textContent = "autosave: OFF (storage blocat)";
      return;
    }
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try{
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed?.rows)) rows = parsed.rows;
      filters = null;
    } catch(e){}
  }

  function resetAll(){
    if (!confirm("»òtergi toate datele DEBITATE salvate local?")) return;
    localStorage.removeItem(STORAGE_KEY);
    rows = [];
    filters = null;
    render();
    pillSave.textContent = "autosave: idle";
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify({ rows }, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `DEBITATE_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // ===== RENDER =====
  function buildHeader(){
    const hdr = $("hdr");
    const cg = $("colgroup");
    hdr.innerHTML = "";
    if (cg) cg.innerHTML = "";

    for (const col of COLUMNS){
      if (cg){
        const c = document.createElement("col");
        c.style.width = (COL_WIDTHS[col.key] || 90) + "px";
        cg.appendChild(c);
      }
      const th = document.createElement("th");
      th.textContent = col.label;
      hdr.appendChild(th);
    }

    if (cg){
      const cA = document.createElement("col");
      cA.style.width = ACTION_COL_W + "px";
      cg.appendChild(cA);
    }
    const thA = document.createElement("th");
    thA.textContent = "üóë";
    thA.title = "»òtergere r√¢nd";
    hdr.appendChild(thA);
  }

  function getFilteredRows(){
    const ySel = ($("fltYear")?.value || "").trim();
    const mSel = monthLower(($("fltMonth")?.value || "").trim());
    return rows.filter(r => {
      if (ySel && String(r.an ?? "").trim() !== ySel) return false;
      if (mSel && monthLower(r.luna) !== mSel) return false;
      return true;
    });
  }

  // ===== UI FILTERS =====
  const MONTHS_RO = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];

  function uniqYears(){
    const ys = new Set();
    rows.forEach(r => {
      const y = (r.an ?? "").toString().trim();
      if (y) ys.add(y);
    });
    return Array.from(ys).sort((a,b)=> Number(a)-Number(b));
  }
  function uniqMonthsForYear(y){
    const ms = new Set();
    rows.forEach(r => {
      if (String(r.an ?? "").trim() !== String(y)) return;
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    arr.sort((a,b)=> (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }
  function uniqMonthsAll(){
    const ms = new Set();
    rows.forEach(r => {
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    arr.sort((a,b)=> (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }

  function setSelectOptions(sel, options, firstLabel){
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = firstLabel;
    sel.appendChild(opt0);
    options.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
    if (options.includes(current)) sel.value = current;
    else sel.value = "";
  }

  function refreshFilterUI(preserve=true){
    const ySel = $("fltYear");
    const mSel = $("fltMonth");
    const years = uniqYears();
    if (!ySel || !mSel) return;

    const prevY = ySel.value;
    setSelectOptions(ySel, years, "(to»õi anii)");

    if (preserve && years.includes(prevY)) ySel.value = prevY;
    else ySel.value = "";

    const months = ySel.value ? uniqMonthsForYear(ySel.value) : uniqMonthsAll();
    const prevM = mSel.value;
    setSelectOptions(mSel, months, "(toate lunile)");
    if (preserve && months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = "";
  }

  function applyUIFilters(){
    if (btnPrevPage) btnPrevPage.addEventListener("click", ()=>{ currentPage = Math.max(0, currentPage - 1); renderBody(); });
    if (btnNextPage) btnNextPage.addEventListener("click", ()=>{ currentPage = currentPage + 1; renderBody(); });
    renderBody();
  }

  function resetUIFilters(){
    if ($("fltYear")) $("fltYear").value = "";
    refreshFilterUI(true);
    applyUIFilters();
  }

  // ===== SUMMARY =====
  function refreshSummaryUI(preserve=true){
    const ySel = $("sumYear");
    const mSel = $("sumMonth");
    if (!ySel || !mSel) return;
    const years = uniqYears();
    const prevY = ySel.value;
    setSelectOptions(ySel, years, "(alege anul)");
    if (preserve && years.includes(prevY)) ySel.value = prevY;
    else {
      ySel.value = years.length ? years[years.length-1] : "";
    }
    const months = ySel.value ? uniqMonthsForYear(ySel.value) : [];
    const prevM = mSel.value;
    setSelectOptions(mSel, months, "(toate lunile)");
    if (preserve && months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = "";
  }

  function refreshSummaryTable(){
    const body = $("sumBody");
    const y = ($("sumYear")?.value || "").trim();
    const m = monthLower(($("sumMonth")?.value || "").trim());
    if (!body) return;

    if (!y){
      body.innerHTML = '<tr><td colspan="5" class="center">SelecteazƒÉ Anul aici pentru a calcula sumarul.</td></tr>';
      return;
    }

    const bucket = new Map();
    for (const r of rows){
      if (String(r.an ?? "").trim() !== y) continue;
      if (m && monthLower(r.luna) !== m) continue;

      const reper = (r.reper ?? "").toString().trim();
      const diam = (r.diametru ?? "").toString().trim();
      const cal  = (r.calitate ?? "").toString().trim();

      const key = `${reper}|||${diam}|||${cal}`;
      const prev = bucket.get(key) || {reper, diam, cal, buc:0, kg:0};
      const buc = Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : parseNumberRO(r.cantitate);
      const kg  = Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : parseNumberRO(r.totalKg);
      prev.buc += Number.isFinite(buc) ? buc : 0;
      prev.kg  += Number.isFinite(kg) ? kg : 0;
      bucket.set(key, prev);
    }

    const arr = Array.from(bucket.values());
    arr.sort((a,b)=> (b.kg - a.kg));

    if (!arr.length){
      body.innerHTML = '<tr><td colspan="5" class="center">Nu existƒÉ date pentru anul/luna selectatƒÉ.</td></tr>';
      return;
    }

    body.innerHTML = "";
    for (const it of arr){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = it.reper || "(gol)";
      const td2 = document.createElement("td"); td2.textContent = it.diam || "(gol)";
      const td3 = document.createElement("td"); td3.textContent = it.cal || "(gol)";
      const td4 = document.createElement("td"); td4.className = "num"; td4.textContent = fmtIntDots(it.buc);
      const td5 = document.createElement("td"); td5.className = "num"; td5.textContent = fmtIntDots(it.kg);
      tr.append(td1,td2,td3,td4,td5);
      body.appendChild(tr);
    }
  }

  function renderBody(){
    const body = $("body");
    body.innerHTML = "";

    rows.forEach(r => recalcRow(r));

    const view = getFilteredRows();

    const totalPages = Math.max(1, Math.ceil(view.length / PAGE_SIZE));
    if (autoScrollBottom) currentPage = totalPages - 1;
    if (currentPage < 0) currentPage = 0;
    if (currentPage > totalPages - 1) currentPage = totalPages - 1;
    const start = currentPage * PAGE_SIZE;
    const end = Math.min(view.length, start + PAGE_SIZE);
    const slice = view.slice(start, end);
    if (pillPage) pillPage.textContent = `pagina ${currentPage+1}/${totalPages} (afi»ôeazƒÉ ${start+1}-${end})`;
    pillRows.textContent = `${view.length} r√¢nduri (pagina: ${slice.length})`;
    const total = view.reduce((s, r) => s + (Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : 0), 0);
    pillTotalKg.textContent = `${fmtIntDots(total)} kg total`;

    for (let idx=0; idx<slice.length; idx++){
      const r = slice[idx];
      const tr = document.createElement("tr");

      for (const col of COLUMNS){
        const td = document.createElement("td");
        if (col.align === "num") td.classList.add("num");
        if (col.align === "center") td.classList.add("center");

        if (col.readonly){
          td.textContent = displayValue(r, col);
        } else {
          const inp = document.createElement("input");
          inp.className = "cellinput";
          if (col.type === "date"){
            inp.value = fmtDateRO(r.data);
          } else {
            inp.value = displayEditValue(r, col);
          }

          inp.addEventListener("blur", () => {
            const newVal = inp.value;
            applyCellEdit(r, col, newVal);
            recalcRow(r);
            scheduleSave();
            setTimeout(() => renderBody(), 0);
          });

          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter"){
              e.preventDefault();
              inp.blur();
            }
          });

          td.appendChild(inp);
        }
        tr.appendChild(td);
      }

      // actions
      const tdA = document.createElement("td");
      tdA.className = "center actCell";
      const wrap = document.createElement("div");
      wrap.className = "rowActions";

      const bDel = document.createElement("button");
      bDel.className = "iconbtn danger";
      bDel.textContent = "üóë";
      bDel.title = "»òterge";
      bDel.addEventListener("click", () => {
        if (!confirm("»òtergi r√¢ndul selectat?")) return;
        const realIdx = rows.findIndex(x => x.id === r.id);
        if (realIdx >= 0) rows.splice(realIdx, 1);
        scheduleSave();
        setTimeout(() => renderBody(), 0);
      });

      wrap.appendChild(bDel);
      tdA.appendChild(wrap);
      tr.appendChild(tdA);

      body.appendChild(tr);
    }

    if (autoScrollBottom){
      const tw = $("tablewrap");
      if (tw){ tw.scrollTop = tw.scrollHeight; tw.scrollLeft = tw.scrollWidth; }
      autoScrollBottom = false;
    }
  }

  function displayValue(r, col){
    const v = r[col.key];
    if (col.type === "date") return fmtDateRO(r.data);
    if (col.type === "diam"){
      const d = normalizeDiam(v);
      return d ? "√ò " + d : "";
    }
    if (col.type === "year"){
      const n = Number(v);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (v ?? "");
    }
    if (col.type === "int"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtIntDots(n) : (v ?? "");
    }
    if (col.type === "dec2"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (v ?? "");
    }
    if (col.type === "dec1"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (v ?? "");
    }
    if (col.type === "pct"){
      const n = Number(v);
      return Number.isFinite(n) ? (String(Math.round(n)) + "%") : (v ?? "");
    }
    return (v ?? "").toString();
  }

  function displayEditValue(r, col){
    if (col.type === "year"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (r[col.key] ?? "");
    }
    if (col.type === "int"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtIntDots(n) : (r[col.key] ?? "");
    }
    if (col.type === "dec2"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (r[col.key] ?? "");
    }
    if (col.type === "dec1"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (r[col.key] ?? "");
    }
    if (col.type === "diam"){
      const d = normalizeDiam(r[col.key]);
      return d ? "√ò " + d : "";
    }
    return (r[col.key] ?? "").toString();
  }

  function applyCellEdit(r, col, raw){
    if (col.type === "date"){
      r.data = parseDateAny(raw);
      if (r.data){
        const [y,m] = r.data.split("-");
        if (!r.an) r.an = Number(y);
        if (!r.luna) r.luna = LUNI[Number(m)-1] || "";
      }
      return;
    }
    if (col.type === "diam"){
      r.diametru = normalizeDiam(raw);
      return;
    }
    if (col.type === "year"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : "";
      return;
    }
    if (col.type === "int"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : "";
      return;
    }
    if (col.type === "dec2"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : "";
      return;
    }
    if (col.type === "dec1"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : "";
      return;
    }
    r[col.key] = (raw ?? "").toString().trim();
    if (col.key === "luna") r.luna = monthLower(r.luna);
  }

  // ===== ADD MODAL =====
  let autoScrollBottom = true;

  function openAddModal(){
    const d = new Date();
    const iso = toISODate(d);
    $("mData").value = iso;
    $("mAn").value = String(d.getFullYear());
    $("mLuna").value = LUNI[d.getMonth()];
    $("mEchip").value = "";
    $("mOverride").checked = false;
    setAutofillReadonly(true);
    buildHelperMaps();
    $("mReper").value = "";
    $("mDiam").value = "";
    $("mCal").value = "";
    $("mKgBuc").value = "";
    $("mLungime").value = "";
    $("mSarja").value = "";
    $("mPlan").value = "";
    $("mCant").value = "";
    $("mSchimb").value = "1";
    $("mOper").value = "";
    $("mOre").value = "8,0";
    $("mErr").textContent = "";
    $("modalBack").classList.remove("hidden");
    setTimeout(()=>$("mEchip").focus(), 0);
  }

  function closeAddModal(){
    $("modalBack").classList.add("hidden");
  }

  function syncAnLunaFromDate(){
    const iso = parseDateAny($("mData").value);
    if (!iso) return;
    const y = iso.slice(0,4);
    const m = Number(iso.slice(5,7));
    $("mAn").value = y;
    $("mLuna").value = LUNI[m-1] || "";
  }

  function saveAddModal(){
    const err = [];
    const dataIso = parseDateAny($("mData").value);
    if (!dataIso) err.push("Data este obligatorie.");
    const echip = $("mEchip").value.trim();
    applyReperAutofill();
    const reper = $("mReper").value.trim();
    const diam = normalizeDiam($("mDiam").value);
    const cal = $("mCal").value.trim();
    const kgBuc = parseNumberRO($("mKgBuc").value);
    const lung = parseNumberRO($("mLungime").value);
    const sarja = $("mSarja").value.trim();
    const plan = parseNumberRO($("mPlan").value);
    const cant = parseNumberRO($("mCant").value);
    const schimb = parseNumberRO($("mSchimb").value);
    const oper = $("mOper").value.trim();
    const ore = parseNumberRO($("mOre").value);

    if (!echip) err.push("Echipament este obligatoriu.");
    if (!reper) err.push("Reper este obligatoriu.");
    if (!diam) err.push("Diametru este obligatoriu.");
    if (!cal) err.push("Calitate este obligatorie.");
    if (!Number.isFinite(kgBuc)) err.push("Kg/buc este obligatoriu.");
    if (!Number.isFinite(lung)) err.push("Lungime debitat este obligatorie.");
    if (!sarja) err.push("Sarja este obligatorie.");
    if (!Number.isFinite(cant)) err.push("Cantitate este obligatorie.");
    if (!Number.isFinite(schimb)) err.push("Schimbul este obligatoriu.");
    if (!oper) err.push("Operator este obligatoriu.");

    if (err.length){
      $("mErr").textContent = err.join(" ");
      return;
    }

    const y = Number(dataIso.slice(0,4));
    const m = Number(dataIso.slice(5,7));

    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)),
      an: y,
      luna: LUNI[m-1] || "",
      data: dataIso,
      echipament: echip,
      reper: reper,
      diametru: diam,
      calitate: cal,
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : "",
      lungime: Number.isFinite(lung) ? Math.trunc(lung) : "",
      sarja: sarja,
      planificat: Number.isFinite(plan) ? Math.trunc(plan) : "",
      cantitate: Math.trunc(cant),
      schimbul: Math.trunc(schimb),
      totalKg: "",
      weekNr: isoWeekNumber(dataIso),
      operator: oper,
      procentNorma: "",
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };

    recalcRow(r);
    rows.push(r);

    autoScrollBottom = true;
    scheduleSave();
    setTimeout(() => renderBody(), 0);
    closeAddModal();
  }

  // ===== XLSX =====
  async function ensureXLSX(){
    if (window.XLSX) return true;
    const localUrl = new URL("xlsx.full.min.js", (parent.location.href.split("#")[0].split("?")[0])).href;
    try{
      await loadScript(localUrl);
      if (window.XLSX) return true;
    } catch(e){}
    try{
      await loadScript("https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js");
      return !!window.XLSX;
    } catch(e){
      alert("Nu pot √ÆncƒÉrca librƒÉria XLSX.");
      return false;
    }
  }

  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error("Failed " + src));
      document.head.appendChild(s);
    });
  }

  function exportXLSX(){
    ensureXLSX().then(ok=>{
      if (!ok) return;
      const data = rows.map(r => ({
        "Anul": r.an,
        "Luna": r.luna,
        "Data": fmtDateRO(r.data),
        "Echipament": r.echipament,
        "Reper": r.reper,
        "Diametru o»õel": normalizeDiam(r.diametru) ? ("√ò " + normalizeDiam(r.diametru)) : "",
        "CALITATE": r.calitate,
        "Kg/buc.": Number.isFinite(Number(r.kgBuc)) ? Number(r.kgBuc) : "",
        "Lungime debitat mm": Number.isFinite(Number(r.lungime)) ? Number(r.lungime) : "",
        "Sarja": r.sarja,
        "Planificat": Number.isFinite(Number(r.planificat)) ? Number(r.planificat) : "",
        "Cantitate": Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : "",
        "Schimbul": Number.isFinite(Number(r.schimbul)) ? Number(r.schimbul) : "",
        "total kg debitat": Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : "",
        "week nr.": Number.isFinite(Number(r.weekNr)) ? Number(r.weekNr) : "",
        "Operator": r.operator,
        "Procent norma %": Number.isFinite(Number(r.procentNorma)) ? Number(r.procentNorma) : "",
        "Ore lucrate": Number.isFinite(Number(r.oreLucrate)) ? Number(r.oreLucrate) : ""
      }));

      const ws = XLSX.utils.json_to_sheet(data, { skipHeader:false });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DEBITATE");
      const name = `DEBITATE_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    });
  }

  function importXLSX(){
    ensureXLSX().then(ok=>{
      if (!ok) return;

      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = ".xlsx,.xls";
      inp.addEventListener("change", async () => {
        const file = inp.files && inp.files[0];
        if (!file) return;
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval:"" });

        const mapped = raw.map(obj => mapRowFromExcel(obj)).filter(Boolean);
        if (!mapped.length){
          alert("Nu am gƒÉsit r√¢nduri importabile.");
          return;
        }

        rows = mapped.concat(rows);
        rows.forEach(r => recalcRow(r));
        rows.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
        autoScrollBottom = true;
        scheduleSave();
        setTimeout(() => renderBody(), 0);
      });
      inp.click();
    });
  }

  function getAny(obj, keys){
    for (const k of keys){
      if (k in obj) return obj[k];
      const found = Object.keys(obj).find(h => stripDia(h).toLowerCase() === stripDia(k).toLowerCase());
      if (found) return obj[found];
    }
    return "";
  }

  function mapRowFromExcel(obj){
    const an = parseNumberRO(getAny(obj, ["Anul","An","An intrare"]));
    const luna = monthLower(getAny(obj, ["Luna","LUNA","Luna intrare"]));
    const dataIso = parseDateAny(getAny(obj, ["Data","Data Intrare","Data intrare"]));
    const ech = getAny(obj, ["Echipament","Echipament (utilajul de debitare)","Utilaj"]);
    const reper = getAny(obj, ["Reper","Denumire reper debitare"]);
    const diam = normalizeDiam(getAny(obj, ["Diametru o»õel","Diametru otel","Diametrul o»õelului","Diametru o»õelului"]));
    const cal = getAny(obj, ["CALITATE","Calitate","Calitatea o»õelului"]);
    const kgBuc = parseNumberRO(getAny(obj, ["Kg/buc.","Kg/buc","Kg/buc.","Kg/bucƒÉ","Kg/buc (kg/buc)"]));
    const lungime = parseNumberRO(getAny(obj, ["Lungime debitat mm","Lungime debitat","Lungime debitat (mm)"]));
    const sarja = getAny(obj, ["Sarja","SarjƒÉ","Sarja material","Sarja materialului"]);
    const planificat = parseNumberRO(getAny(obj, ["Planificat","Planificat (buc)"]));
    const cant = parseNumberRO(getAny(obj, ["Cantitate","Cantitate (buc)","Cantitate buc"]));
    const schimb = parseNumberRO(getAny(obj, ["Schimbul","Schimb"]));
    const operator = getAny(obj, ["Operator"]);
    const ore = parseNumberRO(getAny(obj, ["Ore lucrate","Ore"]));

    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)),
      an: Number.isFinite(an) ? Math.trunc(an) : (dataIso ? Number(dataIso.slice(0,4)) : ""),
      luna: luna || (dataIso ? LUNI[Number(dataIso.slice(5,7))-1] : ""),
      data: dataIso,
      echipament: (ech ?? "").toString().trim(),
      reper: (reper ?? "").toString().trim(),
      diametru: diam,
      calitate: (cal ?? "").toString().trim(),
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : "",
      lungime: Number.isFinite(lungime) ? Math.trunc(lungime) : "",
      sarja: (sarja ?? "").toString().trim(),
      planificat: Number.isFinite(planificat) ? Math.trunc(planificat) : "",
      cantitate: Number.isFinite(cant) ? Math.trunc(cant) : "",
      schimbul: Number.isFinite(schimb) ? Math.trunc(schimb) : "",
      totalKg: "",
      weekNr: "",
      operator: (operator ?? "").toString().trim(),
      procentNorma: "",
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };
    recalcRow(r);
    if (!r.data && !r.an) return null;
    return r;
  }

  // ===== INIT =====
  function render(){
    buildHeader();
    refreshFilterUI(true);
    refreshSummaryUI(true);
    renderBody();
    refreshSummaryTable();
  }

  (function init(){
    load();
    const _fy = $("fltYear");
    const _fm = $("fltMonth");
    if (_fy) _fy.addEventListener("change", () => { refreshFilterUI(true); applyUIFilters(); });
    if (_fm) _fm.addEventListener("change", () => { applyUIFilters(); });

    const _sy = $("sumYear");
    const _sm = $("sumMonth");
    if (_sy) _sy.addEventListener("change", () => { refreshSummaryUI(true); refreshSummaryTable(); });
    if (_sm) _sm.addEventListener("change", () => { refreshSummaryTable(); });

    if (btnPrevPage) btnPrevPage.addEventListener("click", ()=>{ currentPage = Math.max(0, currentPage - 1); renderBody(); });
    if (btnNextPage) btnNextPage.addEventListener("click", ()=>{ currentPage = currentPage + 1; renderBody(); });

    buildHelperMaps();
    const _mr = $("mReper"); if (_mr) _mr.addEventListener("input", applyReperAutofill);
    const _ov = $("mOverride"); if (_ov) _ov.addEventListener("change", () => { setAutofillReadonly(!_ov.checked); if(!_ov.checked) applyReperAutofill(); });

    rows.forEach(r => {
      r.luna = monthLower(r.luna);
      r.diametru = normalizeDiam(r.diametru);
      r.data = parseDateAny(r.data);
      const _y = parseNumberRO(r.an);
      if (Number.isFinite(_y)) r.an = Math.trunc(_y);
      recalcRow(r);
    });
    rows.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
    autoScrollBottom = true;
    render();
    if (rows.length) scheduleSave();
  })();
</script>

  <datalist id="dlRepereDebitare"></datalist>
  <datalist id="dlUtilajeDebitare"></datalist>

<!-- ================================================================
     SUPABASE CLIENT
     Same init pattern as index.html / intrari-otel.html
     ================================================================ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  const URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
  const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
  if(!window.supabase || !window.supabase.createClient){ return; }
  const supa = window.supabase.createClient(URL, KEY, {
    auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false }
  });
  window.__aclSupa = supa;
  window.__SUPA__  = supa;
})();
</script>

<!-- ================================================================
     ACL BOOT ‚Äî same pattern as helper-data.html
     Key fix: can_sync_cloud fallback = true for admin/editor
     (matches how helper-data.html resolves permissions)
     ================================================================ -->
<script>
let __ACL = null;
let __ME  = { role:"viewer", email:"" };

function setRoleBadge(txt, err){
  const el = document.getElementById("roleBadge");
  if(!el) return;
  el.textContent = txt;
  if(err) el.style.color = "#ef4444";
}

async function aclGetMyRole(supa){
  try{
    const { data:s } = await supa.auth.getSession();
    const sess = s && s.session;
    if(!sess) return { role:"viewer", email:"" };
    const email = (sess.user && sess.user.email) || "";
    const { data } = await supa.from("profiles").select("role").eq("id", sess.user.id).maybeSingle();
    return { role:(data && data.role) || "viewer", email };
  }catch(e){
    console.warn("aclGetMyRole:", e);
    return { role:"viewer", email:"" };
  }
}

function applyAclUi(acl){
  __ACL = acl;
  const map = {
    import:"show_import_buttons", add:"show_add_buttons",
    delete:"show_delete_buttons", reset:"show_reset_buttons",
    export:"can_export", filter:"can_filter", sync:"can_sync_cloud"
  };
  document.querySelectorAll("[data-acl]").forEach(el => {
    const prop = map[el.getAttribute("data-acl")];
    if(prop) el.style.display = !!acl[prop] ? "" : "none";
  });
  document.querySelectorAll("[data-edit]").forEach(el => {
    try{ el.disabled = !acl.can_edit_data; }catch(_e){}
  });
  document.querySelectorAll("[data-edit-btn]").forEach(el => {
    el.style.display = acl.can_edit_data ? "" : "none";
  });
}

// Hook render so ACL re-applies after each render
(function(){
  const _rb = window.renderBody;
  if(typeof _rb === "function"){
    window.renderBody = function(){
      const r = _rb.apply(this, arguments);
      try{ if(__ACL) applyAclUi(__ACL); }catch(_e){}
      return r;
    };
  }
  const _open = window.openAddModal;
  if(typeof _open === "function"){
    window.openAddModal = function(){
      if(__ACL && !__ACL.can_edit_data) return;
      return _open.apply(this, arguments);
    };
  }
  const _save = window.saveAddModal;
  if(typeof _save === "function"){
    window.saveAddModal = function(){
      if(__ACL && !__ACL.can_edit_data) return;
      return _save.apply(this, arguments);
    };
  }
})();

async function bootAclDebitate(){
  const supa = window.__aclSupa;

  // Locked state until ACL loads
  applyAclUi({
    can_view:true, can_edit_data:false,
    show_import_buttons:false, show_add_buttons:false,
    show_delete_buttons:false, show_reset_buttons:false,
    can_export:true, can_filter:true, can_sync_cloud:false
  });

  if(!supa){
    setRoleBadge("rol: local (fara Supabase)");
    try{ window.debitateCloud && window.debitateCloud.boot(); }catch(_e){}
    return;
  }

  try{
    __ME = await aclGetMyRole(supa);
    const isPrivileged = (__ME.role === "admin" || __ME.role === "editor");

    // Load rf_acl row (same as helper-data.html)
    let row = null;
    const q = await supa.from("rf_acl").select("*")
      .eq("page_key","debitate").eq("role", __ME.role).maybeSingle();
    if(!q.error) row = q.data;

    // Resolve ACL ‚Äî same logic as helper-data.html:
    //   acl ? use db values : fallback based on role
    // CRITICAL: can_sync_cloud null/missing ‚Üí true for admin/editor
    const acl = {
      can_view:              row ? row.can_view              !== false  : true,
      can_edit_data:         row ? !!row.can_edit_data                  : isPrivileged,
      show_add_buttons:      row ? !!row.show_add_buttons               : isPrivileged,
      show_import_buttons:   row ? !!row.show_import_buttons            : isPrivileged,
      show_delete_buttons:   row ? !!row.show_delete_buttons            : isPrivileged,
      show_reset_buttons:    row ? !!row.show_reset_buttons             : (__ME.role === "admin"),
      can_export:            row ? row.can_export            !== false  : true,
      can_filter:            row ? row.can_filter            !== false  : true,
      // KEY FIX: null/undefined ‚Üí isPrivileged (same as helper-data.html)
      can_sync_cloud:        row ? (row.can_sync_cloud != null ? !!row.can_sync_cloud : isPrivileged)
                                 : isPrivileged
    };

    console.log("[DEBITATE ACL]", { role:__ME.role, email:__ME.email, aclRow:row, resolved:acl });

    if(!acl.can_view){ location.href = "index.html"; return; }

    setRoleBadge("rol: " + __ME.role + (__ME.email ? " | " + __ME.email : ""));
    applyAclUi(acl);

  }catch(e){
    console.warn("bootAclDebitate error:", e);
    setRoleBadge("ACL error - viewer fallback");
  }

  // Boot cloud sync AFTER ACL is known
  try{ window.debitateCloud && window.debitateCloud.boot(); }catch(_e){}
}

window.addEventListener("load", () => setTimeout(bootAclDebitate, 300));
</script>

<!-- ================================================================
     CLOUD SYNC ‚Äî same pattern as intrari-otel.html
     Uses 'data' column (not 'content') ‚Äî matches existing DB rows
     Pull on boot for ALL users; push only for can_edit+can_sync
     ================================================================ -->
<script>
window.debitateCloud = (function(){
  const DOC_KEY   = "debitate";
  const DOC_TABLE = "rf_documents";
  const pill = document.getElementById("pillCloud");

  let lastPulledAt = null;
  let lastPushedAt = null;
  let pollTimer    = null;
  let pushTimer    = null;
  let inFlight     = false;
  let booted       = false;

  function setPill(txt, ok){
    if(!pill) return;
    pill.textContent = txt;
    pill.style.color = ok ? "#065f46" : "#b91c1c";
  }

  function getClient(){ return window.__aclSupa || null; }
  function canEdit(){   return !!(window.__ACL && window.__ACL.can_edit_data); }
  function canSync(){   return !!(window.__ACL && window.__ACL.can_sync_cloud); }
  function nowIso(){    return new Date().toISOString(); }

  function isActivelyEditing(){
    const ae = document.activeElement;
    return !!(ae && (ae.tagName === "INPUT" || ae.tagName === "TEXTAREA"
              || ae.tagName === "SELECT" || ae.isContentEditable));
  }

  // ‚îÄ‚îÄ Pull from cloud ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // source="boot": always apply, ignore timestamps
  // source="poll": respect lastPushedAt (don't overwrite fresh local push)
  async function pull(source){
    const supa = getClient();
    if(!supa){ setPill("cloud: fara Supabase", false); return; }
    if(inFlight && source !== "boot") return;

    // Don't overwrite while user is actively typing (except on boot)
    if(source !== "boot" && isActivelyEditing()) return;

    inFlight = true;
    try{
      setPill(source === "boot" ? "cloud: se incarca..." : "cloud: sync...", true);

      const { data, error } = await supa
        .from(DOC_TABLE)
        .select("doc_key, data, content, updated_at")
        .eq("doc_key", DOC_KEY)
        .maybeSingle();

      if(error) throw error;
      if(!data){ setPill("cloud: gol (nicio data salvata)", false); return; }

      const ts = data.updated_at || null;

      // On poll: skip if we already have this version or pushed something newer
      if(source === "poll"){
        if(lastPulledAt && ts && new Date(ts) <= new Date(lastPulledAt)) return;
        if(lastPushedAt && ts && new Date(ts) <= new Date(lastPushedAt)) return;
      }

      // prefer 'data' column (matches intrari-otel.html), fallback 'content'
      const payload = (data.data !== undefined && data.data !== null)
                       ? data.data
                       : data.content;

      if(!payload || !Array.isArray(payload.rows)){
        setPill("cloud: format invalid (" + JSON.stringify(Object.keys(data)) + ")", false);
        console.warn("[DEBITATE CLOUD] unexpected payload:", data);
        return;
      }

      rows = payload.rows;
      try{ render(); }catch(_e){}
      lastPulledAt = ts || nowIso();
      setPill("cloud: OK (" + rows.length + " randuri)", true);
      console.log("[DEBITATE CLOUD] pull " + source + " OK, rows=" + rows.length + ", ts=" + ts);

    }catch(e){
      console.warn("[DEBITATE CLOUD] pull error:", e);
      setPill("cloud: eroare pull - " + (e.message || e), false);
    }finally{
      inFlight = false;
    }
  }

  // ‚îÄ‚îÄ Push to cloud ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function push(){
    const supa = getClient();
    if(!supa) return;
    setPill("cloud: salvez...", true);
    try{
      const payload = {
        app: "DEBITATE", version: 2,
        savedAt: nowIso(),
        rows: Array.isArray(rows) ? rows : []
      };
      const ts = nowIso();
      // Use 'data' column ‚Äî same as intrari-otel.html
      const { error } = await supa.from(DOC_TABLE)
        .upsert({ doc_key: DOC_KEY, data: payload, updated_at: ts }, { onConflict:"doc_key" });
      if(error) throw error;
      lastPushedAt = ts;
      setPill("cloud: salvat OK (" + payload.rows.length + " randuri)", true);
      console.log("[DEBITATE CLOUD] push OK, rows=" + payload.rows.length);
    }catch(e){
      console.warn("[DEBITATE CLOUD] push error:", e);
      setPill("cloud: eroare push - " + (e.message || e), false);
    }
  }

  // ‚îÄ‚îÄ Public: syncNow (Sync Cloud button) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function syncNow(){
    console.log("[DEBITATE CLOUD] syncNow called: canEdit=" + canEdit() + " canSync=" + canSync() + " __ACL=", window.__ACL);
    if(!canEdit() || !canSync()){
      setPill("cloud: fara drept sync (canEdit=" + canEdit() + " canSync=" + canSync() + ")", false);
      return;
    }
    await push();
  }

  // ‚îÄ‚îÄ scheduleSync: auto-push after scheduleSave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scheduleSync(){
    if(!canEdit() || !canSync()) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(() => push(), 800);
  }

  // ‚îÄ‚îÄ Polling: every 2.5s (same as intrari-otel.html) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function startPolling(){
    if(pollTimer) return;
    pollTimer = setInterval(() => pull("poll").catch(() => {}), 2500);
  }

  // ‚îÄ‚îÄ Realtime WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeRealtime(){
    const supa = getClient();
    if(!supa) return;
    try{
      supa.channel("rf_deb_rt_v4")
        .on("postgres_changes", {
          event:"*", schema:"public",
          table:DOC_TABLE, filter:"doc_key=eq." + DOC_KEY
        }, ev => {
          if(isActivelyEditing()) return;
          const row = ev && ev.new;
          if(!row) return;
          const pl = (row.data !== undefined && row.data !== null) ? row.data : row.content;
          if(pl && Array.isArray(pl.rows)){
            rows = pl.rows;
            try{ render(); }catch(_e){}
            lastPulledAt = row.updated_at || nowIso();
            setPill("cloud: live (" + pl.rows.length + " randuri)", true);
          }
        })
        .subscribe();
    }catch(_e){}
  }

  // ‚îÄ‚îÄ Hook scheduleSave so every save also pushes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function hookScheduleSave(){
    const orig = window.scheduleSave;
    if(typeof orig !== "function") return;
    window.scheduleSave = function(){
      const r = orig.apply(this, arguments);
      scheduleSync();
      return r;
    };
  }

  // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function boot(){
    if(booted) return;
    booted = true;

    hookScheduleSave();

    const supa = getClient();
    if(!supa){ setPill("cloud: fara Supabase", false); return; }

    console.log("[DEBITATE CLOUD] boot: role=" + (__ME && __ME.role) + " canEdit=" + canEdit() + " canSync=" + canSync());

    // Pull immediately for ALL users ‚Äî no role check
    await pull("boot");

    // Start live sync
    subscribeRealtime();
    startPolling();

    if(canEdit() && canSync()){
      setPill("cloud: editor sync activ", true);
    } else if(canEdit()){
      setPill("cloud: editor (apasa Sync pt push)", true);
    } else {
      setPill("cloud: auto-receive activ", true);
    }
  }

  return { boot, syncNow, scheduleSync };
})();

// Fallback if bootAclDebitate fails to call boot()
window.addEventListener("load", () => {
  setTimeout(() => { try{ window.debitateCloud.boot(); }catch(_e){} }, 4000);
});
</script>

</body>
</html>
