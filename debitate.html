<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEBITATE</title>
  <style>
    .topnav{display:none!important;} .stage{padding-top:0!important;} iframe{height:100vh!important;}

    :root{
      --bg:#b7d7f0;
      --hdr:#cfe3f6;
      --grid:#000;
      --white:#fff;
      --btn:#2b6cb0;
      --btn2:#1e5a96;
      --focus:#2563eb;
      --shadow: rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color:#0b1220;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
    }
    .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:8px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 2px 6px var(--shadow);
    }
    .btn.primary{
      background: var(--btn);
      color:#fff;
      border-color: rgba(0,0,0,.15);
    }
    .btn.primary:hover{ background: var(--btn2); }
    .status{
      font-size:12px;
      color:#0b1220;
      opacity:.75;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      background: rgba(255,255,255,.75);
      font-size:12px;
      font-weight:700;
    }
    .wrap{
      padding: 0 12px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .tablewrap{
      background: rgba(255,255,255,.35);
      border-radius:10px;
      overflow:auto;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      border:1px solid rgba(0,0,0,.2);
      box-shadow: 0 2px 10px var(--shadow);

      /* Flex layout */
      flex: 1 1 auto;
      min-width: 0;
      width: 100%;
      display: block;
      max-width: none;
    }

    .sidePanel{
      flex: 0 0 420px;
      width: 420px;
      max-width: 420px;
      height: calc(100vh - 150px);
      max-height: calc(100vh - 150px);
      overflow:auto;
      padding-right:2px;
    }
    .card{
      background: rgba(255,255,255,.7);
      border:1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 10px;
      margin-bottom: 12px;
    }
    .cardTitle{
      font-weight: 900;
      font-size: 13px;
      margin: 2px 0 10px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .field label{ display:block; font-size:12px; font-weight:800; margin: 0 0 4px; }
    .field select, .field input{
      width:100%;
      border:1px solid rgba(0,0,0,.25);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      font-weight:800;
      font-size:12px;
      outline:none;
    }
    .btnRow{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .btn.small{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .btn.ghost{ background: rgba(255,255,255,.4); }
    .note{ margin-top:8px; font-size:12px; opacity:.82; }
    .sumWrap{ margin-top:10px; background: rgba(255,255,255,.55); border-radius:10px; border:1px solid rgba(0,0,0,.12); overflow-y:auto; overflow-x:hidden; max-height: 300px; }
    .sumTable{ border-collapse: collapse; width:100%; table-layout:fixed; background:#fff; }
    .sumTable th, .sumTable td{ border:1px solid rgba(0,0,0,.35); padding:4px 6px; font-size:12px; line-height:1.15; white-space:nowrap; overflow-wrap:normal; word-break:normal; vertical-align:middle; }
    .sumTable th{ background: var(--hdr); position: sticky; top:0; z-index: 1; }
    .sumTable th:nth-child(4), .sumTable th:nth-child(5),
    .sumTable td:nth-child(4), .sumTable td:nth-child(5){
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .sumTable th:nth-child(2), .sumTable td:nth-child(2){ text-align:center; }
/* FÄƒrÄƒ scroll stÃ¢nga-dreapta: coloane fixe + wrap controlat */
.sumTable th:nth-child(1), .sumTable td:nth-child(1){ width: 28%; }
.sumTable th:nth-child(2), .sumTable td:nth-child(2){ width: 14%; }
.sumTable th:nth-child(3), .sumTable td:nth-child(3){ width: 30%; }
.sumTable th:nth-child(4), .sumTable td:nth-child(4){ width: 14%; }
.sumTable th:nth-child(5), .sumTable td:nth-child(5){ width: 14%; }

.sumTable th:nth-child(1), .sumTable td:nth-child(1),
.sumTable th:nth-child(3), .sumTable td:nth-child(3){
  white-space: normal;
  overflow-wrap: break-word;
  word-break: break-word;
}


    table{
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
      background: var(--white);
    }
    th, td{
      border: 1px solid var(--grid);
      padding: 1px 3px;
      font-size: 10px;
      line-height: 1.0;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: middle;
    }
    thead th{
      background: var(--hdr);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space: pre-line; /* permite titluri pe 2 randuri */
      text-align:center;
    }
    th:last-child{ padding:0 !important; }
    td:last-child{ padding:0 !important; }
    
    thead tr.filters th{ display:none; /* removed */
      
      top: 26px; /* height of header row */
      z-index: 1;
      background: #e8f3ff;
      padding: 2px 4px;
    }
    .finput, .fselect{
      width: 100%;
      border: 1px solid rgba(0,0,0,.35);
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 10px;
      background:#fff;
      height: 22px;
    }
    .cellinput{
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      font-size: 10px;
      padding: 0;
      height: 18px;
    }
    .cellinput:focus{
      outline: 2px solid rgba(37,99,235,.35);
      border-radius: 4px;
      background: rgba(37,99,235,.06);
    }
    .num{text-align:right; font-variant-numeric: tabular-nums;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .center{text-align:center;; white-space:nowrap; overflow-wrap:normal; word-break:normal }
    .rowActions{
      display:flex;
      gap:0;
      justify-content:center;
    }
    .actCell{ padding:0 !important; }
    .actCell .rowActions{ padding:0; }
    .iconbtn{
      border:1px solid rgba(0,0,0,.25);
      background:#fff;
      border-radius:6px;
      width:18px;
      height:18px;
      padding:0;
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .iconbtn.danger{ background:#fff1f2; }
    .hint{
      font-size:12px;
      opacity:.8;
    }
    
    /* modal add/edit */
    .modalback{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(1100px, 100%);
      background: #fff;
      border: 1px solid rgba(0,0,0,.25);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.28);
      overflow: hidden;
    }
    .modal header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      background: var(--hdr);
      border-bottom: 1px solid rgba(0,0,0,.2);
      font-weight: 900;
    }
    .modal .content{
      padding: 12px;
      background: #fff;
    }
    .modal .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .modal label{
      display:grid;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
    }
    .modal input, .modal select{
      border:1px solid rgba(0,0,0,.35);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
      background:#fff;
      width:100%;
    }
    .modal .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top: 12px;
    }
    .modal .err{
      color: #b00020;
      font-size: 12px;
      font-weight: 800;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .modal .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 560px){
      .modal .grid{ grid-template-columns: 1fr; }
    }

    .hidden{ display:none !important; }
  
    .chk{ grid-column: 1 / -1; display:flex; align-items:center; gap:10px; font-size:12px; padding:6px 8px; background: rgba(255,255,255,.55); border: 1px dashed rgba(0,0,0,.25); border-radius:10px;}
    .chk input{ width:16px; height:16px; }
</style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .roleBadge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.2);background:rgba(255,255,255,.75);font-size:12px;font-weight:700}
    .roleBadge.err{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
      .roleDot{width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .roleDot.viewer{background:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.2)}
    .cloudBadge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#ecfeff;color:#0f766e;border:1px solid #99f6e4;font-weight:900;font-size:12px}
    .cloudBadge.off{background:#fff1f2;color:#b91c1c;border-color:#fecdd3}
  </style>


<script>
function goDashboard(){ window.location.href='index.html'; }
</script>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <button class="btn" onclick="goMenu()">â¬… Dashboard</button>
      <button class="btn primary" onclick="openAddModal()" data-acl="add">âž• AdaugÄƒ</button>
      <div class="status">
        <span class="pill" id="pillRows">0 rÃ¢nduri</span>
        <span class="pill" id="pillTotalKg">0 kg total</span>
        <span class="pill" id="pillSave">autosave: idle</span>

        <button class="btn" id="btnPrevPage" title="Pagina anterioarÄƒ">â—€</button>
        <span class="pill" id="pillPage">pagina 1/1</span>
        <button class="btn" id="btnNextPage" title="Pagina urmÄƒtoare">â–¶</button>

        <span id="roleBadge" class="roleBadge" style="display:none;">
          <span id="roleDot" class="roleDot"></span>
          <span id="roleText"></span>
        </span>
      </div>
    </div>
    <div class="right">
      <button class="btn" onclick="exportXLSX()" data-acl="export">â¤“ Export Excel</button>
      <button class="btn" onclick="importXLSX()" data-acl="import">â¤’ Import Excel</button>
      <button class="btn" onclick="exportJSON()" data-acl="export">â¤“ Export JSON</button>
      <button class="btn" onclick="resetAll()" data-acl="reset" title="È˜terge toate datele salvate local">Reset</button>
      <span id="cloudBadge" class="cloudBadge" style="display:none;">Cloud: ...</span>
    </div>
  </div>

  <div class="wrap">
    <div class="tablewrap" id="tablewrap">
      <table id="tbl">
        <colgroup id="colgroup"></colgroup>
        <thead>
          <tr id="hdr"></tr>
          
        </thead>
        <tbody id="body"></tbody>
      </table>

    </div>
    <div class="sidePanel" aria-label="Filtre È™i sumar">
      <div class="card">
        <div class="cardTitle">Filtre (tabel)</div>
        <div class="grid2">
          <div class="field">
            <label for="fltYear">An</label>
            <select id="fltYear"></select>
          </div>
          <div class="field">
            <label for="fltMonth">LunÄƒ</label>
            <select id="fltMonth"></select>
          </div>
        </div>
        <div class="btnRow">
          <button class="btn small" onclick="applyUIFilters()" data-acl="filter">FiltreazÄƒ</button>
          <button class="btn small ghost" onclick="resetUIFilters()" data-acl="filter">Reset filtre</button>
        </div>
        <div class="note">FiltreazÄƒ rÃ¢ndurile din tabel dupÄƒ An È™i LunÄƒ.</div>
      </div>

      <div class="card">
        <div class="cardTitle">SumÄƒ debitate pe Reper + Diametru + Calitate</div>
        <div class="grid2">
          <div class="field">
            <label for="sumYear">An</label>
            <select id="sumYear"></select>
          </div>
          <div class="field">
            <label for="sumMonth">LunÄƒ</label>
            <select id="sumMonth"></select>
          </div>
        </div>
        <div class="note">Sumarul foloseÈ™te doar An/LunÄƒ de aici (independent de filtrele tabelului).</div>
        <div class="sumWrap">
          <table class="sumTable">
            <thead>
              <tr>
                <th>Reper</th>
                <th>Diametru</th>
                <th>Calitate</th>
                <th class="num">Total buc</th>
                <th class="num">Total kg</th>
              </tr>
            </thead>
            <tbody id="sumBody">
              <tr><td colspan="5" class="center">SelecteazÄƒ Anul aici pentru a calcula sumarul.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Modal AdaugÄƒ rÃ¢nd -->

  <div class="modalback hidden" id="modalBack" onclick="if(event.target.id==='modalBack') closeAddModal()">
    <div class="modal" role="dialog" aria-modal="true" aria-label="AdaugÄƒ debitare">
      <header>
        <div>AdaugÄƒ debitare</div>
        <button class="btn" type="button" onclick="closeAddModal()">âœ•</button>
      </header>
      <div class="content">
        <div class="grid">
          <label>Data
            <input id="mData" type="date" onchange="syncAnLunaFromDate()" data-edit>
          </label>
          <label>An (auto)
            <input id="mAn" type="text" readonly data-edit>
          </label>
          <label>LunÄƒ (auto)
            <input id="mLuna" type="text" readonly data-edit>
          </label>
          <label>Echipament
            <input id="mEchip" type="text" list="dlUtilajeDebitare" placeholder="ex: 1 SCPK 500 / EVERSING" data-edit>
          </label>

          <label>Reper
            <input id="mReper" type="text" list="dlRepereDebitare" placeholder="ex: 248-2307/08" data-edit>
          </label>

          <label class="chk">
            <input id="mOverride" type="checkbox" data-edit>
            Override manual (Diametru / Calitate / Kg/buc / Lungime)
          </label>
          <label>Diametru oÈ›el
            <input id="mDiam" type="text" placeholder="ex: Ã˜71 / 71" readonly data-edit>
          </label>
          <label>CALITATE
            <input id="mCal" type="text" placeholder="ex: 1E-1287/15B34" readonly data-edit>
          </label>
          <label>Kg/buc.
            <input id="mKgBuc" type="text" placeholder="ex: 8,5" readonly data-edit>
          </label>

          <label>Lungime debitat (mm)
            <input id="mLungime" type="text" placeholder="ex: 264" readonly data-edit>
          </label>
          <label>Sarja
            <input id="mSarja" type="text" placeholder="ex: DAR / DRM" data-edit>
          </label>
          <label>Planificat
            <input id="mPlan" type="text" placeholder="ex: 1.056" data-edit>
          </label>
          <label>Cantitate
            <input id="mCant" type="text" placeholder="ex: 1.056" data-edit>
          </label>

          <label>Schimbul
            <input id="mSchimb" type="text" placeholder="1" data-edit>
          </label>
          <label>Operator
            <input id="mOper" type="text" placeholder="ex: Nagy Robert" data-edit>
          </label>
          <label>Ore lucrate
            <input id="mOre" type="text" placeholder="8,0" data-edit>
          </label>
          <div></div>
        </div>

        <div class="err" id="mErr"></div>

        <div class="actions">
          <button class="btn" type="button" onclick="closeAddModal()">AnuleazÄƒ</button>
          <button class="btn primary" type="button" onclick="saveAddModal()" data-edit-btn>SalveazÄƒ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const STORAGE_KEY = "DEBITATE_autosave_v1";
  const LUNI = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];

  function storageAvailable(){
    try{
      const x = "__st__" + Math.random();
      localStorage.setItem(x, x);
      localStorage.removeItem(x);
      return true;
    } catch(e){
      return false;
    }
  }
  const CAN_STORE = storageAvailable();


  const COLUMNS = [
    { key:"an", label:"Anul", type:"year", align:"center" },
    { key:"luna", label:"Luna", type:"text" },
    { key:"data", label:"Data", type:"date" },
    { key:"echipament", label:"Echipament", type:"text" },
    { key:"reper", label:"Reper", type:"text" },
    { key:"diametru", label:"Diametru oÈ›el", type:"diam" },
    { key:"calitate", label:"CALITATE", type:"text" },
    { key:"kgBuc", label:"Kg/buc.", type:"dec2", align:"num" },
    { key:"lungime", label:"Lungime debitat mm", type:"int", align:"num" },
    { key:"sarja", label:"Sarja", type:"text" },
    { key:"planificat", label:"Plani\nficat", type:"int", align:"num" },
    { key:"cantitate", label:"Canti\ntate", type:"int", align:"num" },
    { key:"schimbul", label:"Schim\nbul", type:"int", align:"center" },
    { key:"totalKg", label:"total kg\ndebitat", type:"int", align:"num", readonly:true },
    { key:"weekNr", label:"week\nnr.", type:"int", align:"center", readonly:true },
    { key:"operator", label:"Operator", type:"text" },
    { key:"procentNorma", label:"Procent norma %", type:"pct", align:"center", readonly:true },
    { key:"oreLucrate", label:"Ore lucrate", type:"dec1", align:"center" }
  ];

  const COL_WIDTHS = {
    an: 58,
    luna: 78,
    data: 88,
    echipament: 86,
    reper: 86,
    diametru: 78,
    calitate: 104,
    kgBuc: 62,
    lungime: 86,
    sarja: 72,
    planificat: 70,
    cantitate: 70,
    schimbul: 54,
    totalKg: 84,
    weekNr: 54,
    operator: 96,
    procentNorma: 98,
    oreLucrate: 78
  };
  const ACTION_COL_W = 28;


  // ===== STATE =====
  let rows = [];
  let filters = null; // filters removed (add via modal only)
  let saveTimer = null;

  // ===== PAGING (performanÈ›Äƒ) =====
  const PAGE_SIZE = 200;
  let currentPage = 0;

  const $ = (id) => document.getElementById(id);
  const pillRows = $("pillRows");
  const pillTotalKg = $("pillTotalKg");
  const pillSave = $("pillSave");
  const pillPage = $("pillPage");
  const btnPrevPage = $("btnPrevPage");
  const btnNextPage = $("btnNextPage");


  // ===== HELPERE (din Excel) =====
  const HELPERS_KEY = "RF_HELPERS_v1";
  let _helpers = null;
  let _mapRepDebitare = null;

  function loadHelpers(){
    if (_helpers) return _helpers;
    try {
      const raw = localStorage.getItem(HELPERS_KEY);
      if (!raw) return null;
      _helpers = JSON.parse(raw);
      return _helpers;
    } catch(e) {
      console.warn("Helpere corupte / lipsÄƒ:", e);
      return null;
    }
  }

  function buildHelperMaps(){
    const h = loadHelpers();
    _mapRepDebitare = new Map();
    const dlR = $("dlRepereDebitare");
    const dlU = $("dlUtilajeDebitare");
    if (dlR) dlR.innerHTML = "";
    if (dlU) dlU.innerHTML = "";

    if (!h) return;

    // Repere debitare â†’ autofill
    (h.repere_debitare || []).forEach(row => {
      const k = (row.REPER_DEBITARE ?? "").toString().trim();
      if (!k) return;
      _mapRepDebitare.set(k, {
        reper: k,
        diam: row.DIAMETRU_OTEL,
        cal: (row.CALITATE_OTEL ?? "").toString().trim(),
        kgBuc: row.KG_BUC_DEBITAT,
        lung: row.LUNGIME_DEBITARE_MM
      });
    });

    if (dlR){
      Array.from(_mapRepDebitare.keys()).sort().forEach(k => {
        const o = document.createElement("option");
        o.value = k;
        dlR.appendChild(o);
      });
    }

    // Utilaje debitare (autocomplete)
    if (dlU){
      (h.utilaje_debitare || []).forEach(u => {
        const v = (u ?? "").toString().trim();
        if (!v) return;
        const o = document.createElement("option");
        o.value = v;
        dlU.appendChild(o);
      });
    }
  }

  // ReÃ®ncarcÄƒ helperele cÃ¢nd sunt modificate Ã®n pagina HELPER
  window.addEventListener('message', (ev) => {
    if (!ev || !ev.data) return;
    if (ev.data.type === 'HELPERS_UPDATED') {
      _helpers = null;
      _mapRepDebitare = null;
      try{ buildHelperMaps(); }catch(e){}
    }
  });

  function setAutofillReadonly(isReadonly){
    ["mDiam","mCal","mKgBuc","mLungime"].forEach(id => {
      const el = $(id);
      if (!el) return;
      if (isReadonly) el.setAttribute("readonly","readonly");
      else el.removeAttribute("readonly");
    });
  }

  function applyReperAutofill(){
    const override = $("mOverride")?.checked;
    if (override) return;
    if (!_mapRepDebitare) buildHelperMaps();
    const key = $("mReper")?.value?.trim();
    if (!key || !_mapRepDebitare || !_mapRepDebitare.has(key)) return;
    const info = _mapRepDebitare.get(key);

    if ($("mDiam")) $("mDiam").value = (info.diam ?? "") === "" ? "" : String(info.diam);
    if ($("mCal")) $("mCal").value = info.cal || "";

    // kg/buc: pÄƒstreazÄƒ virgula ca zecimal Ã®n UI
    if ($("mKgBuc")) {
      const n = Number(info.kgBuc);
      $("mKgBuc").value = Number.isFinite(n) ? String(n).replace(".", ",") : "";
    }

    // lungime: Ã®ntreg
    if ($("mLungime")) {
      const n = Number(info.lung);
      $("mLungime").value = Number.isFinite(n) ? String(Math.trunc(n)) : "";
    }
  }


  // ===== HELPERS =====
  function goMenu(){ goDashboard(); }

  function monthLower(s){
    return (s ?? "").toString().trim().toLowerCase();
  }

  function stripDia(s){
    return (s ?? "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeDiam(v){
    if (v == null) return "";
    let s = (""+v).trim();
    s = s.replace(/Ã˜/gi,"").replace(/\s+/g,"").replace(/mm$/i,"");
    return s;
  }

  // Parse number in RO-ish formats:
  // - "2.090" -> 2090  (thousands dot)
  // - "8,5" -> 8.5     (decimal comma)
  // - "1.234,56" -> 1234.56
  function parseNumberRO(v){
    if (v == null) return NaN;
    if (typeof v === "number") return v;
    let s = (""+v).trim();
    if (!s) return NaN;

    // remove spaces
    s = s.replace(/\s+/g,"");

    const hasComma = s.includes(",");
    if (hasComma){
      // treat commas as decimal; dots as thousands
      s = s.replace(/\./g,"").replace(",",".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    // if pattern is thousands with dots: 1.234 or 12.345.678
    if (/^\d{1,3}(\.\d{3})+$/.test(s)){
      const n = Number(s.replace(/\./g,""));
      return Number.isFinite(n) ? n : NaN;
    }

    // fallback normal
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtIntDots(n){
    if (!Number.isFinite(n)) return "";
    const sign = n < 0 ? "-" : "";
    n = Math.abs(Math.trunc(n));
    const s = String(n);
    return sign + s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function fmtDecComma(n, decimals){
    if (!Number.isFinite(n)) return "";
    const fixed = n.toFixed(decimals);
    // replace dot with comma
    let s = fixed.replace(".", ",");
    // trim trailing zeros if decimals>1
    if (decimals > 1){
      s = s.replace(/,0+$/,"");
      s = s.replace(/,(\d*[1-9])0+$/," ,$1").replace(" ","");
    }
    return s;
  }

  function fmtPct(n){
    if (!Number.isFinite(n)) return "";
    return String(Math.round(n)) + "%";
  }

  function parseDateAny(v){
    // Accept: yyyy-mm-dd, dd.mm.yyyy, dd/mm/yyyy, Excel Date serial
    if (v == null || v === "") return "";
    if (typeof v === "number"){
      // Excel serial date to JS date (1900 system)
      const excelEpoch = new Date(Date.UTC(1899,11,30));
      const d = new Date(excelEpoch.getTime() + v * 86400000);
      return toISODate(d);
    }
    const s = (""+v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m1 = s.match(/^([0-3]?\d)\.([01]?\d)\.(\d{4})$/);
    if (m1){
      const dd = m1[1].padStart(2,"0");
      const mm = m1[2].padStart(2,"0");
      const yy = m1[3];
      return `${yy}-${mm}-${dd}`;
    }
    const m2 = s.match(/^([0-3]?\d)\/([01]?\d)\/(\d{4})$/);
    if (m2){
      const dd = m2[1].padStart(2,"0");
      const mm = m2[2].padStart(2,"0");
      const yy = m2[3];
      return `${yy}-${mm}-${dd}`;
    }
    // last resort: Date parse
    const d = new Date(s);
    if (!isNaN(d.getTime())) return toISODate(d);
    return "";
  }

  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function fmtDateRO(iso){
    if (!iso) return "";
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return iso;
    return `${m[3]}.${m[2]}.${m[1]}`;
  }

  function isoWeekNumber(iso){
    if (!iso) return "";
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return "";
    const d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    // ISO week date weeks start on Monday
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function recalcRow(r){
    // normalize fields
    const y = parseNumberRO(r.an);
    if (Number.isFinite(y)) r.an = Math.trunc(y);
    if (r.luna != null) r.luna = monthLower(r.luna);
    if (r.data) r.data = parseDateAny(r.data);
    if (r.data){
      const yy2 = Number(r.data.slice(0,4));
      const mm2 = Number(r.data.slice(5,7));
      if (!r.an) r.an = yy2;
      if (!r.luna) r.luna = LUNI[mm2-1] || "";
    }

    const kgBuc = Number(r.kgBuc);
    const cant = Number(r.cantitate);
    if (Number.isFinite(kgBuc) && Number.isFinite(cant)){
      r.totalKg = Math.round(kgBuc * cant); // total kg as integer
    } else {
      r.totalKg = "";
    }
    r.weekNr = r.data ? isoWeekNumber(r.data) : "";
    const plan = Number(r.planificat);
    if (Number.isFinite(plan) && plan > 0 && Number.isFinite(cant)){
      r.procentNorma = Math.round((cant / plan) * 100);
    } else {
      r.procentNorma = "";
    }
    return r;
  }

  function scheduleSave(){
    if (!CAN_STORE){
      pillSave.textContent = "autosave: OFF (storage blocat)";
      return;
    }
    pillSave.textContent = "autosave: savingâ€¦";
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ rows }));
        pillSave.textContent = "autosave: saved";
      } catch(e){
        console.error(e);
        pillSave.textContent = "autosave: failed";
      }
    }, 350);
  }

  function load(){
    if (!CAN_STORE){
      pillSave.textContent = "autosave: OFF (storage blocat)";
      return;
    }
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try{
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed?.rows)) rows = parsed.rows;
      filters = null;
    } catch(e){}
  }

  function resetAll(){
    if (!confirm("È˜tergi toate datele DEBITATE salvate local?")) return;
    localStorage.removeItem(STORAGE_KEY);
    rows = [];
    filters = null;
    render();
    pillSave.textContent = "autosave: idle";
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify({ rows }, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `DEBITATE_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // ===== RENDER =====
  function buildHeader(){
    const hdr = $("hdr");
    const cg = $("colgroup");
    hdr.innerHTML = "";
    if (cg) cg.innerHTML = "";

    for (const col of COLUMNS){
      if (cg){
        const c = document.createElement("col");
        c.style.width = (COL_WIDTHS[col.key] || 90) + "px";
        cg.appendChild(c);
      }
      const th = document.createElement("th");
      th.textContent = col.label;
      hdr.appendChild(th);
    }

    // ACT (È™tergere)
    if (cg){
      const cA = document.createElement("col");
      cA.style.width = ACTION_COL_W + "px";
      cg.appendChild(cA);
    }
    const thA = document.createElement("th");
    thA.textContent = "ðŸ—‘";
    thA.title = "È˜tergere rÃ¢nd";
    hdr.appendChild(thA);
  }

  function matchFilter(r, col, value){
    if (!value) return true;
    const v = value.toString().trim().toLowerCase();
    if (!v) return true;

    let cell = r[col.key];
    if (col.type === "date"){
      cell = fmtDateRO(r.data);
    } else if (col.type === "diam"){
      cell = normalizeDiam(r.diametru);
    } else if (col.type === "int" || col.type === "dec2" || col.type === "dec1"){
      cell = String(r[col.key] ?? "");
    } else {
      cell = (r[col.key] ?? "").toString();
    }
    return cell.toLowerCase().includes(v);
  }

  function getFilteredRows(){
    const ySel = ($("fltYear")?.value || "").trim();
    const mSel = monthLower(($("fltMonth")?.value || "").trim());
    return rows.filter(r => {
      if (ySel && String(r.an ?? "").trim() !== ySel) return false;
      if (mSel && monthLower(r.luna) !== mSel) return false;
      return true;
    });
  }


  // ===== UI FILTERS (tabel) =====
  const MONTHS_RO = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];

  function uniqYears(){
    const ys = new Set();
    rows.forEach(r => {
      const y = (r.an ?? "").toString().trim();
      if (y) ys.add(y);
    });
    return Array.from(ys).sort((a,b)=> Number(a)-Number(b));
  }
  function uniqMonthsForYear(y){
    const ms = new Set();
    rows.forEach(r => {
      if (String(r.an ?? "").trim() !== String(y)) return;
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    // keep natural RO order when possible
    arr.sort((a,b)=> (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }
  function uniqMonthsAll(){
    const ms = new Set();
    rows.forEach(r => {
      const m = monthLower(r.luna);
      if (m) ms.add(m);
    });
    const arr = Array.from(ms);
    arr.sort((a,b)=> (MONTHS_RO.indexOf(a) - MONTHS_RO.indexOf(b)));
    return arr;
  }

  function setSelectOptions(sel, options, firstLabel){
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = firstLabel;
    sel.appendChild(opt0);
    options.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });
    // restore if possible
    if (options.includes(current)) sel.value = current;
    else sel.value = "";
  }

  function refreshFilterUI(preserve=true){
    const ySel = $("fltYear");
    const mSel = $("fltMonth");
    const years = uniqYears();
    if (!ySel || !mSel) return;

    const prevY = ySel.value;
    setSelectOptions(ySel, years, "(toÈ›i anii)");

    // restore year selection if desired
    if (preserve && years.includes(prevY)) ySel.value = prevY;
    else ySel.value = "";

    // months depend on year
    const months = ySel.value ? uniqMonthsForYear(ySel.value) : uniqMonthsAll();
    const prevM = mSel.value;
    setSelectOptions(mSel, months, "(toate lunile)");
    if (preserve && months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = "";
  }

  function applyUIFilters(){
    // filter affects only table view (and the pills)
  
  // pager handlers
  if (btnPrevPage) btnPrevPage.addEventListener("click", ()=>{ currentPage = Math.max(0, currentPage - 1); renderBody(); });
  if (btnNextPage) btnNextPage.addEventListener("click", ()=>{ currentPage = currentPage + 1; renderBody(); });

  renderBody();
  }

  function resetUIFilters(){
    if ($("fltYear")) $("fltYear").value = "";
    refreshFilterUI(true);
    applyUIFilters();
  }

  // ===== SUMMARY (independent) =====
  function refreshSummaryUI(preserve=true){
    const ySel = $("sumYear");
    const mSel = $("sumMonth");
    if (!ySel || !mSel) return;
    const years = uniqYears();
    const prevY = ySel.value;
    setSelectOptions(ySel, years, "(alege anul)");
    if (preserve && years.includes(prevY)) ySel.value = prevY;
    else {
      // default: last year if any
      ySel.value = years.length ? years[years.length-1] : "";
    }
    const months = ySel.value ? uniqMonthsForYear(ySel.value) : [];
    const prevM = mSel.value;
    setSelectOptions(mSel, months, "(toate lunile)");
    if (preserve && months.includes(monthLower(prevM))) mSel.value = monthLower(prevM);
    else mSel.value = "";
  }

  function refreshSummaryTable(){
    const body = $("sumBody");
    const y = ($("sumYear")?.value || "").trim();
    const m = monthLower(($("sumMonth")?.value || "").trim());
    if (!body) return;

    if (!y){
      body.innerHTML = '<tr><td colspan="5" class="center">SelecteazÄƒ Anul aici pentru a calcula sumarul.</td></tr>';
      return;
    }

    const bucket = new Map();
    for (const r of rows){
      if (String(r.an ?? "").trim() !== y) continue;
      if (m && monthLower(r.luna) !== m) continue;

      const reper = (r.reper ?? "").toString().trim();
      const diam = (r.diametru ?? "").toString().trim();
      const cal  = (r.calitate ?? "").toString().trim();

      const key = `${reper}|||${diam}|||${cal}`;
      const prev = bucket.get(key) || {reper, diam, cal, buc:0, kg:0};
      const buc = Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : parseNumberRO(r.cantitate);
      const kg  = Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : parseNumberRO(r.totalKg);
      prev.buc += Number.isFinite(buc) ? buc : 0;
      prev.kg  += Number.isFinite(kg) ? kg : 0;
      bucket.set(key, prev);
    }

    const arr = Array.from(bucket.values());
    arr.sort((a,b)=> (b.kg - a.kg));

    if (!arr.length){
      body.innerHTML = '<tr><td colspan="5" class="center">Nu existÄƒ date pentru anul/luna selectatÄƒ.</td></tr>';
      return;
    }

    body.innerHTML = "";
    for (const it of arr){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = it.reper || "(gol)";
      const td2 = document.createElement("td"); td2.textContent = it.diam || "(gol)";
      const td3 = document.createElement("td"); td3.textContent = it.cal || "(gol)";
      const td4 = document.createElement("td"); td4.className = "num"; td4.textContent = fmtIntDots(it.buc);
      const td5 = document.createElement("td"); td5.className = "num"; td5.textContent = fmtIntDots(it.kg);
      tr.append(td1,td2,td3,td4,td5);
      body.appendChild(tr);
    }
  }


  function renderBody(){
    const body = $("body");
    body.innerHTML = "";

    // normalize and recalc
    rows.forEach(r => recalcRow(r));

    const view = getFilteredRows();

    // paging
    const totalPages = Math.max(1, Math.ceil(view.length / PAGE_SIZE));
    if (autoScrollBottom) currentPage = totalPages - 1; // regula: pornire jos
    if (currentPage < 0) currentPage = 0;
    if (currentPage > totalPages - 1) currentPage = totalPages - 1;
    const start = currentPage * PAGE_SIZE;
    const end = Math.min(view.length, start + PAGE_SIZE);
    const slice = view.slice(start, end);
    if (pillPage) pillPage.textContent = `pagina ${currentPage+1}/${totalPages} (afiÈ™eazÄƒ ${start+1}-${end})`;
    pillRows.textContent = `${view.length} rÃ¢nduri (pagina: ${slice.length})`;
    const total = view.reduce((s, r) => s + (Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : 0), 0);
    pillTotalKg.textContent = `${fmtIntDots(total)} kg total`;

    for (let idx=0; idx<slice.length; idx++){
      const r = slice[idx];
      const tr = document.createElement("tr");

      for (const col of COLUMNS){
        const td = document.createElement("td");
        if (col.align === "num") td.classList.add("num");
        if (col.align === "center") td.classList.add("center");

        if (col.readonly){
          td.textContent = displayValue(r, col);
        } else {
          const inp = document.createElement("input");
          inp.className = "cellinput";
          if (col.type === "date"){
            inp.value = fmtDateRO(r.data);
          } else {
            inp.value = displayEditValue(r, col);
          }

          inp.addEventListener("blur", () => {
            const newVal = inp.value;
            applyCellEdit(r, col, newVal);
            recalcRow(r);
            scheduleSave();
        setTimeout(() => renderBody(), 0);
          });

          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter"){
              e.preventDefault();
              inp.blur();
            }
          });

          td.appendChild(inp);
        }
        tr.appendChild(td);
      }

      // actions
      const tdA = document.createElement("td");
      tdA.className = "center actCell";
      const wrap = document.createElement("div");
      wrap.className = "rowActions";

      const bDel = document.createElement("button");
      bDel.className = "iconbtn danger";
      bDel.textContent = "ðŸ—‘";
      bDel.title = "È˜terge";
      bDel.addEventListener("click", () => {
        if (!confirm("È˜tergi rÃ¢ndul selectat?")) return;
        const realIdx = rows.findIndex(x => x.id === r.id);
        if (realIdx >= 0) rows.splice(realIdx, 1);
        scheduleSave();
        setTimeout(() => renderBody(), 0);
      });

      wrap.appendChild(bDel);
      tdA.appendChild(wrap);
      tr.appendChild(tdA);

      body.appendChild(tr);
    }

    // auto-scroll: la deschidere È™i dupÄƒ adÄƒugare/import mergem jos
    if (autoScrollBottom){
      const tw = $("tablewrap");
      if (tw){ tw.scrollTop = tw.scrollHeight; tw.scrollLeft = tw.scrollWidth; }
      autoScrollBottom = false;
    }
  }

  function displayValue(r, col){
    const v = r[col.key];
    if (col.type === "date") return fmtDateRO(r.data);
    if (col.type === "diam"){
      const d = normalizeDiam(v);
      return d ? "Ã˜ " + d : "";
    }
    if (col.type === "year"){
      const n = Number(v);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (v ?? "");
    }
    if (col.type === "int"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtIntDots(n) : (v ?? "");
    }
    if (col.type === "dec2"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (v ?? "");
    }
    if (col.type === "dec1"){
      const n = Number(v);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (v ?? "");
    }
    if (col.type === "pct"){
      const n = Number(v);
      return Number.isFinite(n) ? (String(Math.round(n)) + "%") : (v ?? "");
    }
    return (v ?? "").toString();
  }

  function displayEditValue(r, col){
    // Pentru coloane numerice editabile, afiÈ™Äƒm formatat (mii cu .), dar salvÄƒm numeric.
    if (col.type === "year"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? String(Math.trunc(n)) : (r[col.key] ?? "");
    }
    if (col.type === "int"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtIntDots(n) : (r[col.key] ?? "");
    }
    if (col.type === "dec2"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 2) : (r[col.key] ?? "");
    }
    if (col.type === "dec1"){
      const n = Number(r[col.key]);
      return Number.isFinite(n) ? fmtDecComma(n, 1) : (r[col.key] ?? "");
    }
    if (col.type === "diam"){
      const d = normalizeDiam(r[col.key]);
      return d ? "Ã˜ " + d : "";
    }
    return (r[col.key] ?? "").toString();
  }

  function applyCellEdit(r, col, raw){
    if (col.type === "date"){
      r.data = parseDateAny(raw);
      // also update an/luna if missing
      if (r.data){
        const [y,m] = r.data.split("-");
        if (!r.an) r.an = Number(y);
        if (!r.luna) r.luna = LUNI[Number(m)-1] || "";
      }
      return;
    }
    if (col.type === "diam"){
      r.diametru = normalizeDiam(raw);
      return;
    }
    if (col.type === "year"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : "";
      return;
    }
    if (col.type === "int"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? Math.trunc(n) : "";
      return;
    }
    if (col.type === "dec2"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : "";
      return;
    }
    if (col.type === "dec1"){
      const n = parseNumberRO(raw);
      r[col.key] = Number.isFinite(n) ? n : "";
      return;
    }
    // text
    r[col.key] = (raw ?? "").toString().trim();
    if (col.key === "luna") r.luna = monthLower(r.luna);
  }

  // ===== CRUD =====
  // ===== ADD (modal) =====
  let autoScrollBottom = true;

  function openAddModal(){
    // defaults
    const d = new Date();
    const iso = toISODate(d);
    $("mData").value = iso;
    $("mAn").value = String(d.getFullYear());
    $("mLuna").value = LUNI[d.getMonth()];
    $("mEchip").value = "";
    $("mOverride").checked = false;
    setAutofillReadonly(true);
    buildHelperMaps();
    $("mReper").value = "";
    $("mDiam").value = "";
    $("mCal").value = "";
    $("mKgBuc").value = "";
    $("mLungime").value = "";
    $("mSarja").value = "";
    $("mPlan").value = "";
    $("mCant").value = "";
    $("mSchimb").value = "1";
    $("mOper").value = "";
    $("mOre").value = "8,0";
    $("mErr").textContent = "";
    $("modalBack").classList.remove("hidden");
    setTimeout(()=>$("mEchip").focus(), 0);
  }

  function closeAddModal(){
    $("modalBack").classList.add("hidden");
  }

  function syncAnLunaFromDate(){
    const iso = parseDateAny($("mData").value);
    if (!iso) return;
    const y = iso.slice(0,4);
    const m = Number(iso.slice(5,7));
    $("mAn").value = y;
    $("mLuna").value = LUNI[m-1] || "";
  }

  function saveAddModal(){
    const err = [];
    const dataIso = parseDateAny($("mData").value);
    if (!dataIso) err.push("Data este obligatorie.");
    const echip = $("mEchip").value.trim();
    // dacÄƒ e selectat reper din helper, completeazÄƒ automat Ã®nainte de validare
    applyReperAutofill();
    const reper = $("mReper").value.trim();
    const diam = normalizeDiam($("mDiam").value);
    const cal = $("mCal").value.trim();
    const kgBuc = parseNumberRO($("mKgBuc").value);
    const lung = parseNumberRO($("mLungime").value);
    const sarja = $("mSarja").value.trim();
    const plan = parseNumberRO($("mPlan").value);
    const cant = parseNumberRO($("mCant").value);
    const schimb = parseNumberRO($("mSchimb").value);
    const oper = $("mOper").value.trim();
    const ore = parseNumberRO($("mOre").value);

    if (!echip) err.push("Echipament este obligatoriu.");
    if (!reper) err.push("Reper este obligatoriu.");
    if (!diam) err.push("Diametru este obligatoriu.");
    if (!cal) err.push("Calitate este obligatorie.");
    if (!Number.isFinite(kgBuc)) err.push("Kg/buc este obligatoriu.");
    if (!Number.isFinite(lung)) err.push("Lungime debitat este obligatorie.");
    if (!sarja) err.push("Sarja este obligatorie.");
    if (!Number.isFinite(cant)) err.push("Cantitate este obligatorie.");
    if (!Number.isFinite(schimb)) err.push("Schimbul este obligatoriu.");
    if (!oper) err.push("Operator este obligatoriu.");

    if (err.length){
      $("mErr").textContent = err.join(" ");
      return;
    }

    const y = Number(dataIso.slice(0,4));
    const m = Number(dataIso.slice(5,7));

    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)),
      an: y,
      luna: LUNI[m-1] || "",
      data: dataIso,
      echipament: echip,
      reper: reper,
      diametru: diam,
      calitate: cal,
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : "",
      lungime: Number.isFinite(lung) ? Math.trunc(lung) : "",
      sarja: sarja,
      planificat: Number.isFinite(plan) ? Math.trunc(plan) : "",
      cantitate: Math.trunc(cant),
      schimbul: Math.trunc(schimb),
      totalKg: "",
      weekNr: isoWeekNumber(dataIso),
      operator: oper,
      procentNorma: "",
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };

    recalcRow(r);
    rows.push(r);

    // Keep insertion order; always append at the bottom
    autoScrollBottom = true;
    scheduleSave();
    setTimeout(() => renderBody(), 0);
    closeAddModal();
  }

  // ===== XLSX =====
  async function ensureXLSX(){
    if (window.XLSX) return true;

    // try load local first, relative to parent file
    const localUrl = new URL("xlsx.full.min.js", (parent.location.href.split("#")[0].split("?")[0])).href;

    try{
      await loadScript(localUrl);
      if (window.XLSX) return true;
    } catch(e){}

    // fallback CDN
    try{
      await loadScript("https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js");
      return !!window.XLSX;
    } catch(e){
      alert("Nu pot Ã®ncÄƒrca librÄƒria XLSX. Pune fiÈ™ierul xlsx.full.min.js lÃ¢ngÄƒ HTML (offline) sau porneÈ™te internet.");
      return false;
    }
  }

  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement("script");
      s.src = src;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error("Failed " + src));
      document.head.appendChild(s);
    });
  }

  function exportXLSX(){
    ensureXLSX().then(ok=>{
      if (!ok) return;

      // export all rows (not filtered)
      const data = rows.map(r => ({
        "Anul": r.an,
        "Luna": r.luna,
        "Data": fmtDateRO(r.data),
        "Echipament": r.echipament,
        "Reper": r.reper,
        "Diametru oÈ›el": normalizeDiam(r.diametru) ? ("Ã˜ " + normalizeDiam(r.diametru)) : "",
        "CALITATE": r.calitate,
        "Kg/buc.": Number.isFinite(Number(r.kgBuc)) ? Number(r.kgBuc) : "",
        "Lungime debitat mm": Number.isFinite(Number(r.lungime)) ? Number(r.lungime) : "",
        "Sarja": r.sarja,
        "Planificat": Number.isFinite(Number(r.planificat)) ? Number(r.planificat) : "",
        "Cantitate": Number.isFinite(Number(r.cantitate)) ? Number(r.cantitate) : "",
        "Schimbul": Number.isFinite(Number(r.schimbul)) ? Number(r.schimbul) : "",
        "total kg debitat": Number.isFinite(Number(r.totalKg)) ? Number(r.totalKg) : "",
        "week nr.": Number.isFinite(Number(r.weekNr)) ? Number(r.weekNr) : "",
        "Operator": r.operator,
        "Procent norma %": Number.isFinite(Number(r.procentNorma)) ? Number(r.procentNorma) : "",
        "Ore lucrate": Number.isFinite(Number(r.oreLucrate)) ? Number(r.oreLucrate) : ""
      }));

      const ws = XLSX.utils.json_to_sheet(data, { skipHeader:false });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DEBITATE");
      const name = `DEBITATE_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    });
  }

  function importXLSX(){
    ensureXLSX().then(ok=>{
      if (!ok) return;

      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = ".xlsx,.xls";
      inp.addEventListener("change", async () => {
        const file = inp.files && inp.files[0];
        if (!file) return;
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type:"array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { defval:"" });

        // map headers flexibly
        const mapped = raw.map(obj => mapRowFromExcel(obj)).filter(Boolean);
        if (!mapped.length){
          alert("Nu am gÄƒsit rÃ¢nduri importabile.");
          return;
        }

        // merge: append
        rows = mapped.concat(rows);
        // recalc + sort by date desc
        rows.forEach(r => recalcRow(r));
        rows.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
        autoScrollBottom = true;
        scheduleSave();
        setTimeout(() => renderBody(), 0);
      });
      inp.click();
    });
  }

  function getAny(obj, keys){
    for (const k of keys){
      if (k in obj) return obj[k];
      // case-insensitive match
      const found = Object.keys(obj).find(h => stripDia(h).toLowerCase() === stripDia(k).toLowerCase());
      if (found) return obj[found];
    }
    return "";
  }

  function mapRowFromExcel(obj){
    // headers variants
    const an = parseNumberRO(getAny(obj, ["Anul","An","An intrare"])) ;
    const luna = monthLower(getAny(obj, ["Luna","LUNA","Luna intrare"]));
    const dataIso = parseDateAny(getAny(obj, ["Data","Data Intrare","Data intrare"]));
    const ech = getAny(obj, ["Echipament","Echipament (utilajul de debitare)","Utilaj"]);
    const reper = getAny(obj, ["Reper","Denumire reper debitare"]);
    const diam = normalizeDiam(getAny(obj, ["Diametru oÈ›el","Diametru otel","Diametrul oÈ›elului","Diametru oÈ›elului"]));
    const cal = getAny(obj, ["CALITATE","Calitate","Calitatea oÈ›elului"]);
    const kgBuc = parseNumberRO(getAny(obj, ["Kg/buc.","Kg/buc","Kg/buc.","Kg/bucÄƒ","Kg/buc (kg/buc)"]));
    const lungime = parseNumberRO(getAny(obj, ["Lungime debitat mm","Lungime debitat","Lungime debitat (mm)"]));
    const sarja = getAny(obj, ["Sarja","SarjÄƒ","Sarja material","Sarja materialului"]);
    const planificat = parseNumberRO(getAny(obj, ["Planificat","Planificat (buc)"]));
    const cant = parseNumberRO(getAny(obj, ["Cantitate","Cantitate (buc)","Cantitate buc"]));
    const schimb = parseNumberRO(getAny(obj, ["Schimbul","Schimb"]));
    const operator = getAny(obj, ["Operator"]);
    const ore = parseNumberRO(getAny(obj, ["Ore lucrate","Ore"]));
    // allow total kg / week / procent but we recalc anyway
    const r = {
      id: crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)),
      an: Number.isFinite(an) ? Math.trunc(an) : (dataIso ? Number(dataIso.slice(0,4)) : ""),
      luna: luna || (dataIso ? LUNI[Number(dataIso.slice(5,7))-1] : ""),
      data: dataIso,
      echipament: (ech ?? "").toString().trim(),
      reper: (reper ?? "").toString().trim(),
      diametru: diam,
      calitate: (cal ?? "").toString().trim(),
      kgBuc: Number.isFinite(kgBuc) ? kgBuc : "",
      lungime: Number.isFinite(lungime) ? Math.trunc(lungime) : "",
      sarja: (sarja ?? "").toString().trim(),
      planificat: Number.isFinite(planificat) ? Math.trunc(planificat) : "",
      cantitate: Number.isFinite(cant) ? Math.trunc(cant) : "",
      schimbul: Number.isFinite(schimb) ? Math.trunc(schimb) : "",
      totalKg: "",
      weekNr: "",
      operator: (operator ?? "").toString().trim(),
      procentNorma: "",
      oreLucrate: Number.isFinite(ore) ? ore : 8.0
    };
    recalcRow(r);
    // require minimal fields
    if (!r.data && !r.an) return null;
    return r;
  }

  // ===== INIT =====
  function render(){
    buildHeader();
    refreshFilterUI(true);
    refreshSummaryUI(true);
    renderBody();
    refreshSummaryTable();
  }

  (function init(){
    load();
    // UI: filtre + sumar
    const _fy = $("fltYear");
    const _fm = $("fltMonth");
    if (_fy) _fy.addEventListener("change", () => { refreshFilterUI(true); applyUIFilters(); });
    if (_fm) _fm.addEventListener("change", () => { applyUIFilters(); });

    const _sy = $("sumYear");
    const _sm = $("sumMonth");
    if (_sy) _sy.addEventListener("change", () => { refreshSummaryUI(true); refreshSummaryTable(); });
    if (_sm) _sm.addEventListener("change", () => { refreshSummaryTable(); });

    // iniÈ›ializeazÄƒ helperele (repere/utilaje) pentru autocomplete + autofill
    buildHelperMaps();
    const _mr = $("mReper"); if (_mr) _mr.addEventListener("input", applyReperAutofill);
    const _ov = $("mOverride"); if (_ov) _ov.addEventListener("change", () => { setAutofillReadonly(!_ov.checked); if(!_ov.checked) applyReperAutofill(); });

    // normalize months
    rows.forEach(r => {
      r.luna = monthLower(r.luna);
      r.diametru = normalizeDiam(r.diametru);
      r.data = parseDateAny(r.data);
      // fix year like "2.026" -> 2026
      const _y = parseNumberRO(r.an);
      if (Number.isFinite(_y)) r.an = Math.trunc(_y);
      recalcRow(r);
    });
    rows.sort((a,b)=> (a.data||"").localeCompare(b.data||""));
    autoScrollBottom = true;
    render();
    // resave normalized
    if (rows.length) scheduleSave();
  })();
  // ===== Cloud Sync helpers (compat INTRARI_OTEL) =====
  window.APP_KEYS = window.APP_KEYS || {};
  window.APP_KEYS.debitate = STORAGE_KEY;

  // canonical payload for cloud
  window.getAllDataForExport = function(){
    return { app:"DEBITATE", version:1, savedAt: new Date().toISOString(), rows: Array.isArray(rows) ? rows : [] };
  };

  // apply payload into UI + local autosave
  window.loadFromPayload = function(payload){
    // edit-safe: if user is editing an input, don't re-render now
    const ae = document.activeElement;
    if(ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.tagName==='SELECT')) return false;

    try{
      if(payload && Array.isArray(payload.rows)){
        rows = payload.rows;

        // normalize like init
        rows.forEach(r => {
          r.luna = monthLower(r.luna);
          r.diametru = normalizeDiam(r.diametru);
          r.data = parseDateAny(r.data);
          const _y = parseNumberRO(r.an);
          if (Number.isFinite(_y)) r.an = Math.trunc(_y);
          recalcRow(r);
        });
        rows.sort((a,b)=> (a.data||"").localeCompare(b.data||""));

        autoScrollBottom = true;
        if(typeof render === "function") render();
        else if(typeof renderBody === "function") renderBody();

        // persist local snapshot
        try{ scheduleSave(); }catch(_e){}
        return true;
      }
    }catch(e){
      console.warn("loadFromPayload failed", e);
    }
    return false;
  };

  // bridge: any scheduleSave implies data changed (so cloud sync can push)
  window.notifyDataChanged = window.notifyDataChanged || function(){};
  (function(){
    const _orig = scheduleSave;
    if(typeof _orig === "function"){
      scheduleSave = function(){
        const r = _orig.apply(this, arguments);
        try{ window.notifyDataChanged(); }catch(_e){}
        return r;
      }
    }
  })();</script>

  <datalist id="dlRepereDebitare"></datalist>
  <datalist id="dlUtilajeDebitare"></datalist>

<script>


/* ===============================
   RF AUTH + ROLE (profiles)
   - admin / editor / viewer
   - viewer: read-only (dar export OK)
   - editor: edit in celule
   - admin: edit + vede butoanele de admin
   =============================== */
(function(){
  const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // Anon Key (Legacy)

  const roleBadge = document.getElementById('roleBadge');
  let roleText  = document.getElementById('roleText');
  let roleDot   = document.getElementById('roleDot');
  const cloudBadge = document.getElementById('cloudBadge');

  // ensure badge structure exists (backward compatible)
  if(roleBadge && (!roleText || !roleDot)){
    roleBadge.innerHTML = '<span id="roleDot" class="roleDot"></span><span id="roleText"></span>';
    roleText = document.getElementById('roleText');
    roleDot  = document.getElementById('roleDot');
  }

  // init supabase
  const supa = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } })
    : null;

  if(!supa){
    if(cloudBadge){ cloudBadge.style.display='inline-flex'; cloudBadge.classList.add('off'); cloudBadge.textContent='Cloud: client indisponibil'; }
    return;
  }
  window.__SUPA__ = supa;

  async function loadRole(){
    const { data: { user } } = await supa.auth.getUser();
    if(!user) return { role:'viewer', user:null, email:'' };
    try{
      const { data, error } = await supa.from('profiles').select('role').eq('id', user.id).maybeSingle();
      if(error) throw error;
      const role = (data && data.role) ? String(data.role) : 'viewer';
      return { role, user, email: user.email || '' };
    }catch(e){
      console.warn('role lookup failed', e);
      return { role:'viewer', user, email: user.email || '' };
    }
  }

  function applyRole(role, email){
    window.__APP_ROLE__ = role;
    const canEdit = (role === 'admin' || role === 'editor');
    window.__CAN_EDIT__ = canEdit;

    if(roleBadge){
      roleBadge.style.display='inline-flex';
      if(roleText) roleText.textContent = role.toUpperCase() + (role==='viewer' ? ' (read-only)' : '') + (email ? ' â€¢ ' + email : '');
      else roleBadge.textContent = 'ROL: ' + role.toUpperCase() + (email ? ' â€¢ ' + email : '');
    }
    if(roleDot) roleDot.classList.toggle('viewer', role==='viewer');

    // viewer: lock editing in table inputs + modal inputs
    document.querySelectorAll('#tbl input, #tbl select, #tbl textarea, [data-edit]').forEach(el=>{
      try{ el.disabled = !canEdit; }catch(_e){}
    });
  }

  loadRole().then(({
    role, email
  })=>applyRole(role, email));
})();
</script>

<script>
/* ===============================
   RF CLOUD SYNC (rf_documents)
   - doc_key = 'debitate'
   - auto push on changes (debounce)
   - auto pull polling (edit-safe + protectie "local pending")
   =============================== */
(function(){
  const supa = window.__SUPA__;
  const cloudBadge = document.getElementById('cloudBadge');
  if(!supa){
    if(cloudBadge){ cloudBadge.style.display='inline-flex'; cloudBadge.classList.add('off'); cloudBadge.textContent='Cloud: client indisponibil'; }
    return;
  }

  const DOC_TABLE = 'rf_documents';
  const DOC_KEY = 'debitate';

  let lastPulledAt = null;
  let lastPushedAt = null;
  let lastLocalChangeAt = null;   // ISO string
  let dirty = false;

  let pollTimer = null;
  let pushTimer = null;
  let inFlightPull = false;

  function setCloud(ok, msg){
    if(!cloudBadge) return;
    cloudBadge.style.display='inline-flex';
    cloudBadge.classList.toggle('off', !ok);
    cloudBadge.textContent = msg || (ok ? 'Cloud: ON' : 'Cloud: eroare');
  }
  function nowIso(){ return new Date().toISOString(); }

  function markDirty(){
    dirty = true;
    lastLocalChangeAt = nowIso();
  }

  function canPush(){
    // Prefer ACL if present; fallback to role flag
    const acl = window.__RF_ACL_CURRENT__;
    if(acl && typeof acl.can_edit_data === 'boolean') return !!acl.can_edit_data;
    if(typeof window.__CAN_EDIT__ === 'boolean') return window.__CAN_EDIT__;
    return null; // unknown yet (role/acl not loaded)
  }

  function getPayload(){
    try{
      if(window.getAllDataForExport) return window.getAllDataForExport();
    }catch(_e){}
    try{
      const k = (window.APP_KEYS && window.APP_KEYS.debitate) ? window.APP_KEYS.debitate : 'DEBITATE_autosave_v1';
      const raw = localStorage.getItem(k);
      return raw ? JSON.parse(raw) : { rows:[] };
    }catch(_e){ return { rows:[] }; }
  }

  function applyPayload(payload){
    const ae = document.activeElement;
    if(ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.tagName==='SELECT')){
      return false;
    }
    try{
      if(window.loadFromPayload){
        return !!window.loadFromPayload(payload);
      }
    }catch(e){}

    try{
      const k = (window.APP_KEYS && window.APP_KEYS.debitate) ? window.APP_KEYS.debitate : 'DEBITATE_autosave_v1';
      localStorage.setItem(k, JSON.stringify(payload || {}));
      if(window.load) window.load();
      if(window.render) window.render();
      return true;
    }catch(_e){}
    return false;
  }

  function isCloudNewer(ts){
    if(!ts) return true;

    // deja aplicat / mai vechi
    if(lastPulledAt && new Date(ts) <= new Date(lastPulledAt)) return false;
    // am Ã®mpins ceva mai nou
    if(lastPushedAt && new Date(ts) <= new Date(lastPushedAt)) return false;

    // PROTECÈšIE: dacÄƒ avem modificÄƒri locale mai noi decÃ¢t cloud-ul, NU suprascrie
    if(dirty && lastLocalChangeAt && new Date(ts) < new Date(lastLocalChangeAt)) return false;

    return true;
  }

  async function pull(){
    if(inFlightPull) return;
    inFlightPull = true;
    try{
      const { data, error } = await supa
        .from(DOC_TABLE)
        .select('doc_key,data,updated_at')
        .eq('doc_key', DOC_KEY)
        .maybeSingle();

      if(error) throw error;

      if(!data || !data.data){
        setCloud(true, dirty ? 'Cloud: ON (local pending)' : 'Cloud: gol');
        return;
      }

      const ts = data.updated_at || null;

      if(!isCloudNewer(ts)){
        setCloud(true, dirty ? 'Cloud: ON (local pending)' : 'Cloud: ON');
        return;
      }

      const applied = applyPayload(data.data);
      if(applied){
        lastPulledAt = ts || nowIso();
      }
      setCloud(true,'Cloud: ON');
    }catch(e){
      console.error(e);
      setCloud(false,'Cloud: eroare');
    }finally{
      inFlightPull = false;
    }
  }

  async function pushNow(){
    const can = canPush();

    // dacÄƒ nu e Ã®ncÄƒ Ã®ncÄƒrcat rolul/acl-ul, Ã®ncearcÄƒ din nou imediat (fÄƒrÄƒ sÄƒ pierzi local)
    if(can === null){
      setCloud(true,'Cloud: aÈ™tept rol...');
      setTimeout(()=>schedulePush(true), 400);
      return;
    }

    // read-only: pÄƒstreazÄƒ local, dar nu Ã®ncerca sÄƒ scrii
    if(can === false){
      setCloud(true,'Cloud: read-only');
      return;
    }

    try{
      const payload = getPayload();
      const up = { doc_key: DOC_KEY, data: payload, updated_at: nowIso() };
      const { error } = await supa.from(DOC_TABLE).upsert(up, { onConflict:'doc_key' });
      if(error) throw error;

      lastPushedAt = up.updated_at;
      dirty = false;
      setCloud(true,'Cloud: ON');
    }catch(e){
      console.error(e);
      const code = String(e?.code || e?.status || '');
      const msg =
        (code.includes('42501') || code.includes('401') || code.includes('403'))
          ? 'Cloud: fÄƒrÄƒ drept de scriere'
          : 'Cloud: eroare';
      // IMPORTANT: pÄƒstrÄƒm dirty=true ca pull sÄƒ NU È™teargÄƒ rÃ¢ndul local
      setCloud(false, msg);
    }
  }

  function schedulePush(forceOnly){
    if(!forceOnly) markDirty();
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(pushNow, 500);
  }

  // Hook Ã®n semnalul existent de "data changed"
  window.notifyDataChanged = (function(orig){
    return function(){
      try{ if(typeof orig === 'function') orig(); }catch(_e){}
      schedulePush(false);
    };
  })(window.notifyDataChanged);

  // È™i pe input (edit celule)
  document.addEventListener('input', ()=>{ schedulePush(false); }, true);

  // start
  setCloud(true,'Cloud: conectare...');
  pull();
  pollTimer = setInterval(pull, 2500);
})();
</script>
</script>

<script>
/* ===== ACL (rf_acl) integration ===== */
async function rfGetMyRole(supa){
  const { data: s } = await supa.auth.getSession();
  const sess = s?.session;
  if(!sess) return { role:"viewer", email:"" };
  const email = sess.user?.email || "";
  const { data } = await supa.from("profiles").select("role").eq("id", sess.user.id).maybeSingle();
  return { role: (data?.role || "viewer"), email };
}
async function rfGetAcl(supa, pageKey, role){
  const { data, error } = await supa.from("rf_acl").select("*").eq("page_key", pageKey).eq("role", role).maybeSingle();
  if(error) throw error;
  return data || {
    can_view:true, can_edit_data:false,
    show_import_buttons:false, show_add_buttons:false, show_delete_buttons:false, show_reset_buttons:false,
    can_export:true, can_filter:true, can_sync_cloud:false
  };
}
function rfApplyAclToUi(acl){
  window.__RF_ACL_CURRENT__ = acl;

  const map = { import:"show_import_buttons", add:"show_add_buttons", delete:"show_delete_buttons", reset:"show_reset_buttons",
                export:"can_export", filter:"can_filter", sync:"can_sync_cloud" };
  document.querySelectorAll("[data-acl]").forEach(el=>{
    const key = el.getAttribute("data-acl");
    const prop = map[key];
    if(!prop) return;
    const allowed = !!acl[prop];
    el.style.display = allowed ? "" : "none";
  });

  // edit lock (modal + dynamic table inputs)
  const canEdit = !!acl.can_edit_data;
  document.querySelectorAll("[data-edit]").forEach(el=>{
    try{ el.disabled = !canEdit; }catch(_e){}
  });
  document.querySelectorAll("#tbl input.cellinput").forEach(el=>{
    try{ el.disabled = !canEdit; }catch(_e){}
  });
  // delete buttons in table
  document.querySelectorAll("#tbl .iconbtn, #tbl .rowActions").forEach(el=>{
    el.style.display = (canEdit && !!acl.show_delete_buttons) ? "" : "none";
  });
}
async function rfBootAcl({ supa, pageKey, onRoleBadge }){
  const me = await rfGetMyRole(supa);
  const acl = await rfGetAcl(supa, pageKey, me.role);
  if(!acl.can_view){
    window.location.href = "index.html";
    return null;
  }
  if(onRoleBadge) onRoleBadge(me.role, me.email);
  rfApplyAclToUi(acl);
  return { me, acl };
}

// re-apply ACL after every dynamic renderBody
(function(){
  const _origRenderBody = window.renderBody;
  if(typeof _origRenderBody === "function"){
    window.renderBody = function(){
      const r = _origRenderBody.apply(this, arguments);
      try{ if(window.__RF_ACL_CURRENT__) rfApplyAclToUi(window.__RF_ACL_CURRENT__); }catch(_e){}
      return r;
    }
  }
  // Guard openAddModal/saveAddModal if no edit permission
  const _open = window.openAddModal;
  if(typeof _open === "function"){
    window.openAddModal = function(){
      if(window.__RF_ACL_CURRENT__ && !window.__RF_ACL_CURRENT__.can_edit_data) return;
      return _open.apply(this, arguments);
    }
  }
  const _save = window.saveAddModal;
  if(typeof _save === "function"){
    window.saveAddModal = function(){
      if(window.__RF_ACL_CURRENT__ && !window.__RF_ACL_CURRENT__.can_edit_data) return;
      return _save.apply(this, arguments);
    }
  }
})();

window.addEventListener("load", async ()=>{
  try{
    const supa = window.__SUPA__;
    if(!supa) return;

    await rfBootAcl({
      supa,
      pageKey:"debitate",
      onRoleBadge:(role,email)=>{
        // keep existing role badge; RF AUTH already populates it
      }
    });
  }catch(e){
    console.warn("ACL boot", e);
  }
});

<script>
/* RF HELPERS CLOUD PULL
   - doc_key = 'helpers'
   - scrie Ã®n localStorage RF_HELPERS_v1
   - declanÈ™eazÄƒ rebuild datalist/autofill prin HELPERS_UPDATED
*/
(function(){
  const supa = window.__SUPA__;
  if(!supa) return;

  const DOC_TABLE = 'rf_documents';
  const DOC_KEY = 'helpers';
  const LS_KEY = 'RF_HELPERS_v1';
  let lastTs = null;

  async function pull(){
    try{
      const { data, error } = await supa
        .from(DOC_TABLE)
        .select('data,updated_at')
        .eq('doc_key', DOC_KEY)
        .maybeSingle();

      if(error) throw error;
      if(!data || !data.data) return;

      const ts = data.updated_at || null;
      if(lastTs && ts && new Date(ts) <= new Date(lastTs)) return;

      lastTs = ts || new Date().toISOString();
      localStorage.setItem(LS_KEY, JSON.stringify(data.data));

      // declanÈ™eazÄƒ mecanismul deja existent Ã®n DEBITATE
      window.postMessage({ type:'HELPERS_UPDATED' }, '*');
    }catch(e){
      console.warn("Helpers pull failed:", e);
    }
  }

  pull();
  setInterval(pull, 5000);
})();
</script>
</script>

</body>
</html>
