<!DOCTYPE html>

<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Dashboard • Raport Forjă</title>
<meta content="#0b1020" name="theme-color"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0b1020;
  --border:rgba(165,184,210,.18);
  --text:#eaf0ff;
  --muted:#a7b6d6;

  --glow1: rgba(99, 179, 237, .18);
  --glow2: rgba(129, 230, 217, .12);
  --glow3: rgba(190, 227, 248, .08);

  --shadow: 0 18px 45px rgba(0,0,0,.32);
  --radius: 18px;
  --ok:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1200px 650px at 15% -10%, var(--glow1), transparent 60%),
    radial-gradient(1000px 600px at 105% 0%, var(--glow2), transparent 55%),
    radial-gradient(900px 500px at 50% 120%, var(--glow3), transparent 60%),
    linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
}

.shell{max-width:1100px;margin:0 auto;padding:20px 14px 24px;}

.header{
  border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(20,28,52,.70), rgba(13,19,38,.70));
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
  border-radius: 20px;
  padding:12px 12px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.title{
  font-size:18px;
  font-weight:1000;
  letter-spacing:.2px;
  padding:6px 10px;
}
.spacer{flex:1}

.pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{
  border:1px solid var(--border);
  background:rgba(10,14,30,.35);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  white-space:nowrap;
}
.pill.ok{border-color: rgba(34,197,94,.35); color:#bbf7d0;}
.pill.warn{border-color: rgba(245,158,11,.35); color:#fde68a;}
.pill.bad{border-color: rgba(239,68,68,.35); color:#fecaca;}

.btnTop{
  border-radius: 12px;
  border:1px solid var(--border);
  background:rgba(10,14,30,.35);
  color:var(--text);
  font-weight:900;
  padding:8px 12px;
  cursor:pointer;
}
.btnTop.primary{
  border-color: rgba(99,179,237,.35);
  background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
}
.btnTop:disabled{opacity:.55;cursor:not-allowed}

.menu{
  margin-top:14px;
  display:grid;
  grid-template-columns: 1fr 1.3fr;
  gap:12px;
  align-items:start;
}

/* Left column */
.left{
  border:1px solid var(--border);
  border-radius: 20px;
  background: linear-gradient(180deg, rgba(20,28,52,.55), rgba(13,19,38,.55));
  box-shadow: var(--shadow);
  padding:10px;
}

.item{ position:relative; margin:8px 0; }

.btn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  color:var(--text);
  font-weight:950;
  letter-spacing:.25px;
  border-radius: var(--radius);
  border:1px solid var(--border);
  background:
    radial-gradient(140px 140px at 15% 10%, rgba(99,179,237,.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0)),
    rgba(10,14,30,.35);
  padding:16px 14px;
  min-height:66px;
  transition:.18s ease;
  user-select:none;
  cursor:pointer;
}
.btn:hover{ transform: translateY(-1px); border-color: rgba(99,179,237,.45); }
.btn:active{ transform: translateY(0); }
.btn.disabled{ opacity:.55; cursor:not-allowed; transform:none !important; }

/* Right panel */
.right{
  border:1px solid var(--border);
  border-radius: 20px;
  background: linear-gradient(180deg, rgba(20,28,52,.55), rgba(13,19,38,.55));
  box-shadow: var(--shadow);
  padding:10px;
  min-height: 420px;
}
.hint{ color: var(--muted); font-size: 12px; padding: 10px 12px; }

/* Submenus */
.subpanel{
  display:none;
  border:1px solid var(--border);
  border-radius: 18px;
  background: rgba(10,14,30,.35);
  padding:10px;
}
.subpanel.active{ display:block; }

.subgrid-4{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}
.subbtn{
  display:flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  color:var(--text);
  font-weight:900;
  letter-spacing:.2px;
  border-radius: 16px;
  border:1px solid var(--border);
  background:
    linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
    rgba(2,6,23,.28);
  padding:14px 12px;
  min-height:62px;
  transition:.18s ease;
}
.subbtn:hover{ transform: translateY(-1px); border-color: rgba(129,230,217,.40); }
.subbtn:active{ transform: translateY(0); }
.subbtn.disabled{ opacity:.55; cursor:not-allowed; transform:none!important; }

.zale-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.zale-col{ display:grid; gap:8px; }

/* Modal */
.backdrop{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:100;
}
.backdrop.open{ display:flex; }
.modal{
  width:min(520px, 100%);
  border:1px solid var(--border);
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(20,28,52,.88), rgba(13,19,38,.88));
  box-shadow: var(--shadow);
  overflow:hidden;
}
.modalHead{
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.modalTitle{ font-weight:1000; }
.modalBody{ padding:14px; }
label{ display:block; color:var(--muted); font-weight:900; font-size:12px; margin:10px 0 6px; }
input{
  width:100%;
  padding:10px 12px;
  border-radius: 12px;
  border:1px solid rgba(165,184,210,.22);
  background: rgba(2,6,23,.35);
  color: var(--text);
  outline:none;
  font-size:16px;
}
.actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.btnModal{
  border-radius: 12px;
  border:1px solid var(--border);
  background: rgba(2,6,23,.35);
  color: var(--text);
  font-weight:900;
  padding:10px 12px;
  cursor:pointer;
}
.btnModal.primary{
  border-color: rgba(99,179,237,.35);
  background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
}
.note{ color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35; }
.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

@media (max-width: 980px){
  .menu{ grid-template-columns:1fr; }
  .right{ min-height:auto; }
  .subgrid-4{ grid-template-columns:1fr; }
  .zale-grid{ grid-template-columns:1fr; }
}

.admin-only{display:inline-flex;}
</style>
</head>
<body>
<div class="shell">
<div class="header">
<div class="title">Dashboard Raport Forjă</div>
<div class="spacer"></div>
<div class="pills">
<span class="pill warn" id="cloudPill">Cloud: standby</span>
<span class="pill" id="userPill">Utilizator: neautentificat</span>
<button class="btnTop primary" id="btnOpenLogin">Login</button>
<button class="btnTop" id="btnLogout" style="display:none">Ieșire</button>
</div>
</div>
<div class="menu">
<div class="left">
<div class="item" data-target="subRapoarte">
<div class="btn navRequiresAuth" tabindex="0">RAPOARTE</div>
</div>
<div class="item" data-target="subZale">
<div class="btn navRequiresAuth" tabindex="0">URMĂRIRE ZALE</div>
</div>
<div class="item">
<a class="btn navRequiresAuth" data-dash="probleme-raportate.html" href="probleme-raportate.html">PROBLEME RAPORTATE</a>
</div>
<div class="item">
<a class="btn navRequiresAuth" data-dash="rebut.html" href="rebut.html">REBUT</a>
</div>
<div class="item">
<a class="btn navRequiresAuth" data-dash="kpi.html" href="kpi.html">KPI</a>
</div>
<div class="item" data-target="subInventar">
<div class="btn navRequiresAuth" tabindex="0">INVENTAR</div>
</div>
<div class="item" id="helperItem" style="display:none">
<a class="btn navRequiresAuth" data-dash="helper.html" href="helper.html">HELPER</a>
<a class="menu-btn admin-only" data-dash="helper-data.html" href="helper-data.html">HELPER (Date)</a>
</div>
<div class="item" id="aclItem" style="display:none">
<a class="btn navRequiresAuth" data-dash="helper-acl.html" href="helper-acl.html">PERMISIUNI (ACL)</a>
</div>
</div>
<div class="right">
<div class="hint" id="defaultHint">Treci cu mouseul peste un buton din stânga pentru sub‑meniuri.</div>
<div class="subpanel" id="subRapoarte">
<div class="subgrid-4">
<a class="subbtn navRequiresAuth" data-dash="numeralkod.html" href="numeralkod.html">NUMERALKOD</a>
<a class="subbtn navRequiresAuth" data-dash="intrari-otel.html" href="intrari-otel.html">INTRĂRI OȚEL</a>
<a class="subbtn navRequiresAuth" data-dash="debitate.html" href="debitate.html">DEBITATE</a>
<a class="subbtn navRequiresAuth" data-dash="forjate.html" href="forjate.html">FORJATE</a>
<a class="subbtn navRequiresAuth" data-dash="magnaflux.html" href="magnaflux.html">MAGNAFLUX</a>
</div>
</div>
<div class="subpanel" id="subZale">
<div class="zale-grid">
<div class="zale-col">
<a class="subbtn navRequiresAuth" data-dash="zale-9k-6628-29.html" href="zale-9k-6628-29.html">9K‑6628/29</a>
<a class="subbtn navRequiresAuth" data-dash="zale-229-6909-10.html" href="zale-229-6909-10.html">229‑6909/10</a>
<a class="subbtn navRequiresAuth" data-dash="zale-503-0761-62.html" href="zale-503-0761-62.html">503‑0761/62</a>
<a class="subbtn navRequiresAuth" data-dash="zale-106-1625-26.html" href="zale-106-1625-26.html">106‑1625/26</a>
<a class="subbtn navRequiresAuth" data-dash="zale-378-8241-42.html" href="zale-378-8241-42.html">378‑8241/42</a>
<a class="subbtn navRequiresAuth" data-dash="zale-248-2307-08.html" href="zale-248-2307-08.html">248‑2307/08</a>
<a class="subbtn navRequiresAuth" data-dash="zale-417-3595-96.html" href="zale-417-3595-96.html">417‑3595/96</a>
<a class="subbtn navRequiresAuth" data-dash="zale-418-2091-92.html" href="zale-418-2091-92.html">418‑2091/92</a>
</div>
<div class="zale-col">
<a class="subbtn navRequiresAuth" data-dash="ambalare-9k-6628-29.html" href="ambalare-9k-6628-29.html">AMBALARE 9K‑6628/29</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-229-6909-10.html" href="ambalare-229-6909-10.html">AMBALARE 229‑6909/10</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-503-0761-62.html" href="ambalare-503-0761-62.html">AMBALARE 503‑0761/62</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-106-1625-26.html" href="ambalare-106-1625-26.html">AMBALARE 106‑1625/26</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-378-8241-42.html" href="ambalare-378-8241-42.html">AMBALARE 378‑8241/42</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-248-2307-08.html" href="ambalare-248-2307-08.html">AMBALARE 248‑2307/08</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-417-3595-96.html" href="ambalare-417-3595-96.html">AMBALARE 417‑3595/96</a>
<a class="subbtn navRequiresAuth" data-dash="ambalare-418-2091-92.html" href="ambalare-418-2091-92.html">AMBALARE 418‑2091/92</a>
</div>
</div>
</div>
<div class="subpanel" id="subInventar">
<div class="subgrid-4">
<a class="subbtn navRequiresAuth" data-dash="inventar-otel.html" href="inventar-otel.html">INVENTAR OȚEL</a>
<a class="subbtn navRequiresAuth" data-dash="inventar-debitat.html" href="inventar-debitat.html">INVENTAR DEBITAT</a>
<a class="subbtn navRequiresAuth" data-dash="inventar-forjat.html" href="inventar-forjat.html">INVENTAR FORJAT</a>
</div>
</div>
</div>
</div>
</div>
<!-- LOGIN MODAL -->
<div aria-hidden="true" class="backdrop" id="loginBackdrop">
<div aria-labelledby="loginTitle" aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<div class="modalTitle" id="loginTitle">Autentificare</div>
<button class="btnModal" id="btnCloseLogin">✕</button>
</div>
<div class="modalBody">
<div class="note">Login cu cont Supabase. Rolul se ia din <span class="mono">profiles.role</span>.</div>
<label>Email</label>
<input id="email" placeholder="forja.editor@gmail.com" type="email"/>
<label>Parolă</label>
<input id="password" placeholder="••••••••" type="password"/>
<div class="actions">
<button class="btnModal primary" id="btnLogin">Intră</button>
<button class="btnModal" id="btnSignup">Creează cont</button>
</div>
<div class="note" id="loginMsg" style="margin-top:12px"></div>
</div>
</div>
</div>
<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // <-- Anon Key (Legacy)

const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});
window.__SUPA__ = sb;

let user = null;
let role = "viewer";

const cloudPill = document.getElementById("cloudPill");
const userPill = document.getElementById("userPill");
const btnOpenLogin = document.getElementById("btnOpenLogin");
const btnLogout = document.getElementById("btnLogout");

const loginBackdrop = document.getElementById("loginBackdrop");
const btnCloseLogin = document.getElementById("btnCloseLogin");
const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");
const btnLogin = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const loginMsg = document.getElementById("loginMsg");

function setCloud(text, kind="warn"){
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(kind);
  cloudPill.textContent = "Cloud: " + text;
}
function setUser(text){
  userPill.textContent = "Utilizator: " + text;
}
function openLogin(){
  loginBackdrop.classList.add("open");
  loginBackdrop.setAttribute("aria-hidden","false");
  loginMsg.textContent = "";
  setTimeout(()=>emailEl.focus(), 50);
}
function closeLogin(){
  loginBackdrop.classList.remove("open");
  loginBackdrop.setAttribute("aria-hidden","true");
}
function applyAuthUI(){
  if(user){
    btnOpenLogin.style.display = "none";
    btnLogout.style.display = "";
    setUser(user.email + " • " + role);
    setCloud("conectat", "ok");
  } else {
    btnOpenLogin.style.display = "";
    btnLogout.style.display = "none";
    setUser("neautentificat");
    setCloud("standby", "warn");
  }
  document.querySelectorAll(".navRequiresAuth").forEach(el=>{
    if(!user){
      el.classList.add("disabled");
      el.setAttribute("aria-disabled","true");
    } else {
      el.classList.remove("disabled");
      el.removeAttribute("aria-disabled");
    }
  });
  // HELPER + ACL only for admin
  const helperItem = document.getElementById("helperItem");
  if(helperItem){
    helperItem.style.display = (user && role === "admin") ? "" : "none";
  }
  const aclItem = document.getElementById("aclItem");
  if(aclItem){
    aclItem.style.display = (user && role === "admin") ? "" : "none";
  }

}
function interceptNav(e){
  if(user) return;
  const a = e.target.closest("a");
  if(a){
    e.preventDefault();
    e.stopPropagation();
    openLogin();
  }
}
document.addEventListener("click", (e)=>{ if(!user) interceptNav(e); }, true);

async function fetchRole(){
  if(!user) return "viewer";
  const { data, error } = await sb.from("profiles").select("role").eq("id", user.id).maybeSingle();
  if(error) return "viewer";
  return data?.role || "viewer";
}

// Hover submenu logic
(function(){
  const items = [...document.querySelectorAll('.item[data-target]')];
  const panels = [...document.querySelectorAll('.subpanel')];
  const hint = document.getElementById('defaultHint');

  function show(id){
    panels.forEach(p => p.classList.toggle('active', p.id === id));
    hint.style.display = id ? 'none' : '';
  }

  items.forEach(it => {
    const id = it.dataset.target;
    it.addEventListener('mouseenter', ()=>show(id));
    it.addEventListener('click', (e)=>{
      e.preventDefault();
      const active = document.getElementById(id).classList.contains('active');
      show(active ? null : id);
    });
    it.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); it.click(); }
    });
  });

  document.addEventListener('click', (e)=>{
    const inside = e.target.closest('.left') || e.target.closest('.right') || e.target.closest('.backdrop');
    if(!inside){ show(null); }
  });

  show(null);
})();

// Modal close handlers
btnOpenLogin.addEventListener("click", openLogin);
btnCloseLogin.addEventListener("click", closeLogin);
loginBackdrop.addEventListener("click", (e)=>{ if(e.target === loginBackdrop) closeLogin(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && loginBackdrop.classList.contains("open")) closeLogin(); });

// Auth actions
btnSignup.addEventListener("click", async ()=>{
  const email = emailEl.value.trim();
  const password = passEl.value;
  if(!email || !password) { loginMsg.textContent = "Completează email + parolă."; return; }
  loginMsg.textContent = "Creez cont…";
  const { error } = await sb.auth.signUp({ email, password });
  if(error){ loginMsg.textContent = "Signup: " + error.message; return; }
  loginMsg.textContent = "Cont creat. Dacă ai confirmare email, verifică inbox.";
});

btnLogin.addEventListener("click", async ()=>{
  const email = emailEl.value.trim();
  const password = passEl.value;
  if(!email || !password) { loginMsg.textContent = "Completează email + parolă."; return; }
  loginMsg.textContent = "Autentific…";
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ loginMsg.textContent = "Login: " + error.message; return; }
  user = data.user;
  role = await fetchRole();
  closeLogin();
  applyAuthUI();
});

btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  user = null;
  role = "viewer";
  applyAuthUI();
});

// Init session
(async function init(){
  setCloud("standby","warn");
  const { data } = await sb.auth.getSession();
  if(data?.session?.user){
    user = data.session.user;
    role = await fetchRole();
  }
  applyAuthUI();
  sb.auth.onAuthStateChange(async (_event, session)=>{
    user = session?.user || null;
    role = user ? await fetchRole() : "viewer";
    applyAuthUI();
  });
})();
</script>

<script>
/* ===============================
   DASHBOARD BUTTON VISIBILITY ACL
   - doc_key = 'dashboard_acl_v1' (rf_documents)
   - hides/shows dashboard links per role
   =============================== */
(function(){
  const supa = window.__SUPA__;
  if(!supa) return;

  const DOC_TABLE = 'rf_documents';
  const DOC_KEY = 'dashboard_acl_v1';
  let _cache = null;
  let _cacheTs = null;

  function nowIso(){ return new Date().toISOString(); }

  function setVisible(el, on){
    if(!el) return;
    el.style.display = on ? "" : "none";
  }

  function applyToDom(role){
    // Always keep admin-only locked
    document.querySelectorAll('[data-admin-only="1"], .admin-only').forEach(el=>{
      setVisible(el, role === 'admin');
    });

    // If no config yet, default = visible for all authenticated users
    const grants = (_cache && _cache.grants) ? _cache.grants : null;
    const roleGrants = grants && grants[role] ? grants[role] : null;

    document.querySelectorAll('a[data-dash]').forEach(a=>{
      const href = a.getAttribute('data-dash') || a.getAttribute('href') || '';
      if(!href) return;

      // hard admin-only pages
      if(href === 'helper.html' || href === 'helper-acl.html' || href === 'helper-data.html'){
        setVisible(a, role === 'admin');
        return;
      }

      // if viewer/editor/admin and config exists => enforce it
      if(roleGrants){
        const allowed = roleGrants[href];
        // treat undefined as true (so new buttons appear automatically)
        setVisible(a, allowed !== false);
      } else {
        // no config => show
        setVisible(a, true);
      }
    });
  }

  async function pullConfig(){
    try{
      const { data, error } = await supa.from(DOC_TABLE).select('data,updated_at').eq('doc_key', DOC_KEY).maybeSingle();
      if(error) throw error;
      if(!data || !data.data){
        _cache = null;
        _cacheTs = null;
        return;
      }
      const ts = data.updated_at || null;
      if(_cacheTs && ts && new Date(ts) <= new Date(_cacheTs)) return;
      _cache = data.data;
      _cacheTs = ts || nowIso();
    }catch(e){
      console.warn("Dashboard ACL pull failed:", e);
    }
  }

  async function onAuthChanged(){
    try{
      const { data } = await supa.auth.getSession();
      const user = data?.session?.user || null;
      if(!user){
        // not authenticated: keep everything visible (but click is intercepted by dashboard)
        applyToDom('viewer');
        return;
      }
      // role already computed by dashboard script and shown in user pill,
      // but we compute again safely here:
      let role = 'viewer';
      try{
        const r = await supa.from("profiles").select("role").eq("id", user.id).maybeSingle();
        role = r?.data?.role || 'viewer';
      }catch(_e){}
      await pullConfig();
      applyToDom(role);
    }catch(_e){}
  }

  // Run now and on auth changes
  onAuthChanged();
  supa.auth.onAuthStateChange(()=>{ onAuthChanged(); });

  // Poll config (so changes from HELPER-ACL apply live)
  setInterval(async ()=>{
    await pullConfig();
    // try infer current role from user pill if possible
    let role = 'viewer';
    try{
      const pill = document.getElementById('userPill');
      const t = (pill && pill.textContent) ? pill.textContent.toLowerCase() : '';
      if(t.includes('admin')) role='admin';
      else if(t.includes('editor')) role='editor';
    }catch(_e){}
    applyToDom(role);
  }, 5000);
})();
</script></body>
</html>
