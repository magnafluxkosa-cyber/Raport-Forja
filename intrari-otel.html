<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INTRARI OTEL</title>
  <style>
    :root{
      --bg:#b7d7f0;
      --hdr:#cfe3f6;
      --grid:#000;
      --white:#fff;
      --btn:#2b6cb0;
      --btn2:#1e5a96;
      --focus:#2563eb;
      --muted:#334155;
      --filterBg:#e6f0fb;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Calibri, Arial, sans-serif; background: var(--bg); color:#111; min-height:100vh; }

    .topbar{ display:flex; align-items:center; justify-content:flex-end; gap:10px; padding:6px 10px; flex-wrap:wrap; }
    .btnAdd{
      display:inline-flex; align-items:center; gap:8px; border:0;
      background: var(--btn); color:#fff; font-weight:700;
      padding:6px 10px; border-radius:3px; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.15);
    }
    .btnAdd:hover{ background: var(--btn2); }
    .btnMenu{
      margin-right:auto; border:0; background: rgba(255,255,255,.85);
      color:#0f172a; font-weight:700; padding:6px 10px; border-radius:3px;
      cursor:pointer; box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }
    .btnMenu:hover{ background:#fff; }
    .plusCircle{
      width:18px; height:18px; border-radius:999px; background:#fff; color:var(--btn);
      display:inline-flex; align-items:center; justify-content:center; font-weight:900; line-height:1;
    }

    #storageBanner{
      display:none;
      width: 980px;
      margin: 6px 10px 0;
      padding: 8px 10px;
      background: #fff7ed;
      border: 1px solid #fb923c;
      color: #7c2d12;
      font-size: 12px;
      font-weight: 700;
    }

    .sheet{ padding: 4px 10px 18px; }
    .sheetGrid{ display:flex; align-items:flex-start; gap:14px; }

    /* fixed-size table area (nu se mai mƒÉre»ôte) */
    .tableWrap{
      width: 1010px;              /* 980px tabel + spa»õiu pentru scrollbar */
      height: 520px;              /* zona fixƒÉ ca √Æn pozƒÉ */
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 14px;        /* spa»õiu ca scrollbar-ul sƒÉ nu taie din tabel */
    }

    table#tbl{ width: 980px; }
    table{ border-collapse: collapse; table-layout: fixed; background: var(--white); border: 2px solid var(--grid); }
    th, td{ border: 1px solid var(--grid); padding: 4px 6px; height: 22px; font-size: 12px; vertical-align: middle; text-align:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    thead th{ background: var(--hdr); font-weight:700; position:relative; }

    /* antet fix la scroll */
    thead th{ position: sticky; top: 0; z-index: 5; }

    thead th .filter{
      position:absolute; right:2px; bottom:2px; width:18px; height:16px;
      border:1px solid #9aa7b2; background:#e7edf3; display:flex; align-items:center; justify-content:center;
    }
    thead th .filter:before{
      content:""; width:0; height:0;
      border-left:4px solid transparent; border-right:4px solid transparent; border-top:6px solid #4b5563;
      transform: translateY(1px);
    }

    /* filter row */
    #filterRow th{ background: var(--filterBg); padding: 2px 3px; height: 24px; position: sticky; top: 22px; z-index: 6; }
    #filterRow input, #filterRow select{
      width: 100%; height: 20px; border: 1px solid #9aa7b2; background:#ffffff;
      font-family: inherit; font-size: 11px; padding: 0 4px; outline: none;
    }
    #filterRow input:focus, #filterRow select:focus{ border-color: var(--focus); box-shadow: 0 0 0 2px rgba(37,99,235,.12); }

    /* editable cells */
    td.editableCell{ background:#fff; text-align:left; padding-left:8px; }
    td.editableCell[contenteditable="true"]:focus{ outline: 2px solid var(--focus); outline-offset: -2px; }

    /* column widths */
    col.cAn{ width:50px; }
    col.cLuna{ width:70px; }
    col.cData{ width:90px; }
    col.cDim{ width:115px; }
    col.cCal{ width:115px; }
    col.cPrem{ width:125px; }
    col.cCat{ width:105px; }
    col.cKg{ width:95px; }
    col.cPre{ width:95px; }
    col.cFurn{ width:120px; }

    /* side panel */
    .sidePanel{ width: 360px; flex: 0 0 360px; }
    .sideCard{
      background: rgba(255,255,255,.9);
      border: 1px solid #8aa6c2;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
      padding: 10px;
    }
    .sideTitle{ font-weight: 800; font-size: 13px; margin-bottom: 8px; color:#0f172a; }
    .sideControls{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom: 8px; }
    .sideField label{ display:block; font-size:11px; font-weight:700; margin-bottom:3px; color:#0f172a; }
    .sideField select{ width:100%; height: 26px; border:1px solid #9aa7b2; font-family: inherit; font-size: 12px; padding: 0 6px; background:#fff; outline:none; }
    .sideHint{ font-size: 11px; color: var(--muted); line-height: 1.35; margin-bottom: 8px; }
    .sideTableWrap{ max-height: 420px; overflow:auto; border: 1px solid #000; background:#fff; }
    table.sideTable{ width:100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; border:0; }
    table.sideTable th, table.sideTable td{ border:1px solid #000; padding: 4px 6px; height: 22px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    table.sideTable th{ position: sticky; top: 0; background: var(--hdr); z-index: 2; font-weight: 800; text-align:center; }
    table.sideTable td:nth-child(3){ text-align:right; font-weight: 800; }

    /* Modal */
    .hidden{ display:none !important; }
    .backdrop{ position:fixed; inset:0; background: rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:16px; z-index:999; }
    .modal{ width:min(760px, 100%); background:#fff; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; box-shadow: 0 20px 70px rgba(0,0,0,.35); }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#f1f5f9; border-bottom:1px solid #e2e8f0; font-weight:800; }
    .modalBody{ padding:12px; display:grid; gap:10px; }
    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px 12px; }
    .field label{ display:block; font-size:12px; font-weight:700; color:#0f172a; margin-bottom:4px; }
    .field input, .field select{ width:100%; padding:8px 9px; border:1px solid #94a3b8; border-radius:8px; font-family:inherit; font-size:13px; outline:none; }
    .field input:focus, .field select:focus{ border-color: var(--focus); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    .modalFoot{ display:flex; justify-content:flex-end; gap:10px; padding:10px 12px; border-top:1px solid #e2e8f0; background:#f8fafc; }
    .btn{ border:1px solid #94a3b8; background:#fff; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btnPrimary{ border-color: rgba(43,108,176,.9); background: var(--btn); color:#fff; }
    .btnPrimary:hover{ background: var(--btn2); }
    .note{ font-size:12px; color: var(--muted); line-height:1.35; }
  
    .roleBadge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);font-weight:800;font-size:12px}
    .roleDot{width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .roleDot.viewer{background:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.2)}
    .cloudBadge{display:inline-flex;align-items:center;padding:8px 10px;border-radius:999px;background:#ecfeff;color:#0f766e;border:1px solid #99f6e4;font-weight:900;font-size:12px}
    .cloudBadge.off{background:#fff1f2;color:#b91c1c;border-color:#fecdd3}

  </style>
</head>
<body>
  <div class="topbar">
    <button class="btnMenu" onclick="goMenu()">üè† Dashboard</button>

    <span id="roleBadge" class="roleBadge" style="display:none;margin-left:8px;">
      <span id="roleDot" class="roleDot"></span>
      <span id="roleText"></span>
    </span>
    <span id="cloudBadge" class="cloudBadge" style="display:none;margin-left:8px;">Cloud: ...</span>

    <button class="btnAdd" style="background:#0f766e" onclick="toggleFilters()"><span class="plusCircle" style="color:#0f766e">üîé</span> Filtre</button>
    <button class="btnAdd" style="background:#64748b" onclick="clearFilters()"><span class="plusCircle" style="color:#64748b">√ó</span> Reset filtre</button>

    <button class="btnAdd" style="background:#334155" onclick="exportJSON()"><span class="plusCircle" style="color:#334155">‚§ì</span> Export JSON</button>
    <button class="btnAdd" style="background:#334155" onclick="importJSON()" data-admin-only="1"><span class="plusCircle" style="color:#334155">‚§í</span> Import JSON</button>
    <input id="fileImport" type="file" accept="application/json" style="display:none" / data-edit>

    <button class="btnAdd" style="background:#1f2937" onclick="exportXLSX()"><span class="plusCircle" style="color:#1f2937">‚§ì</span> Export Excel</button>
    <button class="btnAdd" style="background:#1f2937" onclick="importXLSX()" data-admin-only="1"><span class="plusCircle" style="color:#1f2937">‚§í</span> Import Excel</button>
    <input id="fileImportXLSX" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" / data-edit>

    <button class="btnAdd" onclick="openForm()"><span class="plusCircle">+</span> AdaugƒÉ</button>
  </div>

  <div id="storageBanner">
    Aten»õie: Browserul a blocat salvarea automatƒÉ (localStorage) pentru fi»ôiere locale. Datele NU vor rƒÉm√¢ne dupƒÉ √Ænchidere.
    Folose»ôte <b>Export JSON</b> pentru a salva.
  </div>

  <div class="sheet">
    <div class="sheetGrid">
      <div class="tableWrap" id="tableWrap">
        <table id="tbl">
          <colgroup>
            <col class="cAn"><col class="cLuna"><col class="cData"><col class="cDim"><col class="cCal">
            <col class="cPrem"><col class="cCat"><col class="cKg"><col class="cPre"><col class="cFurn">
          </colgroup>
          <thead>
            <tr>
              <th>Anul<div class="filter" title="Filtru"></div></th>
              <th>LUNA<div class="filter" title="Filtru"></div></th>
              <th>Data Intrare<div class="filter" title="Filtru"></div></th>
              <th>Dimensiune Otel<div class="filter" title="Filtru"></div></th>
              <th>Calitate otel<div class="filter" title="Filtru"></div></th>
              <th>Cod intern otel (3 litere)<div class="filter" title="Filtru"></div></th>
              <th>Sarja material (furnizor)<div class="filter" title="Filtru"></div></th>
              <th>Cantitate (kg)<div class="filter" title="Filtru"></div></th>
              <th>PRETEST<div class="filter" title="Filtru"></div></th>
              <th>Furnizor<div class="filter" title="Filtru"></div></th>
            </tr>
            <tr id="filterRow">
              <th><input class="filt" data-col="0" placeholder="An" / data-edit></th>
              <th><input class="filt" data-col="1" placeholder="Luna" / data-edit></th>
              <th><input class="filt" data-col="2" placeholder="Data" / data-edit></th>
              <th><input class="filt" data-col="3" placeholder="Dim" / data-edit></th>
              <th><input class="filt" data-col="4" placeholder="Calitate" / data-edit></th>
              <th><input class="filt" data-col="5" placeholder="Cod intern" / data-edit></th>
              <th><input class="filt" data-col="6" placeholder="Sarja" / data-edit></th>
              <th><input class="filt" data-col="7" placeholder="kg" / data-edit></th>
              <th>
                <select class="filtSelect" data-col="8">
                  <option value="">(toate)</option>
                  <option value="Are pretest">Are pretest</option>
                  <option value="Nu are pretest">Nu are pretest</option>
                </select>
              </th>
              <th><input class="filt" data-col="9" placeholder="Furnizor" / data-edit></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr><tr><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td><td class="editableCell" contenteditable="true"></td></tr>
          </tbody>
        </table>
      </div>

      <div class="sidePanel">
        <div class="sideCard">
          <div class="sideTitle">Total intrƒÉri pe Diametru + Calitate</div>
          <div class="sideControls">
            <div class="sideField">
              <label>An</label>
              <select id="sumYear"></select>
            </div>
            <div class="sideField">
              <label>LunƒÉ</label>
              <select id="sumMonth"></select>
            </div>
          </div>
          <div class="sideHint">Suma <b>Cantitate (kg)</b> pe combina»õia <b>Diametru</b> + <b>Calitate</b>, filtrat pe anul »ôi luna selectate.</div>
          <div class="sideTableWrap">
            <table class="sideTable" id="sumTable">
              <thead><tr><th>Diametru</th><th>Calitate</th><th>Total kg</th></tr></thead>
              <tbody id="sumTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <datalist id="gradeList">
    <option value="1E-1287/15B34"></option><option value="1E1239G"></option><option value="1E0361 (C-45)"></option><option value="C35"></option><option value="C45"></option><option value="30MnVS6"></option><option value="S-355"></option><option value="C25"></option><option value="1E-0042"></option><option value="16MnCr05"></option><option value="C60"></option><option value="1E-1497"></option><option value="1E0621/15B22"></option><option value="1E0509"></option><option value="30CrNiMo8"></option><option value="1E4808"></option>
  </datalist>
  <datalist id="diamList"></datalist>


  <datalist id="codeList"></datalist>

  <div id="backdrop" class="backdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>AdaugƒÉ intrare o»õel</div>
        <button class="btn" onclick="closeForm()" type="button">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="grid">
          <div class="field">
            <label>Anul</label>
            <input id="fAn" type="number" min="2000" max="2100" / data-edit>
          </div>
          <div class="field">
            <label>Luna</label>
            <select id="fLuna">
              <option value="">‚Äî</option>
              <option value="Ianuarie">Ianuarie</option><option value="Februarie">Februarie</option><option value="Martie">Martie</option><option value="Aprilie">Aprilie</option><option value="Mai">Mai</option><option value="Iunie">Iunie</option><option value="Iulie">Iulie</option><option value="August">August</option><option value="Septembrie">Septembrie</option><option value="Octombrie">Octombrie</option><option value="Noiembrie">Noiembrie</option><option value="Decembrie">Decembrie</option>
            </select>
          </div>

          <div class="field">
            <label>Data intrare</label>
            <input id="fData" type="date" / data-edit>
          </div>
          <div class="field">
            <label>Dimensiune o»õel</label>
            <input id="fDim" list="diamList" placeholder="ex: √ò30 / 30mm" / data-edit>
          </div>

          <div class="field">
            <label>Calitate o»õel</label>
            <input id="fCal" list="gradeList" placeholder="alege din listƒÉ sau scrie" / data-edit>
          </div>
          <div class="field">
            <label>Cod intern otel (3 litere)</label>
            <input id="fPrem" list="codeList" placeholder="ex: NNN" / data-edit>
          </div>

          <div class="field">
            <label>Sarja material (furnizor)</label>
            <input id="fCat" placeholder="ex: 123456" / data-edit>
          </div>
          <div class="field">
            <label>Cantitate (kg)</label>
            <input id="fKg" type="number" min="0" step="0.01" / data-edit>
          </div>

          <div class="field">
            <label>Pretest</label>
            <select id="fPre">
              <option value="">‚Äî</option>
              <option value="Are pretest">Are pretest</option>
              <option value="Nu are pretest">Nu are pretest</option>
            </select>
          </div>

          <div class="field">
            <label>Furnizor</label>
            <select id="fFurn">
              <option value="">‚Äî</option>
              <option value="Cognor">Cognor</option>
              <option value="ArcelorMittal">ArcelorMittal</option>
              <option value="Altul">Altul</option>
            </select>
          </div>

          <div class="field" id="furnOtherWrap" style="display:none">
            <label>Furnizor (Altul)</label>
            <input id="fFurnOther" placeholder="scrie furnizorul" / data-edit>
          </div>
        </div>

        <div class="note">Formularul <b>nu se √Ænchide</b> dupƒÉ salvare. √él √Ænchizi manual.</div>
      </div>

      <div class="modalFoot">
        <button class="btn" type="button" onclick="closeForm()">AnuleazƒÉ</button>
        <button class="btn btnPrimary" type="button" onclick="saveRow()">SalveazƒÉ</button>
      </div>
    </div>
  </div>

<script>
  const MONTHS = ['ianuarie', 'februarie', 'martie', 'aprilie', 'mai', 'iunie', 'iulie', 'august', 'septembrie', 'octombrie', 'noiembrie', 'decembrie'];

  function capMonth(m){
    if(!m) return m;
    return m.charAt(0).toUpperCase() + m.slice(1);
  }

  
  // --- HELPER lists (editabile √Æn pagina HELPER) ---
  const HELPERS_KEY = "RF_HELPERS_v1";
  function getHelpersSafe(){
    try{ return JSON.parse(localStorage.getItem(HELPERS_KEY) || "{}") || {}; }catch(e){ return {}; }
  }
  function setDatalistOptions(id, values){
    const dl = document.getElementById(id);
    if (!dl) return;
    const seen = new Set();
    const opts = [];
    (values || []).forEach(v => {
      const s = (v ?? "").toString().trim();
      if (!s || seen.has(s)) return;
      seen.add(s);
      opts.push(`<option value="${s.replace(/"/g,'&quot;')}"></option>`);
    });
    dl.innerHTML = opts.join("");
  }
  function refreshHelperDatalists(){
    const h = getHelpersSafe();
    if (Array.isArray(h.lista_calitati) && h.lista_calitati.length){
      setDatalistOptions("gradeList", h.lista_calitati);
    }
    if (Array.isArray(h.lista_diametre) && h.lista_diametre.length){
      setDatalistOptions("diamList", h.lista_diametre.map(x => x.toString()));
    }
  }
  window.addEventListener("message", (e) => {
    if (e && e.data && e.data.type === "HELPERS_UPDATED"){
      refreshHelperDatalists();
    }
  });

function goMenu(){ window.location.href = 'index.html'; }

  const backdrop = document.getElementById('backdrop');

  function openForm(){
    const d = new Date();
    document.getElementById('fAn').value = d.getFullYear();
    document.getElementById('fData').valueAsDate = d;
    refreshHelperDatalists();
    refreshCodeList();
    backdrop.classList.remove('hidden');
    setTimeout(() => document.getElementById('fLuna').focus(), 0);
  }

  function closeForm(){
    backdrop.classList.add('hidden');
  }

  // --- COD INTERN: preluare listƒÉ din NUMERALKOD (localStorage comun) ---
  const NUMERALKOD_KEY = "NUMERALKOD_autosave_v1";
  const CODE_ALLOWED = "NUMERALKOD"; // litere permise

  function refreshCodeList(){
    const dl = document.getElementById('codeList');
    if (!dl) return;

    const codes = new Set();
    try{
      const map = buildMarcajIndex();
      for (const k of map.keys()) codes.add(k);
    }catch(e){}

    dl.innerHTML = Array.from(codes).sort().map(c => `<option value="${c}"></option>`).join('');
  }

  function normalizeCodIntern(s){
    return (s || "").toString().trim().toUpperCase().replace(/\s+/g, "");
  }

  function isValidCodIntern(cod){
    if (!cod || cod.length !== 3) return false;
    for (const ch of cod){
      if (!CODE_ALLOWED.includes(ch)) return false;
    }
    return true;
  }


  // --- AUTO-FILL din NUMERALKOD pentru Cod intern (MARCAJ SARJA) ---
  const NK_LETTERS = ['N','U','M','E','R','A','L','K','O','D'];

  function nkPrefixForSeries(series){
    const m = (series || '').toString().trim().toUpperCase().match(/^([A-Z])(\d{1,2})$/);
    if (!m) return '';
    const first = m[1];
    const idx = Number(m[2]);
    if (!(idx >= 1 && idx <= 10)) return '';
    if (!NK_LETTERS.includes(first)) return '';
    return first + NK_LETTERS[idx-1];
  }

  function loadNumeralkodState(){
  try{
    const raw = localStorage.getItem(NUMERALKOD_KEY);
    if (!raw) return {zale:[], alte:[], rez:[]};
    const obj = JSON.parse(raw);

    // format nou (unele versiuni): {zale:[], alte:[], rez:[]}
    if (obj && (Array.isArray(obj.zale) || Array.isArray(obj.alte) || Array.isArray(obj.rez))){
      return {
        zale: Array.isArray(obj.zale) ? obj.zale : [],
        alte: Array.isArray(obj.alte) ? obj.alte : [],
        rez:  Array.isArray(obj.rez)  ? obj.rez  : []
      };
    }

    // format curent NUMERALKOD v2: {tables:[{group,series,rows}], reserved:[...]}
    if (obj && Array.isArray(obj.tables)){
      const tables = obj.tables;

      // detect: tabele "flat" cu group/series (v2)
      const hasGroup = tables.some(t => t && typeof t === 'object' && ('group' in t) && ('series' in t));
      if (hasGroup){
        const zale = tables
          .filter(t => (t && (t.group||'').toString().toLowerCase() === 'zale'))
          .map(t => ({ series: (t.series||'').toString(), rows: Array.isArray(t.rows) ? t.rows : [] }));
        const alte = tables
          .filter(t => (t && (t.group||'').toString().toLowerCase() === 'alte'))
          .map(t => ({ series: (t.series||'').toString(), rows: Array.isArray(t.rows) ? t.rows : [] }));

        const rezSrc = Array.isArray(obj.reserved) ? obj.reserved : (Array.isArray(obj.rez) ? obj.rez : []);
        const rez = rezSrc.map(r => ({
          marcaj: (r && (r.marcaj || r.code)) ? (r.marcaj || r.code) : '',
          dim:    (r && r.dim)   ? r.dim   : '',
          grade:  (r && (r.grade || r.cal)) ? (r.grade || r.cal) : '',
          sarja:  (r && r.sarja) ? r.sarja : '',
          reper:  (r && r.reper) ? r.reper : ''
        }));
        return {zale, alte, rez};
      }

      // format vechi (fallback): {tables:[{name/title, rows:[seriesObj]}]}
      const zaleT = tables.find(t => /zale/i.test(t.name || t.title || '')) || tables[0];
      const alteT = tables.find(t => /alte/i.test(t.name || t.title || '')) || tables[1];
      const rezT  = tables.find(t => /rez/i.test(t.name || t.title || ''))  || tables[2];
      return {
        zale: Array.isArray(zaleT && zaleT.rows) ? zaleT.rows : [],
        alte: Array.isArray(alteT && alteT.rows) ? alteT.rows : [],
        rez:  Array.isArray(rezT  && rezT.rows)  ? rezT.rows  : []
      };
    }

    // alternative: reserved separat fƒÉrƒÉ tables
    if (obj && Array.isArray(obj.reserved)){
      return {zale:[], alte:[], rez: obj.reserved};
    }
  }catch(e){}
  return {zale:[], alte:[], rez:[]};
}function buildMarcajIndex(){
    const st = loadNumeralkodState();
    const idx = new Map();

    function put(code, payload){
      const c = normalizeCodIntern(code);
      if (!c) return;
      if (!idx.has(c)) idx.set(c, payload);
    }

    function ingestGroup(groupArr, source){
      (groupArr || []).forEach(function(serieObj){
        const series = (serieObj && (serieObj.series || serieObj.SERIA || serieObj.seria)) ? (serieObj.series || serieObj.SERIA || serieObj.seria) : '';
        const pref = nkPrefixForSeries(series);
        if (!pref) return;

        const rows = Array.isArray(serieObj.rows) ? serieObj.rows : [];
        for (let r=0; r < NK_LETTERS.length; r++){
          const code = pref + NK_LETTERS[r];
          const row = rows[r] || {};
          put(code, {dim: (row.dim || ''), grade: (row.grade || ''), sarja: (row.sarja || ''), source: source});
        }
      });
    }

    ingestGroup(st.zale, 'NUMERALKOD zale');
    ingestGroup(st.alte, 'NUMERALKOD alte repere');

    // REZERVAT: poate completa/suprascrie c√¢mpurile (dacƒÉ sunt completate)
    (st.rez || []).forEach(function(r){
      const code = normalizeCodIntern((r && (r.marcaj || r.code)) ? (r.marcaj || r.code) : '');
      if (!code) return;
      const existing = idx.get(code) || {dim:'', grade:'', sarja:'', source:''};
      idx.set(code, {
        dim: (r.dim || existing.dim || ''),
        grade: (r.grade || existing.grade || ''),
        sarja: (r.sarja || existing.sarja || ''),
        source: 'NUMERALKOD rezervat'
      });
    });

    return idx;
  }

  function applyAutoFillFromCodIntern(){
    const inp = document.getElementById('fPrem');
    if (!inp) return;

    const code = normalizeCodIntern(inp.value);
    inp.value = code;
    if (!isValidCodIntern(code)) return;

    const map = buildMarcajIndex();
    const hit = map.get(code);
    if (!hit) return;

    const fDim = document.getElementById('fDim');
    const fCal = document.getElementById('fCal');
    const fCat = document.getElementById('fCat'); // Sarja material (furnizor)

    if (fDim) fDim.value = (hit.dim || '').toString();
    if (fCal) fCal.value = (hit.grade || '').toString();
    if (fCat) fCat.value = (hit.sarja || '').toString();
  }

  (function wireCodInternAutoFill(){
    const inp = document.getElementById('fPrem');
    if (!inp) return;

    inp.addEventListener('input', function(){
      const code = normalizeCodIntern(inp.value);
      inp.value = code;
      if (code.length === 3) applyAutoFillFromCodIntern();
    });

    inp.addEventListener('change', applyAutoFillFromCodIntern);
    inp.addEventListener('blur', applyAutoFillFromCodIntern);
  })();

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) closeForm();
  });

  document.addEventListener('keydown', (e) => {
    if (!backdrop.classList.contains('hidden') && e.key === 'Escape') closeForm();
  });

  function onFurnChange(){
    const sel = document.getElementById('fFurn');
    const wrap = document.getElementById('furnOtherWrap');
    if (!sel || !wrap) return;
    const v = (sel.value || '').toLowerCase();
    wrap.style.display = (v === 'altul') ? '' : 'none';
  }
  (function(){
    const sel = document.getElementById('fFurn');
    if (sel){
      sel.addEventListener('change', onFurnChange);
      onFurnChange();
    }
  })();

  // normalizare live pentru Cod intern
  (function(){
    const inp = document.getElementById('fPrem');
    if (!inp) return;
    inp.addEventListener('blur', () => { inp.value = normalizeCodIntern(inp.value); });
  })();

  // ----- FILTRARE -----
  const filterRow = document.getElementById('filterRow');
  let filtersVisible = true;

  function getCellText(td){ return (td?.textContent || "").trim().toLowerCase(); }

  function applyFilters(){
    const tbody = document.getElementById('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const textFilters = Array.from(document.querySelectorAll('#filterRow input.filt'))
      .map(inp => ({col: Number(inp.dataset.col), val: inp.value.trim().toLowerCase()}));
    const pretestSel = document.querySelector('#filterRow select.filtSelect');
    const pretestVal = (pretestSel?.value || "").trim().toLowerCase();

    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const anyFilter = textFilters.some(f=>f.val.length) || pretestVal.length;
      const rowAllEmpty = Array.from(tds).every(td => getCellText(td) === "");
      if (anyFilter && rowAllEmpty){ tr.style.display = "none"; return; }

      let ok = true;
      for (const f of textFilters){
        if (!f.val) continue;
        const cell = getCellText(tds[f.col]);
        if (!cell.includes(f.val)){ ok = false; break; }
      }
      if (ok && pretestVal){
        const cell = getCellText(tds[8]);
        if (cell !== pretestVal) ok = false;
      }
      tr.style.display = ok ? "" : "none";
    });
  }

  function toggleFilters(){
    filtersVisible = !filtersVisible;
    filterRow.style.display = filtersVisible ? "" : "none";
  }

  function clearFilters(){
    document.querySelectorAll('#filterRow input.filt').forEach(inp => inp.value = "");
    const sel = document.querySelector('#filterRow select.filtSelect');
    if (sel) sel.value = "";
    applyFilters();
  }

  document.querySelectorAll('#filterRow input.filt').forEach(inp => inp.addEventListener('input', applyFilters));
  const selF = document.querySelector('#filterRow select.filtSelect');
  if (selF) selF.addEventListener('change', applyFilters);

  (function wireHeaderFilters(){
    const headerThs = document.querySelectorAll('thead tr:first-child th');
    headerThs.forEach((th, idx) => {
      const f = th.querySelector('.filter');
      if (!f) return;
      f.style.cursor = "pointer";
      f.addEventListener('click', () => {
        filtersVisible = true;
        filterRow.style.display = "";
        const target = filterRow.querySelector(`[data-col="${idx}"]`);
        if (target) target.focus();
      });
    });
  })();

  // ----- EXPORT / IMPORT JSON -----
  function getTableData(){
    const tbody = document.getElementById('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const data = [];
    rows.forEach(tr => {
      const tds = Array.from(tr.querySelectorAll('td'));
      if (tds.length < 10) return;
      const vals = tds.slice(0,10).map(td => (td.textContent || "").trim());
      const any = vals.some(v => v !== "");
      if (any) data.push(vals);
    });
    return data;
  }

  function rebuildTbody(withBlankRows = 30){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = "";
    for (let r=0; r<withBlankRows; r++){ 
      const tr = document.createElement('tr');
      for (let c=0; c<10; c++){ 
        const td = document.createElement('td');
        td.className = 'editableCell';
        td.contentEditable = 'true';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function fillTopDown(dataRows){
    const tbody = document.getElementById('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    dataRows.forEach((vals, i) => {
      if (i >= rows.length){
        const tr = document.createElement('tr');
        for (let c=0; c<10; c++){ 
          const td = document.createElement('td');
          td.className = 'editableCell';
          td.contentEditable = 'true';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
        rows.push(tr);
      }
      const tds = rows[i].querySelectorAll('td');
      for (let c=0; c<10; c++) tds[c].textContent = (c === 2) ? toDisplayDate(vals[c]) : (vals[c] ?? "").toString();
    });
  }

  function exportJSON(){
    const payload = {
      app: "INTRARI_OTEL",
      version: 1,
      exportedAt: new Date().toISOString(),
      rows: getTableData()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "INTRARI_OTEL_data.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const input = document.getElementById('fileImport');
    if (!input) return;
    input.click();
  }

  (function wireImport(){
    const input = document.getElementById('fileImport');
    if (!input) return;
    input.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (!obj || !Array.isArray(obj.rows)) throw new Error("Fi»ôier JSON invalid (lipse»ôte 'rows').");

        const needed = Math.max(30, obj.rows.length + 5);
        rebuildTbody(needed);
        fillTopDown(obj.rows);

        applyFilters();
        notifyDataChanged();
        autoSaveNow();

      }catch(err){
        alert("Nu am putut importa: " + (err?.message || err));
      }finally{
        e.target.value = "";
      }
    });
  })();

  
  // ----- EXPORT / IMPORT EXCEL (.xlsx) -----
  function loadScriptOnce(src){
    return new Promise((resolve, reject) => {
      const existing = Array.from(document.querySelectorAll("script")).some(s => s.src && s.src.includes(src));
      if (existing) return resolve();
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error("Nu pot √ÆncƒÉrca script: " + src));
      document.head.appendChild(s);
    });
  }

  async function ensureXLSX(){
    if (window.XLSX) return true;

    // 1) √ÆncearcƒÉ local (pune xlsx.full.min.js √Æn acela»ôi folder cu acest HTML)
    try{
      await loadScriptOnce(new URL("xlsx.full.min.js", (parent.location.href.split("#")[0].split("?")[0])).href);
      if (window.XLSX) return true;
    }catch(e){ /* ignore */ }

    // 2) fallback CDN (dacƒÉ ai internet)
    try{
      await loadScriptOnce("https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js");
      if (window.XLSX) return true;
    }catch(e){ /* ignore */ }

    alert("LipsƒÉ suport Excel. Solu»õie offline: descarcƒÉ 'xlsx.full.min.js' (SheetJS) »ôi pune-l √Æn acela»ôi folder cu HTML-ul, apoi re√ÆncarcƒÉ pagina.");
    return false;
  }

  function normalizeHeader(h){
    return (h ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .replace(/[()]/g, "")
      .replace(/[^a-z0-9 +]/g, "");
  }

  function toDisplayDate(v){
    const s = (v ?? '').toString().trim();
    if (!s) return '';
    if (/^\d{2}\.\d{2}\.\d{4}$/.test(s)) return s;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
      const parts = s.split('-');
      return parts[2] + '.' + parts[1] + '.' + parts[0];
    }

    // dd.mm.yyyy / dd/mm/yyyy / dd-mm-yyyy
    let m = s.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{4})$/);
    if (m){
      const dd = m[1].padStart(2, '0');
      const mm = m[2].padStart(2, '0');
      const yy = m[3];
      return dd + '.' + mm + '.' + yy;
    }

    // try Date parse
    const d = new Date(s);
    if (!isNaN(d.getTime())){
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth()+1).padStart(2, '0');
      const yy = String(d.getFullYear());
      return dd + '.' + mm + '.' + yy;
    }
    return s; // last resort
  }

  function normalizeDate(v){
    return toDisplayDate(v);
  }

  function normalizeCodIntern(v){
    return (v ?? "").toString().toUpperCase().replace(/[^A-Z]/g,"").slice(0,3);
  }

  function normalizeDiametru(v){
    const s = (v ?? "").toString().trim();
    if (!s) return "";
    const m = s.match(/(\d+(?:[.,]\d+)?)/);
    return m ? m[1].replace(",", ".") : s;
  }

  function normalizeKg(v){
    const s = (v ?? "").toString().trim();
    if (!s) return "";
    return s.replace(",", ".");
  }

  function normalizePretest(v){
    const s = (v ?? "").toString().trim().toLowerCase();
    if (!s) return "Nu are pretest";
    if (s === "are pretest") return "Are pretest";
    if (s === "nu are pretest") return "Nu are pretest";
    if (s.includes("are")) return "Are pretest";
    if (s === "1" || s === "da" || s === "yes" || s === "true") return "Are pretest";
    return "Nu are pretest";
  }

  function exportXLSX(){
    ensureXLSX().then(ok => {
      if (!ok) return;
      const headers = ["Anul","LUNA","Data Intrare","Dimensiune Otel","Calitate otel","Cod intern otel (3 litere)","Sarja material (furnizor)","Cantitate in KG","PRETEST","Furnizor"];
      const data = getTableData();
      const aoa = [headers, ...data];

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      // nice column widths
      ws["!cols"] = [{wch:8},{wch:12},{wch:14},{wch:16},{wch:16},{wch:22},{wch:26},{wch:16},{wch:14},{wch:18}];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "INTRARI_OTEL");
      const name = `INTRARI_OTEL_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, name);
    });
  }

  function importXLSX(){
    const input = document.getElementById("fileImportXLSX");
    if (!input) return;
    input.click();
  }

  (function wireImportXLSX(){
    const input = document.getElementById("fileImportXLSX");
    if (!input) return;

    input.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;

      try{
        const ok = await ensureXLSX();
        if (!ok) return;

        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:""});

        if (!aoa || aoa.length === 0) throw new Error("Fi»ôier Excel gol.");

        // detect header row (first non-empty row)
        let headerRowIndex = -1;
        for (let i=0;i<Math.min(10, aoa.length);i++){
          const row = aoa[i].map(x => (x ?? "").toString().trim());
          if (row.some(x => x !== "")){
            headerRowIndex = i;
            break;
          }
        }
        if (headerRowIndex === -1) throw new Error("Nu gƒÉsesc date √Æn Excel.");

        const header = (aoa[headerRowIndex] || []).map(normalizeHeader);

        // mapping (acceptƒÉ »ôi variantele din Excel / ERP)
        const want = {
          an: ["an intrare","anul","an"],
          luna: ["luna intrare","luna"],
          data: ["data intrare","data"],
          diam: ["diametrul otelului","diametru otelului","diametru","dimensiune otel","dimensiune otelului"],
          cal: ["calitatea otelului","calitate otelului","calitate otel","calitate"],
          cod: ["cod intern otel 3 litere","cod intern otel 3","cod intern otel","cod intern","cod sarja premagro"],
          sarja: ["sarja material furnizor","sarja materialului","sarja material","sarja","cod sarja cat"],
          kg: ["cantitate in kg","cantitate kg","cantitate","cantitatea in kg","kg"],
          pre: ["pretest"],
          furn: ["furnizor","supplier"]
        };

        function findIndexBySyn(syns){
          for (const s of syns){
            const n = normalizeHeader(s);
            const idx = header.indexOf(n);
            if (idx >= 0) return idx;
          }
          return -1;
        }

        const idxMap = {
          an: findIndexBySyn(want.an),
          luna: findIndexBySyn(want.luna),
          data: findIndexBySyn(want.data),
          diam: findIndexBySyn(want.diam),
          cal: findIndexBySyn(want.cal),
          cod: findIndexBySyn(want.cod),
          sarja: findIndexBySyn(want.sarja),
          kg: findIndexBySyn(want.kg),
          pre: findIndexBySyn(want.pre),
          furn: findIndexBySyn(want.furn)
        };

        const hasHeaders = Object.values(idxMap).some(v => v >= 0);

        const rows = [];
        const start = hasHeaders ? headerRowIndex + 1 : headerRowIndex; // if no headers, treat first row as data

        for (let r = start; r < aoa.length; r++){
          const row = aoa[r] || [];
          const get = (i) => i >= 0 ? (row[i] ?? "") : "";

          let vals;
          if (hasHeaders){
            vals = [
              (get(idxMap.an) ?? "").toString().trim(),
              (get(idxMap.luna) ?? "").toString().trim(),
              normalizeDate(get(idxMap.data)),
              normalizeDiametru(get(idxMap.diam)),
              (get(idxMap.cal) ?? "").toString().trim(),
              normalizeCodIntern(get(idxMap.cod)),
              (get(idxMap.sarja) ?? "").toString().trim(),
              normalizeKg(get(idxMap.kg)),
              normalizePretest(get(idxMap.pre)),
              (get(idxMap.furn) ?? "").toString().trim() || "Necunoscut"
            ];
          }else{
            // already in order: 10 cols
            const padded = Array.from({length:10}, (_,i)=> (row[i] ?? "").toString().trim());
            vals = [
              padded[0],
              padded[1],
              normalizeDate(padded[2]),
              normalizeDiametru(padded[3]),
              padded[4],
              normalizeCodIntern(padded[5]),
              padded[6],
              normalizeKg(padded[7]),
              normalizePretest(padded[8]),
              padded[9] || "Necunoscut"
            ];
          }

          const any = vals.some(v => (v ?? "").toString().trim() !== "");
          if (!any) continue;
          rows.push(vals);
        }

        const needed = Math.max(30, rows.length + 5);
        rebuildTbody(needed);
        fillTopDown(rows);

        applyFilters();
        notifyDataChanged();
        autoSaveNow();

      }catch(err){
        alert("Nu am putut importa Excel: " + (err?.message || err));
      }finally{
        e.target.value = "";
      }
    });
  })();

// ----- AUTO-SALVARE (localStorage) -----
  const AUTO_KEY = "INTRARI_OTEL_autosave_v3";
  function storageAvailable(){
    try{
      const k="__test__";
      window.localStorage.setItem(k,"1");
      window.localStorage.removeItem(k);
      return true;
    }catch(e){ return false; }
  }
  const CAN_AUTOSAVE = storageAvailable();
  document.getElementById('storageBanner').style.display = CAN_AUTOSAVE ? "none" : "block";

  function autoSaveNow(){
    if (!CAN_AUTOSAVE) return;
    try{
      const payload = {
        app:"INTRARI_OTEL",
        version:3,
        savedAt: new Date().toISOString(),
        rows: getTableData()
      };
      localStorage.setItem(AUTO_KEY, JSON.stringify(payload));
    }catch(e){}
  }

  let _autosaveTimer = null;
  function scheduleAutosave(){
    if (!CAN_AUTOSAVE) return;
    clearTimeout(_autosaveTimer);
    _autosaveTimer = setTimeout(autoSaveNow, 200);
  }

  function autoLoad(){
    if (!CAN_AUTOSAVE) return false;
    try{
      const raw = localStorage.getItem(AUTO_KEY);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      if (!obj || !Array.isArray(obj.rows)) return false;

      const needed = Math.max(30, obj.rows.length + 5);
      rebuildTbody(needed);
      fillTopDown(obj.rows);
      return true;
    }catch(e){ return false; }
  }

  // ----- SUMAR DREAPTA -----
  function parseKg(s){
    const raw = (s || "").toString().trim();
    if (!raw) return 0;
    let t = raw.replace(/\s+/g,'');

    // daca exista virgula, virgula este zecimala (RO), punctele sunt separatori de mii
    if (t.includes(',')){
      t = t.replace(/\./g,'');
      const first = t.indexOf(',');
      t = t.slice(0, first + 1) + t.slice(first + 1).replace(/,/g,'');
      t = t.replace(',', '.');
      const v = Number(t);
      return isFinite(v) ? v : 0;
    }

    // fara virgula: pattern de mii gen 19.200 / 1.234.567
    if (/^\d{1,3}(\.\d{3})+$/.test(t)){
      const v = Number(t.replace(/\./g,''));
      return isFinite(v) ? v : 0;
    }

    // fara virgula: doar cifre
    if (/^\d+$/.test(t)){
      const v = Number(t);
      return isFinite(v) ? v : 0;
    }

    // fallback: trateaza punctul ca zecimala (si elimina punctele multiple)
    const dotCount = (t.match(/\./g) || []).length;
    if (dotCount > 1) t = t.replace(/\./g,'');
    const v = Number(t);
    return isFinite(v) ? v : 0;
  }

  function getAllDataRows(){
    const tbody = document.getElementById('tbody');
    return Array.from(tbody.querySelectorAll('tr')).map(tr => {
      const tds = tr.querySelectorAll('td');
      if (!tds || tds.length < 10) return null;
      const year = (tds[0].textContent || "").trim();
      const month = (tds[1].textContent || "").trim();
      const diam = (tds[3].textContent || "").trim();
      const qual = (tds[4].textContent || "").trim();
      const kg = (tds[7].textContent || "").trim();
      const any = Array.from(tds).some(td => ((td.textContent || "").trim() !== ""));
      if (!any) return null;
      return {year, month, diam, qual, kg: parseKg(kg)};
    }).filter(Boolean);
  }

  function buildSummaryFilters(){
    const yearsSel = document.getElementById('sumYear');
    const monthSel = document.getElementById('sumMonth');
    if (!yearsSel || !monthSel) return;

    const rows = getAllDataRows();
    const years = Array.from(new Set(rows.map(r => r.year).filter(Boolean))).sort((a,b)=>Number(a)-Number(b));

    yearsSel.innerHTML = '<option value="">(to»õi)</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
    monthSel.innerHTML = '<option value="">(toate)</option>' + MONTHS.map(m => `<option value="${m}">${capMonth(m)}</option>`).join('');

    const now = new Date();
    const yNow = String(now.getFullYear());
    // alege anul: anul curent dacƒÉ existƒÉ, altfel ultimul an disponibil
    if (years.includes(yNow)) yearsSel.value = yNow;
    else if (years.length) yearsSel.value = years[years.length - 1];

    // alege luna: luna curentƒÉ dacƒÉ existƒÉ √Æn datele anului selectat, altfel cea mai recentƒÉ; dacƒÉ nu existƒÉ, (toate)
    const yearPicked = (yearsSel.value || "").trim();
    const monthsForYear = Array.from(new Set(rows.filter(r => !yearPicked || r.year === yearPicked).map(r => r.month))).filter(Boolean);
    monthsForYear.sort((a,b)=> MONTHS.indexOf(b) - MONTHS.indexOf(a));
    const mNow = MONTHS[now.getMonth()];
    if (monthsForYear.includes(mNow)) monthSel.value = mNow;
    else if (monthsForYear.length) monthSel.value = monthsForYear[0]; // nu sortƒÉm aici; se vede imediat √Æn tabel
    else monthSel.value = "";

    yearsSel.onchange = refreshSummary;
    monthSel.onchange = refreshSummary;
  }

  function formatKg(v){
    const n = Number(v || 0);
    if (!isFinite(n)) return "0";
    const hasDec = Math.abs(n - Math.round(n)) > 1e-9;
    const s = hasDec ? n.toFixed(2) : String(Math.round(n));
    const parts = s.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return parts.join(hasDec ? "," : "");
  }

  function refreshSummary(){
    const yearsSel = document.getElementById('sumYear');
    const monthSel = document.getElementById('sumMonth');
    const tbody = document.getElementById('sumTbody');
    if (!yearsSel || !monthSel || !tbody) return;

    const y = (yearsSel.value || "").trim();
    const m = (monthSel.value || "").trim();

    const rows = getAllDataRows().filter(r => {
      if (y && r.year !== y) return false;
      if (m && r.month !== m) return false;
      return true;
    });

    const map = new Map();
    for (const r of rows){
      const diam = r.diam || "(fƒÉrƒÉ diametru)";
      const qual = r.qual || "(fƒÉrƒÉ calitate)";
      const key = diam + "||" + qual;
      map.set(key, (map.get(key) || 0) + (r.kg || 0));
    }

    const items = Array.from(map.entries()).map(([key, total]) => {
      const [diam, qual] = key.split("||");
      return {diam, qual, total};
    }).sort((a,b) => b.total - a.total);

    tbody.innerHTML = "";
    if (!items.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.style.textAlign = "center";
      td.style.color = "#475569";
      td.textContent = "Nu existƒÉ date pentru filtrul selectat.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    items.forEach(it => {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = it.diam;
      const td2 = document.createElement('td'); td2.textContent = it.qual;
      const td3 = document.createElement('td'); td3.textContent = formatKg(it.total);
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
      tbody.appendChild(tr);
    });
  }

  function notifyDataChanged(){
    buildSummaryFilters();
    refreshSummary();
  }

  // autosave on manual edit end
  document.addEventListener('focusout', (e) => {
    const el = e.target;
    if (el && el.tagName === 'TD' && el.classList.contains('editableCell')){
      notifyDataChanged();
      scheduleAutosave();
    }
  }, true);

  // ----- ADAUGARE TOP-DOWN -----
  function findFirstEmptyRow(tbody){
    const rows = Array.from(tbody.querySelectorAll('tr'));
    for (const tr of rows){
      const tds = Array.from(tr.querySelectorAll('td'));
      if (!tds.length) continue;
      const allEmpty = tds.every(td => ((td.textContent || "").trim() === ""));
      if (allEmpty) return tr;
    }
    return null;
  }

  function scrollToRow(tr){
    const wrap = document.getElementById('tableWrap');
    if (!wrap || !tr) return;
    // ensure it scrolls inside the wrapper
    const wrapRect = wrap.getBoundingClientRect();
    const trRect = tr.getBoundingClientRect();
    // if outside view, adjust
    if (trRect.top < wrapRect.top || trRect.bottom > wrapRect.bottom){
      tr.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
  }

  function saveRow(){
    const an = document.getElementById('fAn').value.trim();
    const luna = document.getElementById('fLuna').value.trim();
    const data = document.getElementById('fData').value;
    const dim = document.getElementById('fDim').value.trim();
    const cal = document.getElementById('fCal').value.trim();
    const prem = normalizeCodIntern(document.getElementById('fPrem').value);
    const cat = document.getElementById('fCat').value.trim();
    const kg = document.getElementById('fKg').value.trim();
    const pre = document.getElementById('fPre').value.trim();
    let furn = document.getElementById('fFurn').value.trim();
    const furnOther = (document.getElementById('fFurnOther')?.value || '').trim();
    if (furn.toLowerCase() === 'altul') furn = furnOther;

    const codIntern = prem; // alias semantic
    const sarja = cat;

    if (!an || !luna || !data || !dim || !cal || !codIntern || !sarja || !kg || !pre || !furn){
      alert("CompleteazƒÉ: Anul, Luna, Data, Diametru, Calitate, Cod intern (3 litere), Sarja material, Cantitate (kg), Pretest, Furnizor.");
      return;
    }

    if (!isValidCodIntern(codIntern)){
      alert("Cod intern invalid. Trebuie sƒÉ fie exact 3 litere din setul: N U M E R A L K O D (ex: NNN, NNU, UNM).");
      return;
    }

    const parts = data.split('-');
    const dataDisp = parts.length === 3 ? (parts[2] + "." + parts[1] + "." + parts[0]) : data;
    const cells = [an, luna, dataDisp, dim, cal, prem, cat, kg, pre, furn];

    const tbody = document.getElementById('tbody');
    let tr = findFirstEmptyRow(tbody);

    if (!tr){
      tr = document.createElement('tr');
      for (let i=0;i<10;i++) {
        const td = document.createElement('td');
        td.className = 'editableCell';
        td.contentEditable = 'true';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    const tds = tr.querySelectorAll('td');
    cells.forEach((v, i) => { if (tds[i]) tds[i].textContent = v || ""; });

    applyFilters();
    notifyDataChanged();
    scheduleAutosave();
    scrollToRow(tr);
  }

  // ----- INIT -----
  // auto-load first (if possible)
  refreshHelperDatalists();
  const loaded = autoLoad();
  applyFilters();
  notifyDataChanged();
  if (loaded) autoSaveNow(); // normalize stored format
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===============================
   RF AUTH + ROLE (profiles)
   - admin / editor / viewer
   - viewer: read-only (dar export OK)
   - editor: edit in celule
   - admin: edit + vede butoanele de admin (import/reset/sterge autosave etc.)
   =============================== */
(function(){
  const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // <-- Anon Key (Legacy)
;

  const roleBadge = document.getElementById('roleBadge');
  const roleText  = document.getElementById('roleText');
  const roleDot   = document.getElementById('roleDot');
  const cloudBadge= document.getElementById('cloudBadge');

  // init supabase
  const supa = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false }})
    : null;

  if(!supa){
    if(cloudBadge){ cloudBadge.style.display='inline-flex'; cloudBadge.classList.add('off'); cloudBadge.textContent='Cloud: client indisponibil'; }
    return;
  }
  window.__SUPA__ = supa;

  async function loadRole(){
    const { data: { user } } = await supa.auth.getUser();
    if(!user) return { role:'viewer', user:null };
    try{
      const { data, error } = await supa.from('profiles').select('role').eq('id', user.id).maybeSingle();
      if(error) throw error;
      const role = (data && data.role) ? String(data.role) : 'viewer';
      return { role, user };
    }catch(e){
      console.warn('role lookup failed', e);
      return { role:'viewer', user };
    }
  }

  function applyRole(role){
    window.__APP_ROLE__ = role;
    if(roleBadge){
      roleBadge.style.display='inline-flex';
      roleText.textContent = role.toUpperCase() + (role==='viewer' ? ' (read-only)' : '');
      roleDot.classList.toggle('viewer', role==='viewer');
    }
    // hide admin-only buttons
    const adminOnlySelectors = [
      '#btnImportExcel','#btnImportJSON',
      '#btnReset','#btnClearAutosave',
      '#btnDeleteRow','#btnAddRow',
      '[data-admin-only="1"]'
    ];
    adminOnlySelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.style.display = (role==='admin') ? '' : 'none';
      });
    });

    // editing allowed for admin+editor
    const canEdit = (role==='admin' || role==='editor');

    // disable inputs / contenteditable inside table area for viewer
    // (nu blocam butoanele de Export)
    document.querySelectorAll('table input, table select, table textarea').forEach(el=>{
      el.disabled = !canEdit;
    });
    document.querySelectorAll('[contenteditable]').forEach(el=>{
      if(!canEdit) el.setAttribute('contenteditable','false');
    });

    // a lot of the UI uses click-to-edit cells; we also gate add/remove actions via runtime checks
    window.__CAN_EDIT__ = canEdit;
  }

  // expose helper
  window.__RF_LOAD_ROLE__ = loadRole;
  window.__RF_APPLY_ROLE__ = applyRole;

  // run once now
  loadRole().then(({role})=>applyRole(role));
})();
</script>

<script>
/* ===============================
   RF CLOUD SYNC (rf_documents)
   - doc_key = 'intrari_otel'
   - auto push on changes (debounce)
   - auto pull polling (edit-safe)
   =============================== */
(function(){
  const supa = window.__SUPA__;
  const cloudBadge = document.getElementById('cloudBadge');
  if(!supa){
    if(cloudBadge){ cloudBadge.style.display='inline-flex'; cloudBadge.classList.add('off'); cloudBadge.textContent='Cloud: client indisponibil'; }
    return;
  }
  const DOC_TABLE = 'rf_documents';
  const DOC_KEY = 'intrari_otel';
  let lastPulledAt = null;
  let lastPushedAt = null;
  let pollTimer = null;
  let pushTimer = null;
  let inFlight = false;

  function setCloud(ok, msg){
    if(!cloudBadge) return;
    cloudBadge.style.display='inline-flex';
    cloudBadge.classList.toggle('off', !ok);
    cloudBadge.textContent = msg || (ok ? 'Cloud: ON' : 'Cloud: eroare');
  }
  function nowIso(){ return new Date().toISOString(); }

  // get current page data: we rely on existing getTableData() and getState() patterns
  function getPayload(){
    // existing code stores in localStorage via autoSaveNow(); we reuse the canonical state
    // fallback: try read from localStorage key used by this page
    try{
      if(window.getAllDataForExport) return window.getAllDataForExport(); // if exists
    }catch(_e){}
    try{
      if(window.getTableData){
        return { rows: window.getTableData() };
      }
    }catch(_e){}
    // fallback: localStorage snapshot
    try{
      const k = (window.APP_KEYS && window.APP_KEYS.intrari) ? window.APP_KEYS.intrari : 'INTRARI_OTEL_autosave_v3';
      const raw = localStorage.getItem(k);
      return raw ? JSON.parse(raw) : { rows:[] };
    }catch(_e){ return { rows:[] }; }
  }

  function applyPayload(payload){
    // edit-safe: if user is editing an input, don't re-render now
    const ae = document.activeElement;
    if(ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.tagName==='SELECT')){
      return false;
    }
    try{
      if(window.loadFromPayload){
        window.loadFromPayload(payload);
        return true;
      }
    }catch(e){}
    try{
      // fall back to existing autoLoad format: localStorage then autoLoad()
      const k = (window.APP_KEYS && window.APP_KEYS.intrari) ? window.APP_KEYS.intrari : 'INTRARI_OTEL_autosave_v3';
      localStorage.setItem(k, JSON.stringify(payload || {}));
      if(window.autoLoad) window.autoLoad();
      if(window.applyFilters) window.applyFilters();
      return true;
    }catch(_e){}
    return false;
  }

  async function pull(){
    if(inFlight) return;
    inFlight = true;
    try{
      const { data, error } = await supa.from(DOC_TABLE).select('doc_key,data,updated_at').eq('doc_key', DOC_KEY).maybeSingle();
      if(error) throw error;
      if(!data || !data.data){ setCloud(true,'Cloud: gol'); return; }
      const ts = data.updated_at || null;
      // ignore if we already have this update (or it's older)
      if(lastPulledAt && ts && new Date(ts) <= new Date(lastPulledAt)) { setCloud(true,'Cloud: ON'); return; }
      // if we pushed newer, don't overwrite
      if(lastPushedAt && ts && new Date(ts) <= new Date(lastPushedAt)) { setCloud(true,'Cloud: ON'); return; }

      const applied = applyPayload(data.data);
      if(applied){
        lastPulledAt = ts || nowIso();
      }
      setCloud(true,'Cloud: ON');
    }catch(e){
      console.error(e);
      setCloud(false,'Cloud: eroare');
    }finally{
      inFlight = false;
    }
  }

  function schedulePush(){
    if(!window.__CAN_EDIT__) return;
    if(pushTimer) clearTimeout(pushTimer);
    pushTimer = setTimeout(async ()=>{
      try{
        const payload = getPayload();
        const up = { doc_key: DOC_KEY, data: payload, updated_at: nowIso() };
        const { error } = await supa.from(DOC_TABLE).upsert(up, { onConflict:'doc_key' });
        if(error) throw error;
        lastPushedAt = up.updated_at;
        setCloud(true,'Cloud: ON');
      }catch(e){
        console.error(e);
        setCloud(false,'Cloud: eroare');
      }
    }, 500);
  }

  // Hook into existing autosave: whenever page says data changed, push to cloud
  window.notifyDataChanged = (function(orig){
    return function(){
      try{ if(typeof orig === 'function') orig(); }catch(_e){}
      schedulePush();
    };
  })(window.notifyDataChanged);

  // also listen to generic input events
  document.addEventListener('input', (e)=>{
    // ignore toolbar inputs etc, but generally fine
    schedulePush();
  }, true);


  /* ===== Auto-scroll la ultimul r√¢nd (regulƒÉ globalƒÉ) ===== */
  const _scrolledOnce = new WeakSet();
  function autoScrollBottomOnce(){
    try{
      const wrap = document.getElementById('tableWrap');
      if(wrap && wrap.scrollHeight > wrap.clientHeight + 2 && !_scrolledOnce.has(wrap)){
        wrap.scrollTop = wrap.scrollHeight;
        _scrolledOnce.add(wrap);
      }
    }catch(_e){}
  }
  // after render/pull/import
  const _origRender = window.renderTable;
  if(typeof _origRender === 'function'){
    window.renderTable = function(){
      const r = _origRender.apply(this, arguments);
      setTimeout(autoScrollBottomOnce, 50);
      setTimeout(autoScrollBottomOnce, 250);
      return r;
    }
  } else {
    // fallback: try after load
    window.addEventListener('load', ()=>{ setTimeout(autoScrollBottomOnce, 200); });
  }


  // initial
  setCloud(true,'Cloud: conectare...');
  pull();
  pollTimer = setInterval(pull, 2500);
})();
</script>


<script>
/* ===== ACL (rf_acl) integration ===== */
async function rfGetMyRole(supa){
  const { data: s } = await supa.auth.getSession();
  const sess = s?.session;
  if(!sess) return { role:"viewer", email:"" };
  const email = sess.user?.email || "";
  const { data } = await supa.from("profiles").select("role").eq("id", sess.user.id).maybeSingle();
  return { role: (data?.role || "viewer"), email };
}
async function rfGetAcl(supa, pageKey, role){
  const { data, error } = await supa.from("rf_acl").select("*").eq("page_key", pageKey).eq("role", role).maybeSingle();
  if(error) throw error;
  return data || {
    can_view:true, can_edit_data:false,
    show_import_buttons:false, show_add_buttons:false, show_delete_buttons:false, show_reset_buttons:false,
    can_export:true, can_filter:true, can_sync_cloud:false
  };
}
function rfApplyAclToUi(acl){
  const map = { import:"show_import_buttons", add:"show_add_buttons", delete:"show_delete_buttons", reset:"show_reset_buttons",
                export:"can_export", filter:"can_filter", sync:"can_sync_cloud" };
  document.querySelectorAll("[data-acl]").forEach(el=>{
    const key = el.getAttribute("data-acl");
    const prop = map[key];
    if(!prop) return;
    const allowed = !!acl[prop];
    el.style.display = allowed ? "" : "none";
  });
  document.querySelectorAll("[data-edit]").forEach(el=>{
    try{ el.disabled = !acl.can_edit_data; }catch(_e){}
  });
}
async function rfBootAcl({ supa, pageKey, onRoleBadge }){
  const me = await rfGetMyRole(supa);
  const acl = await rfGetAcl(supa, pageKey, me.role);
  if(!acl.can_view){
    window.location.href = "index.html";
    return null;
  }
  if(onRoleBadge) onRoleBadge(me.role, me.email);
  rfApplyAclToUi(acl);
  return { me, acl };
}
window.addEventListener("load", async ()=>{
  try{
    const supa = (typeof sb !== "undefined" && sb) ? sb : (window.__rfCloud && window.__rfCloud.client);
    if(!supa) return;
    await rfBootAcl({ supa, pageKey:"intrari_otel", onRoleBadge:(role,email)=>{} });
  }catch(e){ console.warn("ACL boot", e); }
});
</script>

</body>
</html>
