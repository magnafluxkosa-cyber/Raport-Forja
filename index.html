<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raport Forjă • LIVE</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b1220;
      --line:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:#a9c0e3;
      --btn:#1f2f55;
      --btn2:#223a6a;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --panel:#cfe6f7;
      --panel2:#bfe0f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .topbar{
      background:linear-gradient(180deg,#081632, #07122a);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      position:sticky;top:0;z-index:10;
    }
    .brand{font-weight:900;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tab{
      background:#0b1a33;border:1px solid var(--line);
      color:var(--text);padding:6px 10px;border-radius:999px;
      cursor:pointer;font-weight:800;font-size:12px;user-select:none;
    }
    .tab.active{background:#12305f;border-color:rgba(91,140,255,.35)}
    .spacer{flex:1}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:rgba(0,0,0,.15)}
    .pill.ok{border-color:rgba(22,163,74,.35);color:#bbf7d0}
    .pill.warn{border-color:rgba(245,158,11,.35);color:#fde68a}
    .pill.bad{border-color:rgba(239,68,68,.35);color:#fecaca}
    button{
      border:0;border-radius:10px;padding:8px 12px;cursor:pointer;
      background:var(--btn2);color:white;font-weight:800;
    }
    button.secondary{background:var(--btn)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .wrap{padding:12px}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:start;}
    .panel{
      background:var(--panel);color:#061228;border-radius:14px;overflow:hidden;
      border:1px solid rgba(0,0,0,.12);
    }
    .panel .head{
      background:rgba(255,255,255,.45);
      padding:10px 12px;
      font-weight:900;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      background:rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.10);
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;
    }
    .table-wrap{
      overflow:auto;border-top:1px solid rgba(0,0,0,.12);
      background:white;max-height:70vh;
    }
    table{width:100%;border-collapse:collapse;font-size:12.5px;min-width:1200px;}
    th,td{border-bottom:1px solid rgba(0,0,0,.12);padding:8px 8px;text-align:left;white-space:nowrap;}
    th{position:sticky;top:0;background:#e9f5ff;z-index:1;font-weight:900;}
    .side{display:flex;flex-direction:column;gap:12px;}
    .card{
      background:var(--panel2);color:#061228;border-radius:14px;
      border:1px solid rgba(0,0,0,.12);padding:12px;
    }
    label{display:block;font-size:12px;font-weight:900;margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);
      background:rgba(255,255,255,.85);outline:none;font-size:16px;
    }
    textarea{min-height:70px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .hint{font-size:12px;color:#1f2f55;opacity:.9}
    .danger{background:#b00020}
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .table-wrap{max-height:55vh}
      table{min-width:1300px}
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand">Raport Forjă (LIVE)</div>
  <div class="tabs">
    <div class="tab active" data-tab="debitate">DEBITATE</div>
    <div class="tab" data-tab="intrari">INTRARI_OTEL</div>
    <div class="tab" data-tab="numeralkod">NUMERALKOD</div>
  </div>
  <div class="spacer"></div>
  <span id="cloudPill" class="pill warn">Cloud: standby</span>
  <span id="userPill" class="pill">neautentificat</span>
  <button id="btnLogout" class="secondary" disabled>Logout</button>
</div>

<div class="wrap">
  <div class="layout">

    <div class="panel">
      <div class="head">
        <div class="actions">
          <button id="btnAdd" disabled>➕ Adaugă</button>
          <span class="chip" id="kpiRows">0 rânduri</span>
          <span class="chip" id="kpiTotal">0 kg total</span>
          <span class="chip" id="kpiLive">LIVE: —</span>
        </div>
        <div style="margin-left:auto" class="actions">
          <button id="btnReload" class="secondary" disabled>Reîncarcă</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="hint">Neautentificat.</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="side">
      <div class="card">
        <div style="font-weight:900">Autentificare</div>
        <div class="hint" style="margin-top:6px">Viewer vede; Editor/Admin adaugă. LIVE = se vede instant pe alt laptop.</div>
        <label>Email</label>
        <input id="email" type="email" placeholder="nume@firma.ro">
        <label>Parolă</label>
        <input id="password" type="password" placeholder="••••••••">
        <div class="actions" style="margin-top:10px">
          <button id="btnLogin">Intră</button>
          <button id="btnSignup" class="secondary">Creează cont</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900">Filtre</div>
        <div class="row">
          <div>
            <label>An</label>
            <input id="fltYear" type="number" min="2020" step="1">
          </div>
          <div>
            <label>Lună</label>
            <select id="fltMonth">
              <option value="">(toate)</option>
              <option value="1">Ianuarie</option><option value="2">Februarie</option><option value="3">Martie</option>
              <option value="4">Aprilie</option><option value="5">Mai</option><option value="6">Iunie</option>
              <option value="7">Iulie</option><option value="8">August</option><option value="9">Septembrie</option>
              <option value="10">Octombrie</option><option value="11">Noiembrie</option><option value="12">Decembrie</option>
            </select>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Filtrarea e în DB (rapid + live).</div>
      </div>

      <div class="card" id="formCard" style="display:none">
        <div style="font-weight:900" id="formTitle">Adaugă</div>
        <div id="formBody"></div>
        <div class="actions" style="margin-top:10px">
          <button id="btnSave" disabled>Salvează</button>
          <button id="btnCancel" class="secondary">Renunță</button>
          <button id="btnDelete" class="danger" style="display:none">Șterge</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});
window.__SUPA__ = sb;

let user=null, role="viewer";
let liveConnected=false;
let tab="debitate";
let selectedId=null;
let rows=[];

const cloudPill=document.getElementById("cloudPill");
const userPill=document.getElementById("userPill");
const btnLogout=document.getElementById("btnLogout");
const btnReload=document.getElementById("btnReload");
const btnAdd=document.getElementById("btnAdd");
const kpiRows=document.getElementById("kpiRows");
const kpiTotal=document.getElementById("kpiTotal");
const kpiLive=document.getElementById("kpiLive");
const emailEl=document.getElementById("email");
const passEl=document.getElementById("password");
const btnLogin=document.getElementById("btnLogin");
const btnSignup=document.getElementById("btnSignup");
const fltYear=document.getElementById("fltYear");
const fltMonth=document.getElementById("fltMonth");
const thead=document.getElementById("thead");
const tbody=document.getElementById("tbody");

const formCard=document.getElementById("formCard");
const formTitle=document.getElementById("formTitle");
const formBody=document.getElementById("formBody");
const btnSave=document.getElementById("btnSave");
const btnCancel=document.getElementById("btnCancel");
const btnDelete=document.getElementById("btnDelete");

function setCloud(txt, kind="warn"){
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(kind);
  cloudPill.textContent = "Cloud: " + txt;
}
function setUserPill(){ userPill.textContent = user ? (user.email+" • "+role) : "neautentificat"; }
function isEditor(){ return role==="editor" || role==="admin"; }
function monthNo(){ return fltMonth.value ? Number(fltMonth.value) : null; }

async function fetchRole(){
  const { data, error } = await sb.from("profiles").select("role").eq("id", user.id).maybeSingle();
  if(error){ setCloud("role error: "+error.message, "bad"); return "viewer"; }
  return data?.role || "viewer";
}
function setEnabled(){
  const authed=!!user;
  btnLogout.disabled=!authed;
  btnReload.disabled=!authed;
  btnAdd.disabled=!(authed && isEditor());
  btnSave.disabled=!(authed && isEditor());
  btnDelete.style.display=(authed && isEditor() && selectedId) ? "" : "none";
}

function tableDef(){
  if(tab==="debitate"){
    return {table:"debitate_rows", orderCol:"data", sumCol:"total_kg",
      cols:[["an","An"],["luna","Luna"],["data","Data"],["echipament","Echipament"],["reper","Reper"],["diametru","Diametru"],["calitate","Calitate"],
            ["kg_buc","Kg/buc"],["lungime_mm","Lungime mm"],["cod_intern","Cod intern"],["cantitate_buc","Cantitate"],["schimb","Schimb"],["total_kg","Total kg"],
            ["week_nr","week nr."],["operator","Operator"],["procent_norma","% normă"],["ore_lucrate","Ore"]]
    };
  }
  if(tab==="intrari"){
    return {table:"intrari_otel_rows", orderCol:"data", sumCol:"cantitate_kg",
      cols:[["an","An"],["luna","Luna"],["data","Data intrar"],["diametru","Dimensiune oțel"],["calitate","Calitate oțel"],
            ["cod_intern","Cod intern"],["sarja","Sarja"],["cantitate_kg","Cantitate (kg)"],["pretest","Pretest"],["furnizor","Furnizor"]]
    };
  }
  return {table:"numeralkod_rows", orderCol:"cod", sumCol:null,
    cols:[["cod","Cod"],["descriere","Descriere"],["tip","Tip"]]
  };
}

function render(){
  const def=tableDef();
  thead.innerHTML="<tr>"+def.cols.map(c=>`<th>${c[1]}</th>`).join("")+"</tr>";
  if(!user){ tbody.innerHTML='<tr><td class="hint">Neautentificat.</td></tr>'; return; }
  if(!rows.length){ tbody.innerHTML='<tr><td class="hint">Nu există rânduri.</td></tr>'; return; }
  tbody.innerHTML = rows.map(r=>`<tr data-id="${r.id}">` + def.cols.map(c=>`<td>${r[c[0]] ?? ""}</td>`).join("") + `</tr>`).join("");
  kpiRows.textContent = rows.length + " rânduri";
  if(def.sumCol){
    const s = rows.reduce((a,x)=>a+(Number(x[def.sumCol])||0),0);
    kpiTotal.textContent = s.toLocaleString("ro-RO",{maximumFractionDigits:3}) + " kg total";
  } else kpiTotal.textContent="";
  kpiLive.textContent="LIVE: "+(liveConnected?"conectat":"—");
}

async function loadRows(){
  if(!user) return;
  const def=tableDef();
  let q = sb.from(def.table).select("*").order(def.orderCol,{ascending:false}).limit(10000);
  const y=Number(fltYear.value)||null;
  const m=monthNo();
  if(def.table!=="numeralkod_rows"){
    if(y) q=q.eq("an",y);
    if(m) q=q.eq("luna",String(m));
  }
  const { data, error } = await q;
  if(error){ setCloud("load: "+error.message,"bad"); return; }
  rows=data||[];
  render();
  setCloud("ON","ok");
}

function openForm(edit=false){
  formCard.style.display="";
  formTitle.textContent = edit ? "Editează" : "Adaugă";
  const def=tableDef();
  const row = edit ? (rows.find(x=>String(x.id)===String(selectedId))||{}) : {};
  const exclude = new Set(["id","created_at","created_by"]);
  const fields = def.cols.map(c=>({k:c[0], lab:c[1]})).filter(f=>!exclude.has(f.k));
  formBody.innerHTML = fields.map(f=>{
    const v = row[f.k] ?? "";
    const type = f.k==="data" ? "date" : "text";
    return `<label>${f.lab}</label><input data-f="${f.k}" type="${type}" value="${String(v).replaceAll('"',"&quot;")}">`;
  }).join("");
  btnDelete.style.display = (edit && isEditor()) ? "" : "none";
  setEnabled();
}
function closeForm(){ formCard.style.display="none"; formBody.innerHTML=""; selectedId=null; btnDelete.style.display="none"; setEnabled(); }

function getPayload(){
  const p={};
  for(const el of formBody.querySelectorAll("input[data-f]")){
    const k=el.dataset.f;
    let v=el.value;
    if(["an","lungime_mm","cantitate_buc","schimb","week_nr"].includes(k)) v = v?Number(v):null;
    if(["kg_buc","total_kg","cantitate_kg","procent_norma","ore_lucrate"].includes(k)) v = v?Number(String(v).replace(",", ".")):null;
    p[k]=v;
  }
  if(p.luna!=null && p.luna!=="") p.luna=String(p.luna);
  if(tab==="debitate"){
    const kg=Number(p.kg_buc||0), buc=Number(p.cantitate_buc||0);
    p.total_kg = Number((kg*buc).toFixed(3));
  }
  return p;
}

async function insertRow(){
  const def=tableDef();
  const payload=getPayload();
  setCloud("salvez…","warn");
  const { data, error } = await sb.from(def.table).insert(payload).select("*").single();
  if(error){ setCloud("insert: "+error.message,"bad"); return; }
  rows.unshift(data); render(); closeForm(); setCloud("ON","ok");
}
async function updateRow(){
  const def=tableDef();
  const payload=getPayload();
  setCloud("actualizez…","warn");
  const { data, error } = await sb.from(def.table).update(payload).eq("id",selectedId).select("*").single();
  if(error){ setCloud("update: "+error.message,"bad"); return; }
  const idx=rows.findIndex(x=>String(x.id)===String(selectedId));
  if(idx>=0) rows[idx]=data;
  render(); closeForm(); setCloud("ON","ok");
}
async function deleteRow(){
  const def=tableDef();
  if(!confirm("Ștergi rândul selectat?")) return;
  setCloud("șterg…","warn");
  const { error } = await sb.from(def.table).delete().eq("id",selectedId);
  if(error){ setCloud("delete: "+error.message,"bad"); return; }
  rows=rows.filter(x=>String(x.id)!==String(selectedId));
  render(); closeForm(); setCloud("ON","ok");
}

tbody.addEventListener("click",(ev)=>{
  const tr=ev.target.closest("tr[data-id]");
  if(!tr) return;
  selectedId=tr.dataset.id;
  if(isEditor()) openForm(true);
});

btnAdd.addEventListener("click", ()=>openForm(false));
btnCancel.addEventListener("click", closeForm);
btnSave.addEventListener("click", async ()=>{
  if(!isEditor()) return;
  if(selectedId) await updateRow(); else await insertRow();
});
btnDelete.addEventListener("click", async ()=>{ if(isEditor() && selectedId) await deleteRow(); });

btnReload.addEventListener("click", loadRows);
fltYear.addEventListener("change", loadRows);
fltMonth.addEventListener("change", loadRows);

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===t));
    tab=t.dataset.tab; rows=[]; closeForm(); render(); subscribeRealtime(); loadRows();
  });
});

let channel=null;
function subscribeRealtime(){
  if(!user) return;
  if(channel){ sb.removeChannel(channel); channel=null; }
  const def=tableDef();
  liveConnected=false; render();
  channel = sb.channel("rf-v15-"+def.table)
    .on("postgres_changes",{event:"*",schema:"public",table:def.table}, (p)=>{
      liveConnected=true;
      if(p.eventType==="INSERT"){
        if(!rows.some(x=>String(x.id)===String(p.new.id))) rows.unshift(p.new);
      } else if(p.eventType==="UPDATE"){
        const idx=rows.findIndex(x=>String(x.id)===String(p.new.id));
        if(idx>=0) rows[idx]=p.new;
      } else if(p.eventType==="DELETE"){
        const id=p.old?.id;
        rows=rows.filter(x=>String(x.id)!==String(id));
      }
      render();
      setCloud("ON (LIVE)","ok");
    })
    .subscribe((s)=>{
      if(s==="SUBSCRIBED"){ liveConnected=true; setCloud("ON (LIVE)","ok"); }
      else if(s==="CHANNEL_ERROR"){ setCloud("LIVE: error","bad"); }
      else setCloud("LIVE: "+s,"warn");
      render();
    });
}

// AUTH
btnSignup.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  const { error } = await sb.auth.signUp({ email:e, password:p });
  if(error) return alert("Signup: "+error.message);
  alert("Cont creat.");
});
btnLogin.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  setCloud("autentific…","warn");
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
  if(error){ setCloud("login: "+error.message,"bad"); return; }
  user=data.user; role=await fetchRole();
  setUserPill(); setEnabled();
  await loadRows(); subscribeRealtime();
});
btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  user=null; role="viewer"; rows=[]; selectedId=null;
  if(channel){ sb.removeChannel(channel); channel=null; }
  liveConnected=false;
  setUserPill(); setEnabled(); render(); setCloud("standby","warn");
});

(function init(){
  fltYear.value=String(new Date().getFullYear());
  setUserPill(); setEnabled(); render();
  sb.auth.getSession().then(async ({data})=>{
    if(data?.session?.user){
      user=data.session.user; role=await fetchRole();
      setUserPill(); setEnabled();
      await loadRows(); subscribeRealtime();
      setCloud("ON","ok");
    }
  });
})();
</script>

</body>
</html>
