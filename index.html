<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raport Forja • LIVE</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --line:#24314d; --text:#e8efff; --muted:#8ea0c0;
      --btn:#2a3cff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    a{color:#9bb6ff}
    header{
      position:sticky; top:0; z-index:10;
      padding:14px 16px; border-bottom:1px solid var(--line);
      background:rgba(11,15,25,.9); backdrop-filter: blur(10px);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand b{letter-spacing:.2px}
    .muted{color:var(--muted); font-size:12px}
    .pill{padding:4px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{
      border:0; border-radius:10px; padding:10px 12px; cursor:pointer;
      background:var(--btn); color:white; font-weight:700;
    }
    button.secondary{background:#1b2540}
    button.danger{background:#b00020}
    button:disabled{opacity:.5; cursor:not-allowed}
    input, select, textarea{
      width:100%; padding:10px 10px; border-radius:10px; border:1px solid var(--line);
      background:#0e1526; color:var(--text); outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px; align-items:start;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px}
    .title{font-weight:800; margin:0 0 8px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    hr{border:0; border-top:1px solid var(--line); margin:12px 0}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{background:#0e1526; border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px}
    .tab.active{background:#182446; border-color:#35518f}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-weight:700; position:sticky; top:0; background:rgba(18,26,42,.98); backdrop-filter: blur(8px)}
    .table-wrap{overflow:auto; border:1px solid var(--line); border-radius:12px; max-height:70vh}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .pill{color:var(--text)}
    .ok{border-color:rgba(22,163,74,.35); color:#bbf7d0}
    .warn{border-color:rgba(245,158,11,.35); color:#fde68a}
    .bad{border-color:rgba(239,68,68,.35); color:#fecaca}

    /* Mobile */
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .table-wrap{max-height:55vh}
      button{padding:10px 12px}
      th,td{white-space:nowrap}
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>Raport Forja • LIVE</b>
    <div class="muted">Realtime pe rânduri (INTRARI_OTEL + DEBITATE) • build v11</div>
  </div>
  <div class="row">
    <span id="cloudPill" class="pill warn">Cloud: standby</span>
    <span id="userPill" class="pill">neautentificat</span>
    <button id="btnLogout" class="secondary" disabled>Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- AUTH + SETTINGS -->
    <div class="card" id="authCard">
      <div class="title">Autentificare</div>
      <div class="muted">Login Supabase. Rol: viewer = vede; editor/admin = adaugă/editează. LIVE înseamnă că pe celălalt laptop apare imediat.</div>

      <label>Email</label>
      <input id="email" type="email" placeholder="nume@firma.ro" />

      <label>Parolă</label>
      <input id="password" type="password" placeholder="••••••••" />

      <div class="row" style="margin-top:12px">
        <button id="btnLogin">Intră</button>
        <button id="btnSignup" class="secondary">Creează cont</button>
      </div>

      <hr>

      <div class="title" style="margin:0 0 6px">Filtru rapid</div>
      <div class="row">
        <div style="flex:1; min-width:120px">
          <label>An</label>
          <input id="fltYear" type="number" min="2020" step="1" />
        </div>
        <div style="flex:1; min-width:160px">
          <label>Luna</label>
          <select id="fltMonth">
            <option value="">(toate)</option>
            <option value="1">Ianuarie</option><option value="2">Februarie</option><option value="3">Martie</option>
            <option value="4">Aprilie</option><option value="5">Mai</option><option value="6">Iunie</option>
            <option value="7">Iulie</option><option value="8">August</option><option value="9">Septembrie</option>
            <option value="10">Octombrie</option><option value="11">Noiembrie</option><option value="12">Decembrie</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnReload" class="secondary" disabled>Reîncarcă</button>
      </div>

      <hr>
      <div class="muted">
        <b>Import Excel:</b> mergi în Excel, selectezi rânduri, Ctrl+C, apoi pe tab-ul paginii (INTRARI/DEBITATE) lipești în “Import (paste)”. Se parsează TSV.
      </div>
    </div>

    <!-- APP -->
    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="intrari">INTRARI_OTEL</div>
        <div class="tab" data-tab="debitate">DEBITATE</div>
      </div>

      <div id="kpiRow" class="kpi" style="margin-top:10px">
        <span class="pill ok" id="kpiRole">Rol: -</span>
        <span class="pill" id="kpiRows">Rânduri: -</span>
        <span class="pill" id="kpiLive">LIVE: -</span>
      </div>

      <hr>

      <!-- INTRARI -->
      <div id="view_intrari">
        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:180px">
            <label>Data intrare</label>
            <input id="in_data" type="date" />
          </div>
          <div style="flex:1; min-width:140px">
            <label>Diametru</label>
            <input id="in_diam" placeholder="ex: 35" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Calitate</label>
            <input id="in_cal" placeholder="ex: 20MnCr5" />
          </div>
          <div style="flex:1; min-width:140px">
            <label>Cod intern</label>
            <input id="in_cod" placeholder="ex: NNN" />
          </div>
        </div>

        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:180px">
            <label>Sarja</label>
            <input id="in_sarja" placeholder="ex: 12345" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Cantitate (kg)</label>
            <input id="in_kg" type="number" step="0.001" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Pretest</label>
            <select id="in_pretest">
              <option value="Nu are pretest">Nu are pretest</option>
              <option value="Are pretest">Are pretest</option>
            </select>
          </div>
          <div style="flex:1; min-width:200px">
            <label>Furnizor</label>
            <input id="in_furn" placeholder="ex: Cognor" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnAddIntrare" disabled>Adaugă intrare</button>
          <button id="btnClearIntrare" class="secondary" disabled>Golește</button>
        </div>

        <label style="margin-top:14px">Import (paste din Excel)</label>
        <textarea id="imp_intrari" placeholder="Lipește aici (TSV). Coloane acceptate: Data, Diametru, Calitate, CodIntern, Sarja, Kg, Pretest, Furnizor"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnImportIntrari" class="secondary" disabled>Import intrări</button>
        </div>

        <hr>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Diametru</th><th>Calitate</th><th>Cod</th><th>Sarja</th><th>Kg</th><th>Pretest</th><th>Furnizor</th><th>—</th>
              </tr>
            </thead>
            <tbody id="tbody_intrari">
              <tr><td colspan="9" class="muted">Neautentificat.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DEBITATE -->
      <div id="view_debitate" style="display:none">
        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:180px">
            <label>Data</label>
            <input id="db_data" type="date" />
          </div>
          <div style="flex:1; min-width:140px">
            <label>Echipament</label>
            <input id="db_echip" placeholder="ex: Fierastrau 1" />
          </div>
          <div style="flex:1; min-width:170px">
            <label>Reper</label>
            <input id="db_reper" placeholder="ex: 229-6909" />
          </div>
          <div style="flex:1; min-width:120px">
            <label>Schimb</label>
            <select id="db_schimb"><option>1</option><option>2</option><option>3</option></select>
          </div>
        </div>

        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:120px">
            <label>Diametru</label>
            <input id="db_diam" placeholder="ex: 35" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Calitate</label>
            <input id="db_cal" placeholder="ex: 20MnCr5" />
          </div>
          <div style="flex:1; min-width:120px">
            <label>Kg/buc</label>
            <input id="db_kgbuc" type="number" step="0.001" />
          </div>
          <div style="flex:1; min-width:140px">
            <label>Lungime (mm)</label>
            <input id="db_lung" type="number" step="1" />
          </div>
        </div>

        <div class="row" style="gap:12px">
          <div style="flex:1; min-width:140px">
            <label>Cod intern</label>
            <input id="db_cod" placeholder="ex: NNN" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Cantitate (buc)</label>
            <input id="db_buc" type="number" step="1" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Operator</label>
            <input id="db_op" placeholder="ex: Adi" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Total kg (auto)</label>
            <input id="db_totkg" type="number" step="0.001" disabled />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnAddDebitare" disabled>Adaugă debitare</button>
          <button id="btnClearDebitare" class="secondary" disabled>Golește</button>
        </div>

        <label style="margin-top:14px">Import (paste din Excel)</label>
        <textarea id="imp_debitate" placeholder="Lipește aici (TSV). Coloane acceptate: Data, Echipament, Reper, Diametru, Calitate, KgBuc, Lungime, CodIntern, Buc, Schimb, Operator"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnImportDebitari" class="secondary" disabled>Import debitări</button>
        </div>

        <hr>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Echip.</th><th>Reper</th><th>Diam.</th><th>Calitate</th><th>Kg/buc</th><th>Lung</th><th>Cod</th><th>Buc</th><th>Schimb</th><th>Op.</th><th>Total kg</th><th>—</th>
              </tr>
            </thead>
            <tbody id="tbody_debitate">
              <tr><td colspan="13" class="muted">Neautentificat.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // ========= CONFIG (completează în fișierul tău existent) =========
  // IMPORTANT: Păstrează aceleași valori pe care le ai deja în proiectul tău.
  const SUPABASE_URL = "SUPABASE_URL_HERE";
  const SUPABASE_ANON_KEY = "SUPABASE_ANON_KEY_HERE";

  // ========= Supabase client =========
  const { createClient } = window.supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // expose for debugging
  window.__SUPA__ = sb;

  // ========= State =========
  let user = null;
  let role = "viewer";
  let liveSub = null;
  let currentTab = "intrari";
  let rowsIntrari = [];
  let rowsDebitate = [];
  let liveConnected = false;

  // ========= UI =========
  const cloudPill = document.getElementById("cloudPill");
  const userPill  = document.getElementById("userPill");
  const btnLogout = document.getElementById("btnLogout");
  const btnLogin  = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnReload = document.getElementById("btnReload");
  const emailEl   = document.getElementById("email");
  const passEl    = document.getElementById("password");

  const fltYear   = document.getElementById("fltYear");
  const fltMonth  = document.getElementById("fltMonth");

  const kpiRole = document.getElementById("kpiRole");
  const kpiRows = document.getElementById("kpiRows");
  const kpiLive = document.getElementById("kpiLive");

  const viewIntrari = document.getElementById("view_intrari");
  const viewDebitate = document.getElementById("view_debitate");

  // Intrari inputs
  const in_data=document.getElementById("in_data");
  const in_diam=document.getElementById("in_diam");
  const in_cal=document.getElementById("in_cal");
  const in_cod=document.getElementById("in_cod");
  const in_sarja=document.getElementById("in_sarja");
  const in_kg=document.getElementById("in_kg");
  const in_pretest=document.getElementById("in_pretest");
  const in_furn=document.getElementById("in_furn");
  const btnAddIntrare=document.getElementById("btnAddIntrare");
  const btnClearIntrare=document.getElementById("btnClearIntrare");
  const imp_intrari=document.getElementById("imp_intrari");
  const btnImportIntrari=document.getElementById("btnImportIntrari");
  const tbody_intrari=document.getElementById("tbody_intrari");

  // Debitate inputs
  const db_data=document.getElementById("db_data");
  const db_echip=document.getElementById("db_echip");
  const db_reper=document.getElementById("db_reper");
  const db_schimb=document.getElementById("db_schimb");
  const db_diam=document.getElementById("db_diam");
  const db_cal=document.getElementById("db_cal");
  const db_kgbuc=document.getElementById("db_kgbuc");
  const db_lung=document.getElementById("db_lung");
  const db_cod=document.getElementById("db_cod");
  const db_buc=document.getElementById("db_buc");
  const db_op=document.getElementById("db_op");
  const db_totkg=document.getElementById("db_totkg");
  const btnAddDebitare=document.getElementById("btnAddDebitare");
  const btnClearDebitare=document.getElementById("btnClearDebitare");
  const imp_debitate=document.getElementById("imp_debitate");
  const btnImportDebitari=document.getElementById("btnImportDebitari");
  const tbody_debitate=document.getElementById("tbody_debitate");

  function setCloud(status, kind="warn"){
    cloudPill.classList.remove("ok","warn","bad");
    cloudPill.classList.add(kind);
    cloudPill.textContent = "Cloud: " + status;
  }

  function setUserPill(){
    if(!user){ userPill.textContent="neautentificat"; return; }
    userPill.textContent = user.email + " • " + role;
  }

  function isEditor(){ return role === "editor" || role === "admin"; }

  function setEnabled(){
    const authed = !!user;
    btnLogout.disabled = !authed;
    btnReload.disabled = !authed;

    btnAddIntrare.disabled = !(authed && isEditor());
    btnImportIntrari.disabled = !(authed && isEditor());
    btnClearIntrare.disabled = !authed;

    btnAddDebitare.disabled = !(authed && isEditor());
    btnImportDebitari.disabled = !(authed && isEditor());
    btnClearDebitare.disabled = !authed;
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }

  function monthNameToNumber(m){
    const map = {
      "ianuarie":1,"februarie":2,"martie":3,"aprilie":4,"mai":5,"iunie":6,
      "iulie":7,"august":8,"septembrie":9,"octombrie":10,"noiembrie":11,"decembrie":12
    };
    if(typeof m === "number") return m;
    if(!m) return null;
    const s = String(m).trim().toLowerCase();
    if(/^[0-9]+$/.test(s)) return Number(s);
    return map[s] || null;
  }

  function parseTSV(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length) return [];
    // detect header if first line contains non-date tokens
    const rows = lines.map(l => l.split("\t").map(c=>c.trim()));
    return rows;
  }

  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function updateKpi(){
    kpiRole.textContent = "Rol: " + (user ? role : "-");
    const n = currentTab==="intrari" ? rowsIntrari.length : rowsDebitate.length;
    kpiRows.textContent = "Rânduri: " + (user ? n : "-");
    kpiLive.textContent = "LIVE: " + (liveConnected ? "conectat" : "—");
    kpiLive.classList.toggle("ok", liveConnected);
  }

  function setTab(tab){
    currentTab = tab;
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===tab));
    viewIntrari.style.display = (tab==="intrari") ? "" : "none";
    viewDebitate.style.display = (tab==="debitate") ? "" : "none";
    updateKpi();
  }

  document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=>setTab(t.dataset.tab)));

  // ========= Role =========
  async function fetchRole(){
    if(!user) return "viewer";
    const { data, error } = await sb.from("profiles").select("role").eq("id", user.id).maybeSingle();
    if(error){
      // dacă nu poate citi profiles, rămâne viewer (dar afișăm cauza)
      console.warn("profiles role error", error);
      setCloud("role error: " + error.message, "bad");
      return "viewer";
    }
    return data?.role || "viewer";
  }

  // ========= Load data =========
  async function loadIntrari(){
    if(!user) return;
    const y = Number(fltYear.value) || null;
    const m = monthNameToNumber(fltMonth.value) || null;

    let q = sb.from("intrari_otel").select("*").order("data_intrare", { ascending:false }).limit(5000);
    if(y) q = q.eq("an", y);
    if(m) q = q.eq("luna_nr", m);

    const { data, error } = await q;
    if(error){ setCloud("intrari load error: "+error.message, "bad"); return; }
    rowsIntrari = data || [];
    renderIntrari();
  }

  async function loadDebitate(){
    if(!user) return;
    const y = Number(fltYear.value) || null;
    const m = monthNameToNumber(fltMonth.value) || null;

    let q = sb.from("debitate").select("*").order("data", { ascending:false }).limit(7000);
    if(y) q = q.eq("an", y);
    if(m) q = q.eq("luna_nr", m);

    const { data, error } = await q;
    if(error){ setCloud("debitate load error: "+error.message, "bad"); return; }
    rowsDebitate = data || [];
    renderDebitate();
  }

  async function reloadAll(){
    setCloud("încarc…","warn");
    await Promise.all([loadIntrari(), loadDebitate()]);
    setCloud("ON","ok");
    updateKpi();
  }

  // ========= Render =========
  function renderIntrari(){
    if(!user){ tbody_intrari.innerHTML = '<tr><td colspan="9" class="muted">Neautentificat.</td></tr>'; return; }
    if(!rowsIntrari.length){ tbody_intrari.innerHTML = '<tr><td colspan="9" class="muted">Nu există înregistrări.</td></tr>'; updateKpi(); return; }
    tbody_intrari.innerHTML = rowsIntrari.map(r => `
      <tr>
        <td>${esc(r.data_intrare)}</td>
        <td>${esc(r.diametru)}</td>
        <td>${esc(r.calitate)}</td>
        <td>${esc(r.cod_intern)}</td>
        <td>${esc(r.sarja)}</td>
        <td>${esc(r.cantitate_kg)}</td>
        <td>${esc(r.pretest)}</td>
        <td>${esc(r.furnizor)}</td>
        <td>${isEditor()?`<button class="secondary" data-del-in="${r.id}" style="padding:6px 10px">Șterge</button>`:""}</td>
      </tr>
    `).join("");
    updateKpi();
  }

  function renderDebitate(){
    if(!user){ tbody_debitate.innerHTML = '<tr><td colspan="13" class="muted">Neautentificat.</td></tr>'; return; }
    if(!rowsDebitate.length){ tbody_debitate.innerHTML = '<tr><td colspan="13" class="muted">Nu există înregistrări.</td></tr>'; updateKpi(); return; }
    tbody_debitate.innerHTML = rowsDebitate.map(r => `
      <tr>
        <td>${esc(r.data)}</td>
        <td>${esc(r.echipament)}</td>
        <td>${esc(r.reper)}</td>
        <td>${esc(r.diametru)}</td>
        <td>${esc(r.calitate)}</td>
        <td>${esc(r.kg_buc)}</td>
        <td>${esc(r.lungime_mm)}</td>
        <td>${esc(r.cod_intern)}</td>
        <td>${esc(r.cantitate_buc)}</td>
        <td>${esc(r.schimb)}</td>
        <td>${esc(r.operator)}</td>
        <td>${esc(r.total_kg)}</td>
        <td>${isEditor()?`<button class="secondary" data-del-db="${r.id}" style="padding:6px 10px">Șterge</button>`:""}</td>
      </tr>
    `).join("");
    updateKpi();
  }

  // ========= Delete handlers =========
  document.addEventListener("click", async (ev)=>{
    const b = ev.target.closest("button[data-del-in],button[data-del-db]");
    if(!b) return;
    if(!isEditor()) return;

    if(b.dataset.delIn){
      const id = b.dataset.delIn;
      if(!confirm("Ștergi intrarea?")) return;
      const { error } = await sb.from("intrari_otel").delete().eq("id", id);
      if(error){ setCloud("delete intrare: "+error.message,"bad"); return; }
      rowsIntrari = rowsIntrari.filter(x=>String(x.id)!==String(id));
      renderIntrari();
    }
    if(b.dataset.delDb){
      const id = b.dataset.delDb;
      if(!confirm("Ștergi debitarea?")) return;
      const { error } = await sb.from("debitate").delete().eq("id", id);
      if(error){ setCloud("delete debitare: "+error.message,"bad"); return; }
      rowsDebitate = rowsDebitate.filter(x=>String(x.id)!==String(id));
      renderDebitate();
    }
  });

  // ========= Add row =========
  function fillDefaults(){
    const y = new Date().getFullYear();
    fltYear.value = String(y);
    in_data.value = todayISO();
    db_data.value = todayISO();
  }

  function computeDbTotal(){
    const kg = Number(db_kgbuc.value||0);
    const buc = Number(db_buc.value||0);
    const tot = kg*buc;
    db_totkg.value = isFinite(tot) ? tot.toFixed(3) : "";
  }
  db_kgbuc.addEventListener("input", computeDbTotal);
  db_buc.addEventListener("input", computeDbTotal);

  btnClearIntrare.addEventListener("click", ()=>{
    in_data.value = todayISO(); in_diam.value=""; in_cal.value=""; in_cod.value="";
    in_sarja.value=""; in_kg.value=""; in_pretest.value="Nu are pretest"; in_furn.value="";
    imp_intrari.value="";
  });
  btnClearDebitare.addEventListener("click", ()=>{
    db_data.value=todayISO(); db_echip.value=""; db_reper.value=""; db_schimb.value="1";
    db_diam.value=""; db_cal.value=""; db_kgbuc.value=""; db_lung.value="";
    db_cod.value=""; db_buc.value=""; db_op.value=""; db_totkg.value="";
    imp_debitate.value="";
  });

  btnAddIntrare.addEventListener("click", async ()=>{
    if(!isEditor()) return;
    const d = in_data.value;
    const an = d ? Number(d.slice(0,4)) : null;
    const luna_nr = d ? Number(d.slice(5,7)) : null;
    const luna_txt = luna_nr ? String(luna_nr) : null;

    const payload = {
      an, luna_nr, luna_txt,
      data_intrare: d,
      diametru: in_diam.value.trim(),
      calitate: in_cal.value.trim(),
      cod_intern: in_cod.value.trim().toUpperCase(),
      sarja: in_sarja.value.trim(),
      cantitate_kg: Number(in_kg.value||0),
      pretest: in_pretest.value,
      furnizor: in_furn.value.trim(),
    };

    if(!payload.data_intrare || !payload.diametru || !payload.calitate) {
      alert("Completează minim: Data, Diametru, Calitate.");
      return;
    }

    setCloud("salvez intrare…","warn");
    const { data, error } = await sb.from("intrari_otel").insert(payload).select("*").single();
    if(error){ setCloud("intrare insert: "+error.message,"bad"); return; }
    rowsIntrari.unshift(data);
    renderIntrari();
    setCloud("ON","ok");
  });

  btnAddDebitare.addEventListener("click", async ()=>{
    if(!isEditor()) return;

    const d = db_data.value;
    const an = d ? Number(d.slice(0,4)) : null;
    const luna_nr = d ? Number(d.slice(5,7)) : null;
    const payload = {
      an, luna_nr,
      data: d,
      echipament: db_echip.value.trim(),
      reper: db_reper.value.trim().toUpperCase(),
      diametru: db_diam.value.trim(),
      calitate: db_cal.value.trim(),
      kg_buc: Number(db_kgbuc.value||0),
      lungime_mm: Number(db_lung.value||0),
      cod_intern: db_cod.value.trim().toUpperCase(),
      cantitate_buc: Number(db_buc.value||0),
      schimb: Number(db_schimb.value||1),
      operator: db_op.value.trim(),
      total_kg: Number(db_totkg.value||0),
    };

    if(!payload.data || !payload.echipament || !payload.reper) {
      alert("Completează minim: Data, Echipament, Reper.");
      return;
    }

    setCloud("salvez debitare…","warn");
    const { data, error } = await sb.from("debitate").insert(payload).select("*").single();
    if(error){ setCloud("debitate insert: "+error.message,"bad"); return; }
    rowsDebitate.unshift(data);
    renderDebitate();
    setCloud("ON","ok");
  });

  // ========= Import =========
  btnImportIntrari.addEventListener("click", async ()=>{
    if(!isEditor()) return;
    const rows = parseTSV(imp_intrari.value);
    if(!rows.length) return alert("Nu ai nimic lipit.");
    setCloud("import intrări…","warn");

    // accept: Data, Diametru, Calitate, CodIntern, Sarja, Kg, Pretest, Furnizor
    const payloads = [];
    for(const cols of rows){
      const d = cols[0] || "";
      if(!d) continue;
      const dateIso = d.includes("-") ? d : d.replaceAll(".","-"); // încercare
      const an = Number(dateIso.slice(0,4)) || null;
      const luna_nr = Number(dateIso.slice(5,7)) || null;
      payloads.push({
        an, luna_nr, luna_txt: luna_nr?String(luna_nr):null,
        data_intrare: dateIso,
        diametru: cols[1] || "",
        calitate: cols[2] || "",
        cod_intern: (cols[3]||"").toUpperCase(),
        sarja: cols[4] || "",
        cantitate_kg: Number((cols[5]||"0").replace(",", ".")) || 0,
        pretest: cols[6] || "Nu are pretest",
        furnizor: cols[7] || "",
      });
    }

    if(!payloads.length){ setCloud("import intrări: 0 rânduri","warn"); return; }

    const chunk = 500;
    for(let i=0;i<payloads.length;i+=chunk){
      const part = payloads.slice(i,i+chunk);
      const { error } = await sb.from("intrari_otel").insert(part);
      if(error){ setCloud("import intrări: "+error.message,"bad"); return; }
    }

    await loadIntrari();
    setCloud("ON","ok");
    alert("Import intrări OK: " + payloads.length);
  });

  btnImportDebitari.addEventListener("click", async ()=>{
    if(!isEditor()) return;
    const rows = parseTSV(imp_debitate.value);
    if(!rows.length) return alert("Nu ai nimic lipit.");
    setCloud("import debitări…","warn");

    // accept: Data, Echipament, Reper, Diametru, Calitate, KgBuc, Lungime, CodIntern, Buc, Schimb, Operator
    const payloads = [];
    for(const cols of rows){
      const d = cols[0] || "";
      if(!d) continue;
      const dateIso = d.includes("-") ? d : d.replaceAll(".","-");
      const an = Number(dateIso.slice(0,4)) || null;
      const luna_nr = Number(dateIso.slice(5,7)) || null;

      const kg_buc = Number((cols[5]||"0").replace(",", ".")) || 0;
      const buc = Number((cols[8]||"0").replace(",", ".")) || 0;
      payloads.push({
        an, luna_nr,
        data: dateIso,
        echipament: cols[1] || "",
        reper: (cols[2]||"").toUpperCase(),
        diametru: cols[3] || "",
        calitate: cols[4] || "",
        kg_buc,
        lungime_mm: Number((cols[6]||"0").replace(",", ".")) || 0,
        cod_intern: (cols[7]||"").toUpperCase(),
        cantitate_buc: buc,
        schimb: Number((cols[9]||"1").replace(",", ".")) || 1,
        operator: cols[10] || "",
        total_kg: Number((kg_buc*buc).toFixed(3)) || 0,
      });
    }

    if(!payloads.length){ setCloud("import debitări: 0 rânduri","warn"); return; }

    const chunk = 300;
    for(let i=0;i<payloads.length;i+=chunk){
      const part = payloads.slice(i,i+chunk);
      const { error } = await sb.from("debitate").insert(part);
      if(error){ setCloud("import debitări: "+error.message,"bad"); return; }
    }

    await loadDebitate();
    setCloud("ON","ok");
    alert("Import debitări OK: " + payloads.length);
  });

  // ========= Realtime =========
  function subscribeRealtime(){
    if(liveSub){ sb.removeChannel(liveSub); liveSub=null; }

    liveSub = sb.channel("rf-live-v11");

    liveSub
      .on("postgres_changes", { event: "*", schema: "public", table: "intrari_otel" }, payload => {
        liveConnected = true;
        applyChange("intrari", payload);
      })
      .on("postgres_changes", { event: "*", schema: "public", table: "debitate" }, payload => {
        liveConnected = true;
        applyChange("debitate", payload);
      })
      .subscribe((status) => {
        if(status === "SUBSCRIBED"){
          liveConnected = true;
          setCloud("LIVE conectat","ok");
        } else {
          setCloud("LIVE: "+status,"warn");
        }
        updateKpi();
      });
  }

  function applyChange(kind, payload){
    // payload: { eventType, new, old }
    const ev = payload.eventType;
    if(kind==="intrari"){
      if(ev==="INSERT"){
        rowsIntrari.unshift(payload.new);
      } else if(ev==="UPDATE"){
        const idx = rowsIntrari.findIndex(x=>String(x.id)===String(payload.new.id));
        if(idx>=0) rowsIntrari[idx] = payload.new;
      } else if(ev==="DELETE"){
        const id = payload.old?.id;
        rowsIntrari = rowsIntrari.filter(x=>String(x.id)!==String(id));
      }
      renderIntrari();
    } else {
      if(ev==="INSERT"){
        rowsDebitate.unshift(payload.new);
      } else if(ev==="UPDATE"){
        const idx = rowsDebitate.findIndex(x=>String(x.id)===String(payload.new.id));
        if(idx>=0) rowsDebitate[idx] = payload.new;
      } else if(ev==="DELETE"){
        const id = payload.old?.id;
        rowsDebitate = rowsDebitate.filter(x=>String(x.id)!==String(id));
      }
      renderDebitate();
    }
    updateKpi();
  }

  // ========= AUTH =========
  btnSignup.addEventListener("click", async ()=>{
    const e = emailEl.value.trim(), p = passEl.value;
    if(!e || !p) return alert("Completează email + parolă.");
    const { error } = await sb.auth.signUp({ email: e, password: p });
    if(error) return alert("Signup: "+error.message);
    alert("Cont creat. Dacă ai confirmare email, verifică emailul.");
  });

  btnLogin.addEventListener("click", async ()=>{
    const e = emailEl.value.trim(), p = passEl.value;
    if(!e || !p) return alert("Completează email + parolă.");
    setCloud("autentific…","warn");
    const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if(error){ setCloud("login: "+error.message, "bad"); return; }
    user = data.user;
    role = await fetchRole();
    setUserPill();
    setEnabled();
    setCloud("încarc date…","warn");
    await reloadAll();
    subscribeRealtime();
    setCloud("ON","ok");
  });

  btnLogout.addEventListener("click", async ()=>{
    await sb.auth.signOut();
    user = null; role="viewer";
    setUserPill(); setEnabled();
    rowsIntrari=[]; rowsDebitate=[];
    renderIntrari(); renderDebitate();
    if(liveSub){ sb.removeChannel(liveSub); liveSub=null; }
    liveConnected=false;
    setCloud("standby","warn");
    updateKpi();
  });

  btnReload.addEventListener("click", reloadAll);
  fltYear.addEventListener("change", reloadAll);
  fltMonth.addEventListener("change", reloadAll);

  // ========= Init =========
  (async ()=>{
    fillDefaults();
    setCloud("standby","warn");
    setUserPill();
    setEnabled();
    updateKpi();

    const { data } = await sb.auth.getSession();
    if(data?.session?.user){
      user = data.session.user;
      role = await fetchRole();
      setUserPill();
      setEnabled();
      await reloadAll();
      subscribeRealtime();
      setCloud("ON","ok");
    }
  })();
</script>

</body>
</html>
