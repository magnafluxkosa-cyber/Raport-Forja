<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Raport Forjă • LIVE (Design original) v17</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
      --navbg: rgba(15, 23, 42, .92);
      --navborder: rgba(148,163,184,.22);
      --navtext: #e5e7eb;
      --navmuted: #94a3b8;
      --accent: #22c55e;
    }

:root {
  --bg: #0b1020;
  --card: rgba(15, 23, 42, .72);
  --card2: rgba(15, 23, 42, .55);
  --border: rgba(148,163,184,.18);
  --text: #e5e7eb;
  --muted: #94a3b8;
  --accent: #22c55e;
  --accent2:#38bdf8;
  --danger:#ef4444;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.topnav{
  position:fixed; top:0; left:0; right:0; z-index:50;
  background:rgba(15, 23, 42, .92);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  padding:10px 12px;
  backdrop-filter: blur(10px);
}
.brand{font-weight:900; letter-spacing:.2px}
.tabs{display:flex; gap:8px; flex-wrap:wrap;}
.tab{
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--border);
  background:rgba(2,6,23,.35);
  color:var(--text);
  cursor:pointer;
  font-weight:800; font-size:12px;
}
.tab.active{border-color: rgba(34,197,94,.45); box-shadow: 0 0 0 1px rgba(34,197,94,.18) inset;}
.spacer{flex:1}
.pill{
  padding:4px 10px; border-radius:999px;
  border:1px solid var(--border);
  background:rgba(2,6,23,.35);
  color:var(--muted); font-size:12px;
}
.pill.ok{border-color: rgba(34,197,94,.45); color:#bbf7d0;}
.pill.bad{border-color: rgba(239,68,68,.45); color:#fecaca;}
.pill.warn{border-color: rgba(245,158,11,.45); color:#fde68a;}
button{
  border:0; border-radius:10px; padding:9px 12px; cursor:pointer;
  background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(16,185,129,.9));
  color:#06210f; font-weight:900;
}
button.secondary{background:rgba(2,6,23,.45); color:var(--text); border:1px solid var(--border);}
button.danger{background:rgba(239,68,68,.92); color:#fff;}
button:disabled{opacity:.55; cursor:not-allowed}
.container{padding:74px 12px 16px; max-width:1280px; margin:0 auto;}
.grid{display:grid; grid-template-columns: 1fr 380px; gap:12px; align-items:start;}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
}
.card .head{
  padding:10px 12px;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  border-bottom:1px solid var(--border);
  background: rgba(2,6,23,.25);
}
.kpi{display:flex; gap:8px; flex-wrap:wrap;}
.chip{
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--border);
  background:rgba(2,6,23,.35);
  color:var(--text);
  font-weight:800; font-size:12px;
}
.body{padding:12px}
.table-wrap{overflow:auto; max-height:70vh; background: rgba(2,6,23,.18);}
table{border-collapse:collapse; width:100%; min-width:1200px; font-size:12.5px;}
th,td{padding:8px 8px; border-bottom:1px solid rgba(148,163,184,.14); white-space:nowrap; text-align:left;}
th{position:sticky; top:0; background: rgba(15,23,42,.95); color:var(--muted); font-weight:900;}
.side{display:flex; flex-direction:column; gap:12px;}
label{display:block; font-size:12px; font-weight:900; color:var(--muted); margin:10px 0 6px;}
input,select,textarea{
  width:100%; padding:10px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.22);
  background:rgba(2,6,23,.35);
  color:var(--text);
  outline:none;
  font-size:16px;
}
textarea{min-height:90px; resize:vertical;}
.hint{font-size:12px; color:var(--muted); line-height:1.35}
.row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
@media (max-width: 980px){
  .grid{grid-template-columns:1fr}
  .table-wrap{max-height:55vh}
  table{min-width:1300px}
}
</style>
</head>
<body>

<div class="topnav">
  <div class="brand">Raport Forjă • LIVE</div>
  <div class="tabs">
    <div class="tab active" data-tab="debitate">DEBITATE</div>
    <div class="tab" data-tab="intrari">INTRARI_OTEL</div>
    <div class="tab" data-tab="numeralkod">NUMERALKOD</div>
  </div>
  <div class="spacer"></div>
  <span id="cloudPill" class="pill warn">Cloud: standby</span>
  <span id="userPill" class="pill">neautentificat</span>
  <button id="btnLogout" class="secondary" disabled>Logout</button>
</div>

<div class="container">
  <div class="grid">

    <div class="card">
      <div class="head">
        <div class="kpi">
          <button id="btnAdd" disabled>➕ Adaugă</button>
          <span class="chip" id="kpiRows">0 rânduri</span>
          <span class="chip" id="kpiTotal">—</span>
          <span class="chip" id="kpiLive">LIVE: —</span>
        </div>
        <div class="spacer"></div>
        <button id="btnReload" class="secondary" disabled>Reîncarcă</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="hint">Neautentificat.</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="side">

      <div class="card">
        <div class="head"><b>Autentificare</b></div>
        <div class="body">
          <div class="hint">Viewer vede. Editor/Admin adaugă + importă. LIVE = apare instant pe alt laptop (fără refresh).</div>
          <label>Email</label>
          <input id="email" type="email" placeholder="nume@firma.ro"/>
          <label>Parolă</label>
          <input id="password" type="password" placeholder="••••••••"/>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button id="btnLogin" class="secondary">Intră</button>
            <button id="btnSignup" class="secondary">Creează cont</button>
          </div>
          <div class="hint" style="margin-top:10px">Rolurile se citesc din <span class="mono">profiles.role</span>.</div>
        </div>
      </div>

      <div class="card">
        <div class="head"><b>Filtre</b></div>
        <div class="body">
          <div class="row2">
            <div>
              <label>An</label>
              <input id="fltYear" type="number" min="2020" step="1"/>
            </div>
            <div>
              <label>Lună</label>
              <select id="fltMonth">
                <option value="">(toate)</option>
                <option value="1">Ianuarie</option><option value="2">Februarie</option><option value="3">Martie</option>
                <option value="4">Aprilie</option><option value="5">Mai</option><option value="6">Iunie</option>
                <option value="7">Iulie</option><option value="8">August</option><option value="9">Septembrie</option>
                <option value="10">Octombrie</option><option value="11">Noiembrie</option><option value="12">Decembrie</option>
              </select>
            </div>
          </div>
          <div class="hint" style="margin-top:10px">Filtru DB pentru DEBITATE/INTRARI. NUMERALKOD nu folosește filtru.</div>
        </div>
      </div>

      <div class="card">
        <div class="head"><b>Import Excel (Copy‑Paste)</b></div>
        <div class="body">
          <div class="hint">Excel: selectezi rânduri → Ctrl+C. Aici: Ctrl+V (TSV cu TAB).<br><span class="mono" id="importHint"></span></div>
          <label>Paste aici</label>
          <textarea id="impText" placeholder="Lipește aici rândurile din Excel..."></textarea>
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px">
            <button id="btnImport" class="secondary" disabled>Import</button>
            <span id="impProgress" class="chip">—</span>
          </div>
        </div>
      </div>

      <div class="card" id="formCard" style="display:none">
        <div class="head"><b id="formTitle">Adaugă</b></div>
        <div class="body">
          <div id="formBody"></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
            <button id="btnSave" class="secondary" disabled>Salvează</button>
            <button id="btnCancel" class="secondary">Renunță</button>
            <button id="btnDelete" class="danger" style="display:none">Șterge</button>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});
window.__SUPA__ = sb;

let user=null, role="viewer";
let liveConnected=false;
let tab="debitate";
let selectedId=null;
let rows=[];
let channel=null;

const cloudPill=document.getElementById("cloudPill");
const userPill=document.getElementById("userPill");
const btnLogout=document.getElementById("btnLogout");
const btnReload=document.getElementById("btnReload");
const btnAdd=document.getElementById("btnAdd");
const kpiRows=document.getElementById("kpiRows");
const kpiTotal=document.getElementById("kpiTotal");
const kpiLive=document.getElementById("kpiLive");
const thead=document.getElementById("thead");
const tbody=document.getElementById("tbody");

const emailEl=document.getElementById("email");
const passEl=document.getElementById("password");
const btnLogin=document.getElementById("btnLogin");
const btnSignup=document.getElementById("btnSignup");

const fltYear=document.getElementById("fltYear");
const fltMonth=document.getElementById("fltMonth");

const impText=document.getElementById("impText");
const btnImport=document.getElementById("btnImport");
const impProgress=document.getElementById("impProgress");
const importHint=document.getElementById("importHint");

const formCard=document.getElementById("formCard");
const formTitle=document.getElementById("formTitle");
const formBody=document.getElementById("formBody");
const btnSave=document.getElementById("btnSave");
const btnCancel=document.getElementById("btnCancel");
const btnDelete=document.getElementById("btnDelete");

function setCloud(txt, kind="warn"){
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(kind);
  cloudPill.textContent = "Cloud: " + txt;
}
function setUserPill(){ userPill.textContent = user ? (user.email + " • " + role) : "neautentificat"; }
function isEditor(){ return role==="editor" || role==="admin"; }
function monthNo(){ return fltMonth.value ? Number(fltMonth.value) : null; }

function parseTSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trimEnd()).filter(l=>l.trim().length);
  return lines.map(l => l.split("\t").map(c=>c.trim()));
}
function num(x){ if(x==null) return null; const s=String(x).trim(); if(!s) return null; const v=Number(s.replace(",", ".")); return Number.isFinite(v)?v:null; }
function intv(x){ const v=num(x); return v==null?null:Math.trunc(v); }
function asISODate(x){
  if(!x) return null;
  const s=String(x).trim();
  if(/\d{2}\.\d{2}\.\d{4}/.test(s)){ const [dd,mm,yyyy]=s.split("."); return `${yyyy}-${mm}-${dd}`; }
  if(/\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  return s;
}

async function fetchRole(){
  const { data, error } = await sb.from("profiles").select("role").eq("id", user.id).maybeSingle();
  if(error){ setCloud("role error: "+error.message, "bad"); return "viewer"; }
  return data?.role || "viewer";
}

function setEnabled(){
  const authed = !!user;
  btnLogout.disabled = !authed;
  btnReload.disabled = !authed;
  btnAdd.disabled = !(authed && isEditor());
  btnSave.disabled = !(authed && isEditor());
  btnImport.disabled = !(authed && isEditor());
  btnDelete.style.display = (authed && isEditor() && selectedId) ? "" : "none";
}

function def(){
  if(tab==="debitate") return {
    table:"debitate", orderCol:"data", sumCol:"total_kg",
    cols:[["an","An"],["luna_nr","Luna"],["data","Data"],["echipament","Echipament"],["reper","Reper"],["diametru","Diametru"],["calitate","Calitate"],["kg_buc","Kg/buc"],["lungime_mm","Lungime"],["cod_intern","Cod"],["cantitate_buc","Buc"],["schimb","Schimb"],["total_kg","Total kg"],["week_nr","Week"],["operator","Operator"],["procent_norma","% normă"],["ore_lucrate","Ore"]],
    hint:"DEBITATE TSV: Data | Echipament | Reper | Diametru | Calitate | KgBuc | Lungime | CodIntern | Buc | Schimb | Operator"
  };
  if(tab==="intrari") return {
    table:"intrari_otel", orderCol:"data", sumCol:"cantitate_kg",
    cols:[["an","An"],["luna_nr","Luna"],["data","Data"],["diametru","Diametru"],["calitate","Calitate"],["cod_intern","Cod"],["sarja","Sarja"],["cantitate_kg","Kg"],["pretest","Pretest"],["furnizor","Furnizor"]],
    hint:"INTRARI TSV: Data | Diametru | Calitate | CodIntern | Sarja | Kg | Pretest | Furnizor"
  };
  return {
    table:"numeralkod", orderCol:"cod", sumCol:null,
    cols:[["cod","Cod"],["descriere","Descriere"],["tip","Tip"]],
    hint:"NUMERALKOD TSV: Cod | Descriere | Tip"
  };
}

function render(){
  const d = def();
  importHint.textContent = d.hint;
  thead.innerHTML = "<tr>" + d.cols.map(c=>`<th>${c[1]}</th>`).join("") + "</tr>";

  if(!user){ tbody.innerHTML = '<tr><td class="hint">Neautentificat.</td></tr>'; return; }
  if(!rows.length){ tbody.innerHTML = '<tr><td class="hint">Nu există rânduri.</td></tr>'; kpiRows.textContent="0 rânduri"; kpiTotal.textContent="—"; return; }

  tbody.innerHTML = rows.map(r => `<tr data-id="${r.id}">` + d.cols.map(c=>`<td>${r[c[0]] ?? ""}</td>`).join("") + "</tr>").join("");
  kpiRows.textContent = rows.length + " rânduri";
  if(d.sumCol){
    const s = rows.reduce((a,x)=>a+(Number(x[d.sumCol])||0),0);
    kpiTotal.textContent = s.toLocaleString("ro-RO",{maximumFractionDigits:3}) + " kg";
  } else {
    kpiTotal.textContent = "—";
  }
  kpiLive.textContent = "LIVE: " + (liveConnected ? "conectat" : "—");
}

async function loadRows(){
  if(!user) return;
  const d = def();
  let q = sb.from(d.table).select("*").order(d.orderCol,{ascending:false}).limit(10000);
  const y = Number(fltYear.value)||null;
  const m = monthNo();
  if(d.table!=="numeralkod") {
    if(y) q=q.eq("an",y);
    if(m) q=q.eq("luna_nr",m);
  }
  const { data, error } = await q;
  if(error){ setCloud("load: "+error.message, "bad"); return; }
  rows = data || [];
  render();
  setCloud(liveConnected ? "ON (LIVE)" : "ON", liveConnected ? "ok" : "warn");
}

function openForm(edit=false){
  formCard.style.display = "";
  formTitle.textContent = edit ? "Editează" : "Adaugă";
  const d = def();
  const row = edit ? (rows.find(x=>String(x.id)===String(selectedId))||{}) : {};
  const exclude = new Set(["id","created_at","created_by"]);
  const fields = d.cols.map(c=>({k:c[0], lab:c[1]})).filter(f=>!exclude.has(f.k));
  formBody.innerHTML = fields.map(f=>{
    const v = row[f.k] ?? "";
    const type = f.k==="data" ? "date" : "text";
    return `<label>${f.lab}</label><input data-f="${f.k}" type="${type}" value="${String(v).replaceAll('"',"&quot;")}">`;
  }).join("");
  btnDelete.style.display = (edit && isEditor()) ? "" : "none";
  setEnabled();
}
function closeForm(){ formCard.style.display="none"; formBody.innerHTML=""; selectedId=null; btnDelete.style.display="none"; setEnabled(); }

function getPayload(){
  const p={};
  for(const el of formBody.querySelectorAll("input[data-f]")){
    const k=el.dataset.f;
    let v=el.value;
    if(["an","luna_nr","lungime_mm","cantitate_buc","schimb","week_nr"].includes(k)) v=v?intv(v):null;
    if(["kg_buc","total_kg","cantitate_kg","procent_norma","ore_lucrate"].includes(k)) v=v?num(v):null;
    p[k]=v;
  }
  if(p.data) {
    const iso = asISODate(p.data);
    p.data = iso;
    if(!p.an) p.an=intv(iso.slice(0,4));
    if(!p.luna_nr) p.luna_nr=intv(iso.slice(5,7));
  }
  if(tab==="debitate") {
    const kg=Number(p.kg_buc||0), buc=Number(p.cantitate_buc||0);
    p.total_kg = Number((kg*buc).toFixed(3));
  }
  if(p.cod_intern) p.cod_intern=String(p.cod_intern).toUpperCase();
  if(p.reper) p.reper=String(p.reper).toUpperCase();
  if(p.cod) p.cod=String(p.cod).toUpperCase();
  return p;
}

async function insertRow(){
  const d=def(); const payload=getPayload();
  setCloud("salvez…","warn");
  const { data, error } = await sb.from(d.table).insert(payload).select("*").single();
  if(error){ setCloud("insert: "+error.message,"bad"); return; }
  if(!rows.some(x=>String(x.id)===String(data.id))) rows.unshift(data);
  render(); closeForm(); setCloud("ON (LIVE)","ok");
}
async function updateRow(){
  const d=def(); const payload=getPayload();
  setCloud("actualizez…","warn");
  const { data, error } = await sb.from(d.table).update(payload).eq("id",selectedId).select("*").single();
  if(error){ setCloud("update: "+error.message,"bad"); return; }
  const idx=rows.findIndex(x=>String(x.id)===String(selectedId));
  if(idx>=0) rows[idx]=data;
  render(); closeForm(); setCloud("ON (LIVE)","ok");
}
async function deleteRow(){
  const d=def();
  if(!confirm("Ștergi rândul selectat?")) return;
  setCloud("șterg…","warn");
  const { error } = await sb.from(d.table).delete().eq("id",selectedId);
  if(error){ setCloud("delete: "+error.message,"bad"); return; }
  rows = rows.filter(x=>String(x.id)!==String(selectedId));
  render(); closeForm(); setCloud("ON (LIVE)","ok");
}

tbody.addEventListener("click",(ev)=>{
  const tr=ev.target.closest("tr[data-id]");
  if(!tr) return;
  selectedId=tr.dataset.id;
  if(isEditor()) openForm(true);
});
btnAdd.addEventListener("click",()=>openForm(false));
btnCancel.addEventListener("click",closeForm);
btnSave.addEventListener("click",async()=>{ if(!isEditor()) return; if(selectedId) await updateRow(); else await insertRow(); });
btnDelete.addEventListener("click",async()=>{ if(isEditor() && selectedId) await deleteRow(); });

btnReload.addEventListener("click",loadRows);
fltYear.addEventListener("change",loadRows);
fltMonth.addEventListener("change",loadRows);

async function importBatch(){
  if(!isEditor()) return;
  const d=def();
  const tsv=parseTSV(impText.value);
  if(!tsv.length) return alert("Nu ai lipit nimic.");
  setCloud("import…","warn");
  impProgress.textContent="parse…";

  let payloads=[];
  if(tab==="debitate") {
    for(const c of tsv) {
      const iso=asISODate(c[0]); if(!iso) continue;
      const an=intv(iso.slice(0,4)), luna_nr=intv(iso.slice(5,7));
      const kg_buc=num(c[5])||0; const buc=intv(c[8])||0;
      payloads.push({
        an,luna_nr,data:iso,echipament:c[1]||"",reper:(c[2]||"").toUpperCase(),
        diametru:c[3]||"",calitate:c[4]||"",kg_buc,lungime_mm:intv(c[6])||0,
        cod_intern:(c[7]||"").toUpperCase(),cantitate_buc:buc,schimb:intv(c[9])||1,
        operator:c[10]||"",total_kg:Number((kg_buc*buc).toFixed(3))
      });
    }
  } else if(tab==="intrari") {
    for(const c of tsv) {
      const iso=asISODate(c[0]); if(!iso) continue;
      const an=intv(iso.slice(0,4)), luna_nr=intv(iso.slice(5,7));
      payloads.push({
        an,luna_nr,data:iso,diametru:c[1]||"",calitate:c[2]||"",
        cod_intern:(c[3]||"").toUpperCase(),sarja:c[4]||"",
        cantitate_kg:num(c[5])||0,pretest:c[6]||"Nu are pretest",furnizor:c[7]||""
      });
    }
  } else {
    for(const c of tsv) {
      const cod=(c[0]||"").toUpperCase(); if(!cod) continue;
      payloads.push({cod,descriere:c[1]||"",tip:c[2]||""});
    }
  }

  if(!payloads.length){ impProgress.textContent="0"; setCloud("import: 0","warn"); return; }

  const CHUNK = tab==="debitate" ? 250 : 500;
  let done=0;
  for(let i=0;i<payloads.length;i+=CHUNK){
    const part=payloads.slice(i,i+CHUNK);
    impProgress.textContent=`${done}/${payloads.length}`;
    const { error } = await sb.from(d.table).insert(part);
    if(error){ setCloud("import: "+error.message,"bad"); impProgress.textContent="eroare"; return; }
    done += part.length;
  }
  impProgress.textContent=`${payloads.length}/${payloads.length} OK`;
  impText.value="";
  await loadRows();
  setCloud("ON (LIVE)","ok");
}
btnImport.addEventListener("click",importBatch);

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active", x===t));
    tab=t.dataset.tab;
    rows=[]; selectedId=null; closeForm(); render();
    subscribeRealtime();
    loadRows();
  });
});

function subscribeRealtime(){
  if(!user) return;
  if(channel){ sb.removeChannel(channel); channel=null; }
  const d=def();
  liveConnected=false;
  channel = sb.channel("rf-live-v17-"+d.table)
    .on("postgres_changes",{event:"*",schema:"public",table:d.table}, (p)=>{
      liveConnected=true;
      if(p.eventType==="INSERT") {
        if(!rows.some(x=>String(x.id)===String(p.new.id))) rows.unshift(p.new);
      } else if(p.eventType==="UPDATE") {
        const idx=rows.findIndex(x=>String(x.id)===String(p.new.id));
        if(idx>=0) rows[idx]=p.new;
      } else if(p.eventType==="DELETE") {
        const id=p.old?.id;
        rows=rows.filter(x=>String(x.id)!==String(id));
      }
      render();
      setCloud("ON (LIVE)","ok");
    })
    .subscribe((s)=>{
      if(s==="SUBSCRIBED"){ liveConnected=true; setCloud("ON (LIVE)","ok"); }
      else if(s==="CHANNEL_ERROR"){ setCloud("LIVE: error","bad"); }
      else { setCloud("LIVE: "+s,"warn"); }
      render();
    });
}

// AUTH
btnSignup.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  const { error } = await sb.auth.signUp({ email:e, password:p });
  if(error) return alert("Signup: "+error.message);
  alert("Cont creat.");
});
btnLogin.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  setCloud("autentific…","warn");
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
  if(error){ setCloud("login: "+error.message,"bad"); return; }
  user=data.user; role=await fetchRole();
  setUserPill(); setEnabled();
  render();
  await loadRows();
  subscribeRealtime();
});
btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  user=null; role="viewer"; rows=[]; selectedId=null;
  if(channel){ sb.removeChannel(channel); channel=null; }
  liveConnected=false;
  setUserPill(); setEnabled(); render(); setCloud("standby","warn");
});

(function init(){
  fltYear.value = String(new Date().getFullYear());
  setUserPill(); setEnabled(); render();
  sb.auth.getSession().then(async ({data})=>{
    if(data?.session?.user){
      user=data.session.user; role=await fetchRole();
      setUserPill(); setEnabled();
      await loadRows();
      subscribeRealtime();
      setCloud("ON (LIVE)","ok");
    }
  });
})();
</script>

</body>
</html>
