<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raport Forjă • LIVE v16</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b1220;--line:rgba(255,255,255,.12);--text:#eaf2ff;--muted:#a9c0e3;--btn:#223a6a;--btn2:#1f2f55;--panel:#cfe6f7;--panel2:#bfe0f6;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    .topbar{background:linear-gradient(180deg,#081632,#07122a);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;position:sticky;top:0;z-index:10;}
    .brand{font-weight:900}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tab{background:#0b1a33;border:1px solid var(--line);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;user-select:none}
    .tab.active{background:#12305f;border-color:rgba(91,140,255,.35)}
    .spacer{flex:1}
    .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:rgba(0,0,0,.15)}
    button{border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:var(--btn);color:white;font-weight:900}
    button.secondary{background:var(--btn2)}
    button.danger{background:#b00020}
    button:disabled{opacity:.5;cursor:not-allowed}
    .wrap{padding:12px}
    .layout{display:grid;grid-template-columns:1fr 380px;gap:12px;align-items:start}
    .panel{background:var(--panel);color:#061228;border-radius:14px;overflow:hidden;border:1px solid rgba(0,0,0,.12)}
    .panel .head{background:rgba(255,255,255,.45);padding:10px 12px;font-weight:900;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{background:rgba(255,255,255,.55);border:1px solid rgba(0,0,0,.10);padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .table-wrap{overflow:auto;border-top:1px solid rgba(0,0,0,.12);background:white;max-height:70vh}
    table{width:100%;border-collapse:collapse;font-size:12.5px;min-width:1200px}
    th,td{border-bottom:1px solid rgba(0,0,0,.12);padding:8px 8px;text-align:left;white-space:nowrap}
    th{position:sticky;top:0;background:#e9f5ff;z-index:1;font-weight:900}
    .side{display:flex;flex-direction:column;gap:12px}
    .card{background:var(--panel2);color:#061228;border-radius:14px;border:1px solid rgba(0,0,0,.12);padding:12px}
    label{display:block;font-size:12px;font-weight:900;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.85);outline:none;font-size:16px}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:#1f2f55;opacity:.95}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.table-wrap{max-height:55vh}table{min-width:1300px}}
  </style>
</head>
<body>
<div class="topbar">
  <div class="brand">Raport Forjă (LIVE) • v16</div>
  <div class="tabs">
    <div class="tab active" data-tab="debitate">DEBITATE</div>
    <div class="tab" data-tab="intrari">INTRARI_OTEL</div>
    <div class="tab" data-tab="numeralkod">NUMERALKOD</div>
  </div>
  <div class="spacer"></div>
  <span id="cloudPill" class="pill">Cloud: standby</span>
  <span id="userPill" class="pill">neautentificat</span>
  <button id="btnLogout" class="secondary" disabled>Logout</button>
</div>

<div class="wrap">
  <div class="layout">
    <div class="panel">
      <div class="head">
        <div class="actions">
          <button id="btnAdd" disabled>➕ Adaugă</button>
          <span class="chip" id="kpiRows">0 rânduri</span>
          <span class="chip" id="kpiTotal">—</span>
          <span class="chip" id="kpiLive">LIVE: —</span>
        </div>
        <div style="margin-left:auto" class="actions">
          <button id="btnReload" class="secondary" disabled>Reîncarcă</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="hint">Neautentificat.</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="side">
      <div class="card">
        <div style="font-weight:900">Autentificare</div>
        <div class="hint" style="margin-top:6px">Viewer vede; Editor/Admin adaugă + importă. LIVE = apare instant pe alt laptop.</div>
        <label>Email</label><input id="email" type="email" placeholder="nume@firma.ro">
        <label>Parolă</label><input id="password" type="password" placeholder="••••••••">
        <div class="actions" style="margin-top:10px">
          <button id="btnLogin">Intră</button>
          <button id="btnSignup" class="secondary">Creează cont</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900">Filtre</div>
        <div class="row">
          <div><label>An</label><input id="fltYear" type="number" min="2020" step="1"></div>
          <div><label>Lună</label>
            <select id="fltMonth">
              <option value="">(toate)</option>
              <option value="1">Ianuarie</option><option value="2">Februarie</option><option value="3">Martie</option>
              <option value="4">Aprilie</option><option value="5">Mai</option><option value="6">Iunie</option>
              <option value="7">Iulie</option><option value="8">August</option><option value="9">Septembrie</option>
              <option value="10">Octombrie</option><option value="11">Noiembrie</option><option value="12">Decembrie</option>
            </select>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Filtrarea e în DB (rapid + live). Pentru NUMERALKOD filtrul nu se aplică.</div>
      </div>

      <div class="card" id="importCard">
        <div style="font-weight:900">Import din Excel (Copy-Paste)</div>
        <div class="hint" style="margin-top:6px">
          În Excel: selectezi rânduri → Ctrl+C. Aici: Ctrl+V. Format TSV (TAB).<br>
          <span class="mono" id="importHint"></span>
        </div>
        <label>Paste aici</label>
        <textarea id="impText" placeholder="Lipește aici rândurile din Excel..."></textarea>
        <div class="actions" style="margin-top:10px">
          <button id="btnImport" class="secondary" disabled>Import</button>
          <span class="chip" id="impProgress">—</span>
        </div>
      </div>

      <div class="card" id="formCard" style="display:none">
        <div style="font-weight:900" id="formTitle">Adaugă</div>
        <div id="formBody"></div>
        <div class="actions" style="margin-top:10px">
          <button id="btnSave" disabled>Salvează</button>
          <button id="btnCancel" class="secondary">Renunță</button>
          <button id="btnDelete" class="danger" style="display:none">Șterge</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });
window.__SUPA__=sb;

let user=null, role="viewer", liveConnected=false;
let tab="debitate", selectedId=null, rows=[];
let channel=null;

const cloudPill=document.getElementById("cloudPill");
const userPill=document.getElementById("userPill");
const btnLogout=document.getElementById("btnLogout");
const btnReload=document.getElementById("btnReload");
const btnAdd=document.getElementById("btnAdd");
const kpiRows=document.getElementById("kpiRows");
const kpiTotal=document.getElementById("kpiTotal");
const kpiLive=document.getElementById("kpiLive");
const emailEl=document.getElementById("email");
const passEl=document.getElementById("password");
const btnLogin=document.getElementById("btnLogin");
const btnSignup=document.getElementById("btnSignup");
const fltYear=document.getElementById("fltYear");
const fltMonth=document.getElementById("fltMonth");
const thead=document.getElementById("thead");
const tbody=document.getElementById("tbody");
const impText=document.getElementById("impText");
const btnImport=document.getElementById("btnImport");
const impProgress=document.getElementById("impProgress");
const importHint=document.getElementById("importHint");
const formCard=document.getElementById("formCard");
const formTitle=document.getElementById("formTitle");
const formBody=document.getElementById("formBody");
const btnSave=document.getElementById("btnSave");
const btnCancel=document.getElementById("btnCancel");
const btnDelete=document.getElementById("btnDelete");

function setCloud(txt){ cloudPill.textContent="Cloud: "+txt; }
function setUserPill(){ userPill.textContent = user ? (user.email+" • "+role) : "neautentificat"; }
function isEditor(){ return role==="editor"||role==="admin"; }
function monthNo(){ return fltMonth.value ? Number(fltMonth.value) : null; }

function parseTSV(text){
  const lines=text.split(/\r?\n/).map(l=>l.trimEnd()).filter(l=>l.trim().length);
  return lines.map(l=>l.split("\t").map(c=>c.trim()));
}
function num(x){ if(x==null) return null; const s=String(x).trim(); if(!s) return null; const v=Number(s.replace(",", ".")); return Number.isFinite(v)?v:null; }
function intv(x){ const v=num(x); return v==null?null:Math.trunc(v); }
function asISODate(x){
  if(!x) return null;
  const s=String(x).trim();
  if(/\d{2}\.\d{2}\.\d{4}/.test(s)){ const [dd,mm,yyyy]=s.split("."); return `${yyyy}-${mm}-${dd}`; }
  if(/\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);
  return s;
}

async function fetchRole(){
  const {data,error}=await sb.from("profiles").select("role").eq("id",user.id).maybeSingle();
  if(error){ setCloud("role error"); return "viewer"; }
  return data?.role||"viewer";
}
function setEnabled(){
  const authed=!!user;
  btnLogout.disabled=!authed;
  btnReload.disabled=!authed;
  btnAdd.disabled=!(authed&&isEditor());
  btnSave.disabled=!(authed&&isEditor());
  btnImport.disabled=!(authed&&isEditor());
  btnDelete.style.display=(authed&&isEditor()&&selectedId)?"":"none";
}

function def(){
  if(tab==="debitate"){
    return {table:"debitate", orderCol:"data", sumCol:"total_kg",
      cols:[["an","An"],["luna_nr","Luna"],["data","Data"],["echipament","Echipament"],["reper","Reper"],["diametru","Diametru"],["calitate","Calitate"],["kg_buc","Kg/buc"],["lungime_mm","Lungime mm"],["cod_intern","Cod intern"],["cantitate_buc","Cantitate"],["schimb","Schimb"],["total_kg","Total kg"],["week_nr","week nr."],["operator","Operator"],["procent_norma","% normă"],["ore_lucrate","Ore"]],
      hint:"DEBITATE TSV: Data | Echipament | Reper | Diametru | Calitate | KgBuc | Lungime | CodIntern | Buc | Schimb | Operator"};
  }
  if(tab==="intrari"){
    return {table:"intrari_otel", orderCol:"data", sumCol:"cantitate_kg",
      cols:[["an","An"],["luna_nr","Luna"],["data","Data"],["diametru","Diametru"],["calitate","Calitate"],["cod_intern","Cod intern"],["sarja","Sarja"],["cantitate_kg","Kg"],["pretest","Pretest"],["furnizor","Furnizor"]],
      hint:"INTRARI TSV: Data | Diametru | Calitate | CodIntern | Sarja | Kg | Pretest | Furnizor"};
  }
  return {table:"numeralkod", orderCol:"cod", sumCol:null,
    cols:[["cod","Cod"],["descriere","Descriere"],["tip","Tip"]],
    hint:"NUMERALKOD TSV: Cod | Descriere | Tip"};
}

function render(){
  const d=def();
  importHint.textContent=d.hint;
  thead.innerHTML="<tr>"+d.cols.map(c=>`<th>${c[1]}</th>`).join("")+"</tr>";
  if(!user){ tbody.innerHTML='<tr><td class="hint">Neautentificat.</td></tr>'; return; }
  if(!rows.length){ tbody.innerHTML='<tr><td class="hint">Nu există rânduri.</td></tr>'; kpiRows.textContent="0 rânduri"; kpiTotal.textContent="—"; return; }
  tbody.innerHTML=rows.map(r=>`<tr data-id="${r.id}">`+d.cols.map(c=>`<td>${r[c[0]]??""}</td>`).join("")+`</tr>`).join("");
  kpiRows.textContent=rows.length+" rânduri";
  if(d.sumCol){
    const s=rows.reduce((a,x)=>a+(Number(x[d.sumCol])||0),0);
    kpiTotal.textContent=s.toLocaleString("ro-RO",{maximumFractionDigits:3})+" kg";
  } else kpiTotal.textContent="—";
  kpiLive.textContent="LIVE: "+(liveConnected?"conectat":"—");
}

async function loadRows(){
  if(!user) return;
  const d=def();
  let q=sb.from(d.table).select("*").order(d.orderCol,{ascending:false}).limit(10000);
  const y=Number(fltYear.value)||null;
  const m=monthNo();
  if(d.table!=="numeralkod"){
    if(y) q=q.eq("an",y);
    if(m) q=q.eq("luna_nr",m);
  }
  const {data,error}=await q;
  if(error){ setCloud("load error"); return; }
  rows=data||[];
  render();
  setCloud(liveConnected?"ON (LIVE)":"ON");
}

function openForm(edit=false){
  formCard.style.display="";
  formTitle.textContent=edit?"Editează":"Adaugă";
  const d=def();
  const row=edit?(rows.find(x=>String(x.id)===String(selectedId))||{}):{};
  const exclude=new Set(["id","created_at","created_by"]);
  const fields=d.cols.map(c=>({k:c[0],lab:c[1]})).filter(f=>!exclude.has(f.k));
  formBody.innerHTML=fields.map(f=>{
    const v=row[f.k]??"";
    const type=f.k==="data"?"date":"text";
    return `<label>${f.lab}</label><input data-f="${f.k}" type="${type}" value="${String(v).replaceAll('"',"&quot;")}">`;
  }).join("");
  btnDelete.style.display=(edit&&isEditor())?"":"none";
  setEnabled();
}
function closeForm(){ formCard.style.display="none"; formBody.innerHTML=""; selectedId=null; btnDelete.style.display="none"; setEnabled(); }

function getPayload(){
  const p={};
  for(const el of formBody.querySelectorAll("input[data-f]")){
    const k=el.dataset.f;
    let v=el.value;
    if(["an","luna_nr","lungime_mm","cantitate_buc","schimb","week_nr"].includes(k)) v=v?intv(v):null;
    if(["kg_buc","total_kg","cantitate_kg","procent_norma","ore_lucrate"].includes(k)) v=v?num(v):null;
    p[k]=v;
  }
  if(p.data){ const iso=asISODate(p.data); p.data=iso; if(!p.an) p.an=intv(iso.slice(0,4)); if(!p.luna_nr) p.luna_nr=intv(iso.slice(5,7)); }
  if(tab==="debitate"){ const kg=Number(p.kg_buc||0), buc=Number(p.cantitate_buc||0); p.total_kg=Number((kg*buc).toFixed(3)); }
  if(p.cod_intern) p.cod_intern=String(p.cod_intern).toUpperCase();
  if(p.reper) p.reper=String(p.reper).toUpperCase();
  if(p.cod) p.cod=String(p.cod).toUpperCase();
  return p;
}

async function insertRow(){
  const d=def();
  const payload=getPayload();
  setCloud("salvez…");
  const {data,error}=await sb.from(d.table).insert(payload).select("*").single();
  if(error){ setCloud("insert error"); return; }
  if(!rows.some(x=>String(x.id)===String(data.id))) rows.unshift(data);
  render(); closeForm(); setCloud("ON (LIVE)");
}
async function updateRow(){
  const d=def();
  const payload=getPayload();
  setCloud("actualizez…");
  const {data,error}=await sb.from(d.table).update(payload).eq("id",selectedId).select("*").single();
  if(error){ setCloud("update error"); return; }
  const idx=rows.findIndex(x=>String(x.id)===String(selectedId));
  if(idx>=0) rows[idx]=data;
  render(); closeForm(); setCloud("ON (LIVE)");
}
async function deleteRow(){
  const d=def();
  if(!confirm("Ștergi rândul selectat?")) return;
  setCloud("șterg…");
  const {error}=await sb.from(d.table).delete().eq("id",selectedId);
  if(error){ setCloud("delete error"); return; }
  rows=rows.filter(x=>String(x.id)!==String(selectedId));
  render(); closeForm(); setCloud("ON (LIVE)");
}

tbody.addEventListener("click",(ev)=>{
  const tr=ev.target.closest("tr[data-id]");
  if(!tr) return;
  selectedId=tr.dataset.id;
  if(isEditor()) openForm(true);
});
btnAdd.addEventListener("click",()=>openForm(false));
btnCancel.addEventListener("click",closeForm);
btnSave.addEventListener("click",async()=>{ if(!isEditor()) return; if(selectedId) await updateRow(); else await insertRow(); });
btnDelete.addEventListener("click",async()=>{ if(isEditor()&&selectedId) await deleteRow(); });

btnReload.addEventListener("click",loadRows);
fltYear.addEventListener("change",loadRows);
fltMonth.addEventListener("change",loadRows);

async function importBatch(){
  if(!isEditor()) return;
  const d=def();
  const tsv=parseTSV(impText.value);
  if(!tsv.length) return alert("Nu ai lipit nimic.");
  setCloud("import…");
  impProgress.textContent="parse…";
  let payloads=[];
  if(tab==="debitate"){
    for(const c of tsv){
      const iso=asISODate(c[0]); if(!iso) continue;
      const an=intv(iso.slice(0,4)), luna_nr=intv(iso.slice(5,7));
      const kg_buc=num(c[5])||0; const buc=intv(c[8])||0;
      payloads.push({an,luna_nr,data:iso,echipament:c[1]||"",reper:(c[2]||"").toUpperCase(),diametru:c[3]||"",calitate:c[4]||"",kg_buc,lungime_mm:intv(c[6])||0,cod_intern:(c[7]||"").toUpperCase(),cantitate_buc:buc,schimb:intv(c[9])||1,operator:c[10]||"",total_kg:Number((kg_buc*buc).toFixed(3))});
    }
  } else if(tab==="intrari"){
    for(const c of tsv){
      const iso=asISODate(c[0]); if(!iso) continue;
      const an=intv(iso.slice(0,4)), luna_nr=intv(iso.slice(5,7));
      payloads.push({an,luna_nr,data:iso,diametru:c[1]||"",calitate:c[2]||"",cod_intern:(c[3]||"").toUpperCase(),sarja:c[4]||"",cantitate_kg:num(c[5])||0,pretest:c[6]||"Nu are pretest",furnizor:c[7]||""});
    }
  } else {
    for(const c of tsv){
      const cod=(c[0]||"").toUpperCase(); if(!cod) continue;
      payloads.push({cod,descriere:c[1]||"",tip:c[2]||""});
    }
  }
  if(!payloads.length){ impProgress.textContent="0"; setCloud("import: 0"); return; }
  const CHUNK = tab==="debitate" ? 250 : 500;
  let done=0;
  for(let i=0;i<payloads.length;i+=CHUNK){
    const part=payloads.slice(i,i+CHUNK);
    impProgress.textContent=`${done}/${payloads.length}`;
    const {error}=await sb.from(d.table).insert(part);
    if(error){ setCloud("import error"); impProgress.textContent="eroare"; return; }
    done+=part.length;
  }
  impProgress.textContent=`${payloads.length}/${payloads.length} OK`;
  impText.value="";
  await loadRows();
  setCloud("ON (LIVE)");
}
btnImport.addEventListener("click",importBatch);

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.toggle("active",x===t));
    tab=t.dataset.tab; rows=[]; selectedId=null; closeForm(); render(); subscribeRealtime(); loadRows();
  });
});

function subscribeRealtime(){
  if(!user) return;
  if(channel){ sb.removeChannel(channel); channel=null; }
  const d=def();
  liveConnected=false;
  channel=sb.channel("rf-live-v16-"+d.table)
    .on("postgres_changes",{event:"*",schema:"public",table:d.table}, (p)=>{
      liveConnected=true;
      if(p.eventType==="INSERT"){ if(!rows.some(x=>String(x.id)===String(p.new.id))) rows.unshift(p.new); }
      else if(p.eventType==="UPDATE"){ const idx=rows.findIndex(x=>String(x.id)===String(p.new.id)); if(idx>=0) rows[idx]=p.new; }
      else if(p.eventType==="DELETE"){ const id=p.old?.id; rows=rows.filter(x=>String(x.id)!==String(id)); }
      render(); setCloud("ON (LIVE)");
    })
    .subscribe((s)=>{ liveConnected = (s==="SUBSCRIBED"); render(); setCloud(liveConnected?"ON (LIVE)":"ON"); });
}

// AUTH
btnSignup.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  const {error}=await sb.auth.signUp({email:e,password:p});
  if(error) return alert("Signup: "+error.message);
  alert("Cont creat.");
});
btnLogin.addEventListener("click", async ()=>{
  const e=emailEl.value.trim(), p=passEl.value;
  if(!e||!p) return alert("Completează email + parolă.");
  setCloud("autentific…");
  const {data,error}=await sb.auth.signInWithPassword({email:e,password:p});
  if(error){ setCloud("login error"); return; }
  user=data.user; role=await fetchRole();
  setUserPill(); setEnabled();
  render();
  await loadRows();
  subscribeRealtime();
});
btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  user=null; role="viewer"; rows=[]; selectedId=null;
  if(channel){ sb.removeChannel(channel); channel=null; }
  liveConnected=false;
  setUserPill(); setEnabled(); render(); setCloud("standby");
});

(function init(){
  fltYear.value=String(new Date().getFullYear());
  setUserPill(); setEnabled(); render();
  sb.auth.getSession().then(async ({data})=>{
    if(data?.session?.user){
      user=data.session.user; role=await fetchRole();
      setUserPill(); setEnabled();
      await loadRows();
      subscribeRealtime();
      setCloud("ON (LIVE)");
    }
  });
})();
</script>
</body>
</html>
