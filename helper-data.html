<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HELPER (Date) • Raport Forjă</title>
  <style>
    :root{
      --bg:#0b1020;
      --border:rgba(165,184,210,.18);
      --text:#eaf0ff;
      --muted:#a7b6d6;
      --glow1: rgba(99, 179, 237, .18);
      --glow2: rgba(129, 230, 217, .12);
      --glow3: rgba(190, 227, 248, .08);
      --shadow: 0 18px 45px rgba(0,0,0,.32);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 15% -10%, var(--glow1), transparent 60%),
        radial-gradient(1000px 600px at 105% 0%, var(--glow2), transparent 55%),
        radial-gradient(900px 500px at 50% 120%, var(--glow3), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
    }
    .shell{max-width:1200px;margin:0 auto;padding:20px 14px 24px;}
    .header{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(20,28,52,.70), rgba(13,19,38,.70));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: 20px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title{font-size:18px;font-weight:1000;letter-spacing:.2px;padding:6px 10px;}
    .spacer{flex:1}
    .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color:#bbf7d0;}
    .pill.warn{border-color: rgba(245,158,11,.35); color:#fde68a;}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#fecaca;}

    .btnTop{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      color:var(--text);
      font-weight:900;
      padding:8px 12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btnTop.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(20,28,52,.55), rgba(13,19,38,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardTitle{font-weight:1000}
    .cardBody{padding:12px 14px}

    label{display:block;color:var(--muted);font-weight:900;font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(165,184,210,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .note{color:var(--muted);font-size:12px;line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    table{width:100%;border-collapse:collapse;font-size:12.5px;}
    th,td{padding:9px 8px;border-bottom:1px solid rgba(165,184,210,.14);text-align:left;white-space:nowrap;}
    th{color:var(--muted);font-weight:1000;}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.22);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:11px;color:var(--muted);background:rgba(2,6,23,.35)}
    .badge.admin{color:#bbf7d0;border-color: rgba(34,197,94,.35)}
    .badge.editor{color:#dbeafe;border-color: rgba(99,179,237,.35)}
    .badge.viewer{color:#fde68a;border-color: rgba(245,158,11,.35)}
    .badge.disabled{color:#fecaca;border-color: rgba(239,68,68,.35)}

    .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .searchbar input{flex:1;min-width:240px}

    /* Login modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .backdrop.open{display:flex}
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(20,28,52,.88), rgba(13,19,38,.88));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:1000}
    .modalBody{padding:14px}
    .btnModal{
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btnModal.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
  </style>
  <style>
    .grid2{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 980px){ .grid2{grid-template-columns:1fr} }
    textarea{width:100%;min-height:110px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{text-align:left;color:var(--muted);font-size:12px;padding:0 10px}
    td{padding:0 10px}
    .cell input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);}
    .mini{font-size:12px;color:var(--muted)}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap}
    .danger{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.35)}
    .okpill{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="row">
      <a class="btn" href="index.html">← Dashboard</a>
      <span class="note">HELPER (Date) • Admin-only • alimentează autocomplete/autofill în pagini (ex: DEBITATE)</span>
    </div>
    <div class="row">
      <span id="cloudPill" class="pill warn">Cloud: standby</span>
      <span id="mePill" class="pill">neautentificat</span>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Setări / sincronizare</div>
          <div class="note">Se salvează în <span class="mono">rf_documents</span> cu <span class="mono">doc_key = helpers</span> și se cache-uiește local în <span class="mono">RF_HELPERS_v1</span>.</div>
        </div>
      </div>
      <div class="cardBody">
        <div class="rowBtns">
          <button id="btnLoadCloud" class="btn">Reload Cloud</button>
          <button id="btnSaveCloud" class="btn primary">Save Cloud</button>
          <button id="btnLoadLocal" class="btn">Load Local</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <label class="btn" for="fileImport" style="cursor:pointer">Import JSON</label>
          <input id="fileImport" type="file" accept="application/json" style="display:none" />
          <button id="btnReset" class="btn danger">Reset (gol)</button>
        </div>
        <div id="msg" class="note" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Utilaje debitare</div>
          <div class="note">Un utilaj pe rând. (Autocomplete pentru câmpul <b>Echipament</b> în DEBITATE.)</div>
        </div>
      </div>
      <div class="cardBody">
        <textarea id="taUtilajeDebitare" placeholder="EVERSING&#10;1 SCPK 500&#10;2 SCPK 500"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Utilaje forjă</div>
          <div class="note">Un utilaj pe rând (pentru alte pagini – dacă le folosești).</div>
        </div>
      </div>
      <div class="cardBody">
        <textarea id="taUtilajeForja" placeholder="MP&#10;2,5 T&#10;3 T BR"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Repere debitare</div>
          <div class="note">Aceste rânduri controlează autofill-ul: Diametru, Calitate, Kg/buc, Lungime (mm) când alegi <b>Reper</b> în DEBITATE.</div>
        </div>
        <div class="row">
          <button id="btnAddReper" class="btn">+ Adaugă rând</button>
          <span class="mini">Tip: Diametru/Kg/Lungime acceptă numere; Reper/Calitate acceptă text.</span>
        </div>
      </div>
      <div class="cardBody">
        <table>
          <thead>
            <tr>
              <th style="width:22%">REPER_DEBITARE</th>
              <th style="width:12%">DIAMETRU_OTEL</th>
              <th style="width:26%">CALITATE_OTEL</th>
              <th style="width:14%">KG_BUC_DEBITAT</th>
              <th style="width:14%">LUNGIME_DEBITARE_MM</th>
              <th style="width:12%">Șterge</th>
            </tr>
          </thead>
          <tbody id="repBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});
window.__SUPA__ = sb;

const DOC_TABLE = "rf_documents";
const DOC_KEY = "helpers";
const HELPERS_LS_KEY = "RF_HELPERS_v1";

const cloudPill = document.getElementById("cloudPill");
const mePill = document.getElementById("mePill");
const msg = document.getElementById("msg");

const taUtilajeDebitare = document.getElementById("taUtilajeDebitare");
const taUtilajeForja = document.getElementById("taUtilajeForja");
const repBody = document.getElementById("repBody");

let ME = null;
let HELPERS = null;
let lastCloudTs = null;

function setCloud(text, cls){
  cloudPill.textContent = "Cloud: " + text;
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(cls || "warn");
}

function toast(t){ msg.textContent = t || ""; }

function defaultHelpers(){
  return {
    version: 2,
    updated_at: new Date().toISOString(),
    utilaje_debitare: [],
    utilaje_forja: [],
    repere_debitare: [],
    tacturi: [],
    repere_forjate: [],
    lista_repere_debitare: []
  };
}

function parseLines(txt){
  return (txt||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}

function numOrNull(v){
  if(v===null || v===undefined) return null;
  const s = (""+v).trim().replace(",", ".");
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function render(){
  const h = HELPERS || defaultHelpers();
  taUtilajeDebitare.value = (h.utilaje_debitare || []).join("\n");
  taUtilajeForja.value = (h.utilaje_forja || []).join("\n");

  repBody.innerHTML = "";
  (h.repere_debitare || []).forEach((r, idx)=>{
    const tr = document.createElement("tr");

    function cellInput(key, placeholder){
      const td = document.createElement("td");
      td.className = "cell";
      const inp = document.createElement("input");
      inp.value = (r[key] ?? "") === null ? "" : (r[key] ?? "");
      inp.placeholder = placeholder || "";
      inp.addEventListener("input", ()=>{
        r[key] = inp.value;
      });
      td.appendChild(inp);
      return td;
    }

    tr.appendChild(cellInput("REPER_DEBITARE","ex: 9K-6628/29"));
    tr.appendChild(cellInput("DIAMETRU_OTEL","ex: 53"));
    tr.appendChild(cellInput("CALITATE_OTEL","ex: 1E-1287/15B34"));
    tr.appendChild(cellInput("KG_BUC_DEBITAT","ex: 3.77"));
    tr.appendChild(cellInput("LUNGIME_DEBITARE_MM","ex: 212"));

    const tdDel = document.createElement("td");
    const b = document.createElement("button");
    b.className = "btn danger";
    b.textContent = "Șterge";
    b.addEventListener("click", ()=>{
      HELPERS.repere_debitare.splice(idx,1);
      render();
    });
    tdDel.appendChild(b);
    tr.appendChild(tdDel);

    repBody.appendChild(tr);
  });
}

function normalizeFromUI(){
  const h = HELPERS || defaultHelpers();
  h.utilaje_debitare = parseLines(taUtilajeDebitare.value);
  h.utilaje_forja = parseLines(taUtilajeForja.value);

  h.repere_debitare = (h.repere_debitare || []).map(x=>({
    REPER_DEBITARE: (x.REPER_DEBITARE ?? "").toString().trim(),
    DIAMETRU_OTEL: numOrNull(x.DIAMETRU_OTEL),
    CALITATE_OTEL: (x.CALITATE_OTEL ?? "").toString().trim(),
    KG_BUC_DEBITAT: numOrNull(x.KG_BUC_DEBITAT),
    LUNGIME_DEBITARE_MM: numOrNull(x.LUNGIME_DEBITARE_MM),
    OBSERVATII: x.OBSERVATII ?? null
  })).filter(r=>r.REPER_DEBITARE);

  h.lista_repere_debitare = Array.from(new Set(h.repere_debitare.map(r=>r.REPER_DEBITARE))).sort();
  h.updated_at = new Date().toISOString();
  HELPERS = h;
  return h;
}

function saveLocal(h){
  try{ localStorage.setItem(HELPERS_LS_KEY, JSON.stringify(h)); }catch(_e){}
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(HELPERS_LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_e){ return null; }
}

async function getMe(){
  const { data } = await sb.auth.getSession();
  const u = data?.session?.user || null;
  if(!u) return null;
  let role = "viewer";
  try{
    const r = await sb.from("profiles").select("role").eq("id", u.id).maybeSingle();
    role = r?.data?.role || "viewer";
  }catch(_e){}
  return { id: u.id, email: u.email, role };
}

async function pullCloud(){
  setCloud("încarc…", "warn");
  const { data, error } = await sb.from(DOC_TABLE).select("data,updated_at").eq("doc_key", DOC_KEY).maybeSingle();
  if(error) throw error;
  if(!data || !data.data){
    setCloud("gol", "warn");
    HELPERS = defaultHelpers();
    render();
    return;
  }
  const ts = data.updated_at || null;
  if(lastCloudTs && ts && new Date(ts) <= new Date(lastCloudTs)) {
    setCloud("OK", "ok");
    return;
  }
  lastCloudTs = ts || new Date().toISOString();
  HELPERS = data.data;
  saveLocal(HELPERS);
  render();
  setCloud("OK", "ok");
  toast("Încărcat din cloud.");
}

async function pushCloud(){
  if(!ME || ME.role !== "admin") {
    toast("Doar admin poate salva.");
    return;
  }
  const h = normalizeFromUI();
  setCloud("salvez…", "warn");
  const up = { doc_key: DOC_KEY, data: h, updated_at: h.updated_at };
  const { error } = await sb.from(DOC_TABLE).upsert(up, { onConflict:"doc_key" });
  if(error) throw error;
  lastCloudTs = up.updated_at;
  saveLocal(h);
  setCloud("salvat", "ok");
  toast("Salvat în cloud + local.");
  try{ window.postMessage({ type:"HELPERS_UPDATED" }, "*"); }catch(_e){}
}

function exportJson(){
  const h = normalizeFromUI();
  const blob = new Blob([JSON.stringify(h, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "helpers.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importJson(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result);
      HELPERS = obj;
      saveLocal(HELPERS);
      render();
      toast("Import OK. Apasă Save Cloud ca să salvezi.");
    }catch(e){ toast("Import eșuat: " + e.message); }
  };
  r.readAsText(file);
}

document.getElementById("btnAddReper").addEventListener("click", ()=>{
  HELPERS = HELPERS || defaultHelpers();
  HELPERS.repere_debitare = HELPERS.repere_debitare || [];
  HELPERS.repere_debitare.push({
    REPER_DEBITARE:"",
    DIAMETRU_OTEL:null,
    CALITATE_OTEL:"",
    KG_BUC_DEBITAT:null,
    LUNGIME_DEBITARE_MM:null,
    OBSERVATII:null
  });
  render();
});

document.getElementById("btnLoadCloud").addEventListener("click", async ()=>{
  try{ await pullCloud(); }catch(e){ console.error(e); toast("Eroare cloud: " + e.message); setCloud("eroare","bad"); }
});

document.getElementById("btnSaveCloud").addEventListener("click", async ()=>{
  try{ await pushCloud(); }catch(e){ console.error(e); toast("Eroare cloud: " + e.message); setCloud("eroare","bad"); }
});

document.getElementById("btnLoadLocal").addEventListener("click", ()=>{
  const l = loadLocal();
  HELPERS = l || defaultHelpers();
  render();
  toast(l ? "Încărcat din local." : "Nu există local, am folosit reset (gol).");
});

document.getElementById("btnExport").addEventListener("click", exportJson);
document.getElementById("fileImport").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) importJson(f);
  e.target.value = "";
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  const ok = confirm("Reset la gol? (nu salvează automat în cloud)");
  if(!ok) return;
  HELPERS = defaultHelpers();
  saveLocal(HELPERS);
  render();
  toast("Reset OK. Apasă Save Cloud ca să salvezi.");
});

(async function boot(){
  try{
    ME = await getMe();
    if(!ME){
      mePill.textContent = "neautentificat";
      setCloud("standby", "warn");
      toast("Te rog autentifică-te în Dashboard, apoi revino aici.");
      HELPERS = loadLocal() || defaultHelpers();
      render();
      return;
    }
    mePill.textContent = `${ME.email} • ${ME.role}`;
    if(ME.role !== "admin"){
      setCloud("read-only", "warn");
      toast("Doar admin poate vedea și edita această pagină.");
      document.querySelectorAll("button, textarea, input, select").forEach(el=>{
        if(el.id === "btnLoadCloud" || el.id === "btnLoadLocal" || el.id === "btnExport" || el.id === "fileImport") return;
        el.disabled = true;
      });
      HELPERS = loadLocal() || defaultHelpers();
      render();
      return;
    }
    HELPERS = loadLocal() || defaultHelpers();
    render();
    await pullCloud();
  }catch(e){
    console.error(e);
    toast("Eroare: " + (e?.message || e));
    setCloud("eroare", "bad");
  }
})();
</script>
</body>
</html>
