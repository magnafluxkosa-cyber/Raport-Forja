<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HELPER (Date) • Raport Forjă</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f1b33; --card2:#0c162b; --border:#24334d;
    --txt:#e7eefc; --muted:#a9b7d3; --accent:#3b82f6; --accent2:#2563eb;
    --bad:#ef4444; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 700px at 20% 10%, #13254a 0%, #0b1220 55%, #070b14 100%);color:var(--txt);}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);backdrop-filter: blur(8px);}
  .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.2px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);font-size:12px;color:var(--muted)}
  .pill.ok{border-color:rgba(34,197,94,.55);color:#c7f9d7}
  .pill.bad{border-color:rgba(239,68,68,.55);color:#ffd0d0}
  .btn{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--txt);padding:9px 12px;border-radius:12px;font-weight:700}
  .btn:hover{background:rgba(255,255,255,.10)}
  .btn.primary{background:linear-gradient(180deg, rgba(59,130,246,.85), rgba(37,99,235,.85));border-color:rgba(59,130,246,.55)}
  .btn.primary:hover{filter:brightness(1.05)}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px 30px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
  .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.10);border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.35);overflow:hidden}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px;letter-spacing:.2px}
  .card .body{padding:12px 14px}
  .hint{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
  textarea{width:100%;min-height:180px;resize:vertical;padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:var(--txt);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:13px;line-height:1.35;outline:none}
  textarea:focus{border-color:rgba(59,130,246,.65);box-shadow:0 0 0 3px rgba(59,130,246,.18)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row .spacer{flex:1}
  .gate{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
  .gate .box{width:min(520px, 100%);background:rgba(15,27,51,.95);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px 16px 14px}
  .gate h2{margin:0 0 6px 0}
  .gate p{margin:0 0 12px 0;color:var(--muted);font-size:13px;line-height:1.35}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  label{font-size:12px;color:var(--muted)}
  input{padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:var(--txt);outline:none}
  input:focus{border-color:rgba(59,130,246,.65);box-shadow:0 0 0 3px rgba(59,130,246,.18)}
  .err{color:#ffd0d0;font-size:12px;margin-top:8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="top">
    <div class="left">
      <div class="brand">HELPER (Date)</div>
      <span class="pill" id="pillRole">rol: ?</span>
      <span class="pill" id="pillCloud">cloud: ...</span>
      <span class="pill" id="pillSave">autosave: idle</span>
    </div>
    <div class="left">
      <button class="btn" onclick="location.href='index.html'">← Dashboard</button>
      <button class="btn" id="btnForcePull" title="Reîncarcă din cloud (admin) – dacă ai nevoie" style="display:none">Reîncarcă</button>
    </div>
  </div>

  <div class="wrap">
    <div class="row">
      <div class="pill" style="border-style:dashed">Vizibil doar pentru <b>admin</b>. Aici menții listele folosite ca datalist în DEBITATE / INTRARI / FORJATE.</div>
      <div class="spacer"></div>
      <button class="btn primary" id="btnSaveNow" style="display:none">Salvează în cloud</button>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <h3>Utilaje debitare (Echipament) — 1 pe linie</h3>
        <div class="body">
          <textarea id="taUtilaje" placeholder="ex:
1 SCPK 500
EVERSING
MP
..."></textarea>
          <div class="hint">Folosit în câmpul <b>Echipament</b> la DEBITATE.</div>
        </div>
      </div>

      <div class="card">
        <h3>Operatori debitare — 1 pe linie</h3>
        <div class="body">
          <textarea id="taOperatori" placeholder="ex:
Nagy Robert
Gal Liviu
..."></textarea>
          <div class="hint">Folosit în câmpul <b>Operator</b> la DEBITATE.</div>
        </div>
      </div>

      <div class="card">
        <h3>Repere debitare — 1 pe linie</h3>
        <div class="body">
          <textarea id="taRepere" placeholder="ex:
248-2307/08
106-1625/26
..."></textarea>
          <div class="hint">Folosit în câmpul <b>Reper</b> la DEBITATE.</div>
        </div>
      </div>

      <div class="card">
        <h3>Calități (Grade) — 1 pe linie</h3>
        <div class="body">
          <textarea id="taCalitati" placeholder="ex:
1E-1287/15B34
C35
30MnVS6
..."></textarea>
          <div class="hint">Folosit în câmpurile de <b>Calitate</b>.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="gate" id="gate">
    <div class="box">
      <h2>Autentificare</h2>
      <p>Intră cu cont Supabase. Doar <b>admin</b> poate vedea această pagină.</p>
      <div class="field">
        <label>Email</label>
        <input id="email" autocomplete="username" />
      </div>
      <div class="field">
        <label>Parolă</label>
        <input id="pass" type="password" autocomplete="current-password" />
      </div>
      <div class="row">
        <button class="btn primary" id="btnIn">Intră</button>
        <div class="spacer"></div>
        <button class="btn" onclick="location.href='index.html'">Înapoi</button>
      </div>
      <div class="err" id="err"></div>
    </div>
  </div>

<script>
/* ===== CONFIG (pune valorile tale) ===== */
const SUPABASE_URL = window.SUPABASE_URL || "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";

/* ===== KEYS ===== */
const HELPERS_LS_KEY = "RF_HELPERS_v1";
const DOC_KEY = "helpers";          // rf_documents.doc_key
const STAMP_KEY = "helpers_stamp";  // rf_documents.doc_key

/* ===== UI ===== */
const $ = (id)=>document.getElementById(id);
const pillRole = $("pillRole");
const pillCloud = $("pillCloud");
const pillSave = $("pillSave");
const gate = $("gate");
const err = $("err");
const btnIn = $("btnIn");
const btnSaveNow = $("btnSaveNow");
const btnForcePull = $("btnForcePull");
const taUtilaje = $("taUtilaje");
const taOperatori = $("taOperatori");
const taRepere = $("taRepere");
const taCalitati = $("taCalitati");

function setPill(el, txt, kind){
  el.textContent = txt;
  el.classList.remove("ok","bad");
  if(kind) el.classList.add(kind);
}

function linesToList(s){
  return (s||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
}
function listToLines(arr){
  return (Array.isArray(arr)?arr:[]).map(x=>String(x||"").trim()).filter(Boolean).join("\n");
}

function readLocal(){
  try{
    const raw = localStorage.getItem(HELPERS_LS_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj==="object") ? obj : {};
  }catch(_e){ return {}; }
}
function writeLocal(obj){
  try{ localStorage.setItem(HELPERS_LS_KEY, JSON.stringify(obj||{})); }catch(_e){}
  try{
    const bc = new BroadcastChannel("rf_sync");
    bc.postMessage({type:"HELPERS_UPDATED", at: Date.now()});
    bc.close();
  }catch(_e){}
}

/* ===== Supabase ===== */
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let session = null;
let role = "viewer";
let acl = null;

async function getRoleAndAcl(){
  const s = await supa.auth.getSession();
  session = s.data.session;
  if(!session) return { authed:false, role:"viewer" };

  // role din profiles (setat din HELPER admin-control)
  const qRole = await supa.from("profiles").select("role").eq("id", session.user.id).maybeSingle();
  if(qRole.error) throw qRole.error;
  role = (qRole.data?.role || "viewer");

  // ACL row (optional) - fallback safe
  let row = null;
  const qAcl = await supa.from("rf_acl").select("*").eq("page_key","helper_data").eq("role", role).maybeSingle();
  if(!qAcl.error) row = qAcl.data;
  acl = row || null;

  const canView = (acl ? !!acl.can_view : (role==="admin"));
  const canEdit = (acl ? !!acl.can_edit_data : (role==="admin"));
  const canSync = (acl ? !!acl.can_sync_cloud : (role==="admin"));

  return { authed:true, role, canView, canEdit, canSync };
}

/* ===== rf_documents helpers (content/data fallback) ===== */
async function docGet(key){
  let q = await supa.from("rf_documents").select("doc_key, content, updated_at").eq("doc_key", key).maybeSingle();
  if(!q.error) return q.data ? { payload:q.data.content, updated_at:q.data.updated_at } : null;

  q = await supa.from("rf_documents").select("doc_key, data, updated_at").eq("doc_key", key).maybeSingle();
  if(q.error) throw q.error;
  return q.data ? { payload:q.data.data, updated_at:q.data.updated_at } : null;
}
async function docUpsert(key, payload){
  const rowA = { doc_key:key, content: payload, updated_at: new Date().toISOString() };
  let q = await supa.from("rf_documents").upsert(rowA, { onConflict:"doc_key" });
  if(!q.error) return;

  const rowB = { doc_key:key, data: payload, updated_at: new Date().toISOString() };
  q = await supa.from("rf_documents").upsert(rowB, { onConflict:"doc_key" });
  if(q.error) throw q.error;
}

/* ===== State & Autosave ===== */
let canEdit=false, canSync=false;
let isUserEditing=false;
let lastStampTs = 0;
let pushTimer = null;

function fillUI(obj){
  taUtilaje.value   = listToLines(obj.utilaje_debitare || obj.utilaje || []);
  taOperatori.value = listToLines(obj.operatori_debitare || obj.operatori || []);
  taRepere.value    = listToLines(obj.repere_debitare || obj.repere || []);
  taCalitati.value  = listToLines(obj.lista_calitati || obj.calitati || []);
}

function collectUI(){
  const out = readLocal();
  out.utilaje_debitare = linesToList(taUtilaje.value);
  out.operatori_debitare = linesToList(taOperatori.value);
  out.repere_debitare = linesToList(taRepere.value);
  out.lista_calitati = linesToList(taCalitati.value);
  out.updated_at_local = new Date().toISOString();
  return out;
}

async function pushNow(){
  if(!canSync) return;
  const payload = collectUI();
  writeLocal(payload);
  setPill(pillSave,"autosave: saving…");
  try{
    await docUpsert(DOC_KEY, payload);
    await docUpsert(STAMP_KEY, { ts: Date.now() });
    setPill(pillSave,"autosave: saved","ok");
    setPill(pillCloud,"cloud: conectat","ok");
  }catch(e){
    console.error(e);
    setPill(pillSave,"autosave: error","bad");
    setPill(pillCloud,"cloud: eroare","bad");
  }
}

function schedulePush(){
  if(!canSync) return;
  if(pushTimer) clearTimeout(pushTimer);
  setPill(pillSave,"autosave: pending…");
  pushTimer = setTimeout(()=>pushNow(), 650);
}

function onFocusIn(){ isUserEditing=true; }
function onFocusOut(){ isUserEditing=false; }

[taUtilaje, taOperatori, taRepere, taCalitati].forEach(el=>{
  el.addEventListener("focus", onFocusIn);
  el.addEventListener("blur", onFocusOut);
  el.addEventListener("input", ()=>{ if(canEdit){ schedulePush(); } });
});

btnSaveNow.addEventListener("click", ()=>pushNow());
btnForcePull.addEventListener("click", ()=>pullNow(true));

async function pullNow(force){
  if(!session) return;
  if(isUserEditing && !force) return;
  try{
    const d = await docGet(DOC_KEY);
    if(!d || !d.payload) return;
    writeLocal(d.payload);
    fillUI(d.payload);
    setPill(pillCloud,"cloud: conectat","ok");
  }catch(e){
    console.error(e);
    setPill(pillCloud,"cloud: eroare","bad");
  }
}

async function pollStamp(){
  if(!session) return;
  try{
    const d = await docGet(STAMP_KEY);
    const ts = Number(d?.payload?.ts || 0);
    if(ts && ts !== lastStampTs){
      lastStampTs = ts;
      await pullNow(false);
    }
  }catch(e){
    // ignore noisy polling errors
  }
}

async function boot(){
  try{
    const info = await getRoleAndAcl();
    if(!info.authed){
      gate.style.display="flex";
      setPill(pillCloud,"cloud: neautentificat","bad");
      return;
    }
    role = info.role;
    setPill(pillRole, "rol: " + role);
    if(!info.canView){
      alert("Nu ai acces la HELPER (Date).");
      location.href="index.html";
      return;
    }
    canEdit = info.canEdit;
    canSync = info.canSync;

    // Load local first (instant)
    const local = readLocal();
    fillUI(local);

    // UI toggles
    btnSaveNow.style.display = (canEdit && canSync) ? "" : "none";
    btnForcePull.style.display = (role==="admin") ? "" : "none";

    // Pull cloud once at start (to avoid stale device)
    await pullNow(true);

    // Start polling stamp (lightweight)
    setInterval(pollStamp, 1500);

    setPill(pillCloud,"cloud: conectat","ok");
    setPill(pillSave,"autosave: idle");

  }catch(e){
    console.error(e);
    setPill(pillCloud,"cloud: eroare","bad");
    gate.style.display="flex";
    err.textContent = e?.message || String(e);
  }
}

btnIn.addEventListener("click", async ()=>{
  err.textContent="";
  try{
    const email = ($("email").value||"").trim();
    const password = $("pass").value || "";
    if(!email || !password){ err.textContent="Completează email + parola."; return; }
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if(error) throw error;
    gate.style.display="none";
    await boot();
  }catch(e){
    err.textContent = e?.message || String(e);
  }
});

boot();
</script>
</body>
</html>
