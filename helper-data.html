<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HELPER (Date) • Raport Forjă</title>
  <style>
    :root{
      --bg:#0b1020;
      --border:rgba(165,184,210,.18);
      --text:#eaf0ff;
      --muted:#a7b6d6;
      --glow1: rgba(99, 179, 237, .18);
      --glow2: rgba(129, 230, 217, .12);
      --glow3: rgba(190, 227, 248, .08);
      --shadow: 0 18px 45px rgba(0,0,0,.32);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 15% -10%, var(--glow1), transparent 60%),
        radial-gradient(1000px 600px at 105% 0%, var(--glow2), transparent 55%),
        radial-gradient(900px 500px at 50% 120%, var(--glow3), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
    }
    .shell{max-width:1200px;margin:0 auto;padding:20px 14px 24px;}
    .header{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(20,28,52,.70), rgba(13,19,38,.70));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: 20px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title{font-size:18px;font-weight:1000;letter-spacing:.2px;padding:6px 10px;}
    .spacer{flex:1}
    .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color:#bbf7d0;}
    .pill.warn{border-color: rgba(245,158,11,.35); color:#fde68a;}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#fecaca;}

    .btnTop{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      color:var(--text);
      font-weight:900;
      padding:8px 12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btnTop.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(20,28,52,.55), rgba(13,19,38,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardTitle{font-weight:1000}
    .cardBody{padding:12px 14px}

    label{display:block;color:var(--muted);font-weight:900;font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(165,184,210,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .note{color:var(--muted);font-size:12px;line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    table{width:100%;border-collapse:collapse;font-size:12.5px;}
    th,td{padding:9px 8px;border-bottom:1px solid rgba(165,184,210,.14);text-align:left;white-space:nowrap;}
    th{color:var(--muted);font-weight:1000;}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.22);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:11px;color:var(--muted);background:rgba(2,6,23,.35)}
    .badge.admin{color:#bbf7d0;border-color: rgba(34,197,94,.35)}
    .badge.editor{color:#dbeafe;border-color: rgba(99,179,237,.35)}
    .badge.viewer{color:#fde68a;border-color: rgba(245,158,11,.35)}
    .badge.disabled{color:#fecaca;border-color: rgba(239,68,68,.35)}

    .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .searchbar input{flex:1;min-width:240px}

    /* Login modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .backdrop.open{display:flex}
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(20,28,52,.88), rgba(13,19,38,.88));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:1000}
    .modalBody{padding:14px}
    .btnModal{
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btnModal.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
  </style>
  <style>
    .grid2{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 980px){ .grid2{grid-template-columns:1fr} }
    textarea{width:100%;min-height:110px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{text-align:left;color:var(--muted);font-size:12px;padding:0 10px}
    td{padding:0 10px}
    .cell input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);}
    .mini{font-size:12px;color:var(--muted)}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap}
    .danger{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.35)}
    .okpill{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="row">
      <a class="btn" href="index.html">← Dashboard</a>
      <span class="note">HELPER (Date) • Admin-only • alimentează autocomplete/autofill în pagini (ex: DEBITATE)</span>
    </div>
    <div class="row">
      <span id="cloudPill" class="pill warn">Cloud: standby</span>
      <span id="mePill" class="pill">neautentificat</span>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Setări / sincronizare</div>
          <div class="note">Se salvează în <span class="mono">rf_documents</span> cu <span class="mono">doc_key = helpers</span> și se cache-uiește local în <span class="mono">RF_HELPERS_v1</span>.</div>
        </div>
      </div>
      <div class="cardBody">
        <div class="rowBtns">
          <button id="btnLoadCloud" class="btn">Reload Cloud</button>
          <button id="btnSaveCloud" class="btn primary">Save Cloud</button>
          <button id="btnLoadLocal" class="btn">Load Local</button>
          <button id="btnExport" class="btn">Export JSON</button>
          <button id="btnExportXlsx" class="btn">Export Excel</button>
          <label class="btn" for="fileImportXlsx" style="cursor:pointer">Import Excel</label>
          <input id="fileImportXlsx" type="file" accept=".xlsx,.xls" style="display:none" />
          <label class="btn" for="fileImport" style="cursor:pointer">Import JSON</label>
          <input id="fileImport" type="file" accept="application/json" style="display:none" />
          <button id="btnReset" class="btn danger">Reset (gol)</button>
        </div>
        <div id="msg" class="note" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Utilaje debitare</div>
          <div class="note">Un utilaj pe rând. (Autocomplete pentru câmpul <b>Echipament</b> în DEBITATE.)</div>
        </div>
      </div>
      <div class="cardBody">
        <textarea id="taUtilajeDebitare" placeholder="EVERSING&#10;1 SCPK 500&#10;2 SCPK 500"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Utilaje forjă</div>
          <div class="note">Un utilaj pe rând (pentru alte pagini – dacă le folosești).</div>
        </div>
      </div>
      <div class="cardBody">
        <textarea id="taUtilajeForja" placeholder="MP&#10;2,5 T&#10;3 T BR"></textarea>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Repere debitare</div>
          <div class="note">Aceste rânduri controlează autofill-ul: Diametru, Calitate, Kg/buc, Lungime (mm) când alegi <b>Reper</b> în DEBITATE.</div>
        </div>
        <div class="row">
          <button id="btnAddReper" class="btn">+ Adaugă rând</button>
          <span class="mini">Tip: Diametru/Kg/Lungime acceptă numere; Reper/Calitate acceptă text.</span>
        </div>
      </div>
      <div class="cardBody">
        <table>
          <thead>
            <tr>
              <th style="width:20%">REPER_DEBITARE</th>
              <th style="width:10%">DIAMETRU_OTEL</th>
              <th style="width:24%">CALITATE_OTEL</th>
              <th style="width:12%">KG_BUC_DEBITAT</th>
              <th style="width:12%">LUNGIME_DEBITARE_MM</th>
              <th style="width:14%">OBSERVATII</th>
              <th style="width:8%">Șterge</th>
            </tr>
          </thead>
          <tbody id="repBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">META</div>
          <div class="note">Foaia <span class="mono">meta</span> (KEY/VALUE). Poți păstra aici setări, versiune și timestamp.</div>
        </div>
        <div class="row">
          <button id="btnAddMeta" class="btn">+ Adaugă rând</button>
          <span class="mini">Cheile uzuale: <span class="mono">version</span>, <span class="mono">updated_at</span>.</span>
        </div>
      </div>
      <div class="cardBody">
        <table>
          <thead>
            <tr>
              <th style="width:26%">KEY</th>
              <th style="width:64%">VALUE</th>
              <th style="width:10%">Șterge</th>
            </tr>
          </thead>
          <tbody id="metaBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Tacturi</div>
          <div class="note">Foaia <span class="mono">tacturi</span>. Cheia se calculează automat: <span class="mono">Reper|Utilaj</span>.</div>
        </div>
        <div class="row">
          <button id="btnAddTact" class="btn">+ Adaugă rând</button>
          <span class="mini">Tactul este în secunde.</span>
        </div>
      </div>
      <div class="cardBody">
        <table>
          <thead>
            <tr>
              <th style="width:26%">Reper</th>
              <th style="width:26%">Utilaj</th>
              <th style="width:14%">Tact (sec)</th>
              <th style="width:24%">Cheie</th>
              <th style="width:10%">Șterge</th>
            </tr>
          </thead>
          <tbody id="tactBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Repere forjate</div>
          <div class="note">Foaia <span class="mono">repere_forjate</span>. Folosită pentru <b>KG FORJ</b> și mapări în FORJATE.</div>
        </div>
        <div class="row">
          <button id="btnAddForjat" class="btn">+ Adaugă rând</button>
          <span class="mini">Kg/buc forjat acceptă număr.</span>
        </div>
      </div>
      <div class="cardBody">
        <table>
          <thead>
            <tr>
              <th style="width:18%">REPER_FORJAT</th>
              <th style="width:22%">REPER_DEBITARE_ORIGINE</th>
              <th style="width:12%">DIMENSIUNE_OTEL</th>
              <th style="width:26%">CALITATE_OTEL</th>
              <th style="width:12%">KG_BUC_FORJAT</th>
              <th style="width:10%">Șterge</th>
            </tr>
          </thead>
          <tbody id="forjBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk";
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});
window.__SUPA__ = sb;

const DOC_TABLE = "rf_documents";
const DOC_KEY = "helpers";
const HELPERS_LS_KEY = "RF_HELPERS_v1";

const cloudPill = document.getElementById("cloudPill");
const mePill = document.getElementById("mePill");
const msg = document.getElementById("msg");

const taUtilajeDebitare = document.getElementById("taUtilajeDebitare");
const taUtilajeForja = document.getElementById("taUtilajeForja");
const repBody = document.getElementById("repBody");
const metaBody = document.getElementById("metaBody");
const tactBody = document.getElementById("tactBody");
const forjBody = document.getElementById("forjBody");

let ME = null;
let HELPERS = null;
let lastCloudTs = null;

function setCloud(text, cls){
  cloudPill.textContent = "Cloud: " + text;
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(cls || "warn");
}

function toast(t){ msg.textContent = t || ""; }

function defaultHelpers(){
  const now = new Date().toISOString();
  return {
    version: 2,
    updated_at: now,

    // Excel sheets (exact)
    meta_rows: [
      { KEY: "version", VALUE: 2 },
      { KEY: "updated_at", VALUE: now }
    ],

    utilaje_debitare: [],
    utilaje_forja: [],
    repere_debitare: [],
    tacturi: [],
    repere_forjate: [],

    // convenience
    lista_repere_debitare: []
  };
}

function parseLines(txt){
  return (txt||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
}

function numOrNull(v){
  if(v===null || v===undefined) return null;
  const s = (""+v).trim().replace(",", ".");
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function render(){
  const h = HELPERS || defaultHelpers();

  // utilaje
  taUtilajeDebitare.value = (h.utilaje_debitare || []).join("\n");
  taUtilajeForja.value = (h.utilaje_forja || []).join("\n");

  // META
  if(metaBody){
    metaBody.innerHTML = "";
    (h.meta_rows || []).forEach((r, idx)=>{
      const tr = document.createElement("tr");

      function cellInput(key, placeholder, ro){
        const td = document.createElement("td");
        td.className = "cell";
        const inp = document.createElement("input");
        inp.value = (r[key] ?? "") === null ? "" : (r[key] ?? "");
        inp.placeholder = placeholder || "";
        if(ro) inp.disabled = true;
        inp.addEventListener("input", ()=>{ r[key] = inp.value; });
        td.appendChild(inp);
        return td;
      }

      tr.appendChild(cellInput("KEY","ex: version"));
      tr.appendChild(cellInput("VALUE","ex: 2"));

      const tdDel = document.createElement("td");
      const b = document.createElement("button");
      b.className = "btn danger";
      b.textContent = "Șterge";
      b.addEventListener("click", ()=>{
        h.meta_rows.splice(idx,1);
        render();
      });
      tdDel.appendChild(b);
      tr.appendChild(tdDel);

      metaBody.appendChild(tr);
    });
  }

  // REPERE DEBITARE
  repBody.innerHTML = "";
  (h.repere_debitare || []).forEach((r, idx)=>{
    const tr = document.createElement("tr");

    function cellInput(key, placeholder){
      const td = document.createElement("td");
      td.className = "cell";
      const inp = document.createElement("input");
      inp.value = (r[key] ?? "") === null ? "" : (r[key] ?? "");
      inp.placeholder = placeholder || "";
      inp.addEventListener("input", ()=>{ r[key] = inp.value; });
      td.appendChild(inp);
      return td;
    }

    tr.appendChild(cellInput("REPER_DEBITARE","ex: 9K-6628/29"));
    tr.appendChild(cellInput("DIAMETRU_OTEL","ex: 53"));
    tr.appendChild(cellInput("CALITATE_OTEL","ex: 1E-1287/15B34"));
    tr.appendChild(cellInput("KG_BUC_DEBITAT","ex: 3.77"));
    tr.appendChild(cellInput("LUNGIME_DEBITARE_MM","ex: 212"));
    tr.appendChild(cellInput("OBSERVATII","opțional"));

    const tdDel = document.createElement("td");
    const b = document.createElement("button");
    b.className = "btn danger";
    b.textContent = "Șterge";
    b.addEventListener("click", ()=>{
      h.repere_debitare.splice(idx,1);
      render();
    });
    tdDel.appendChild(b);
    tr.appendChild(tdDel);

    repBody.appendChild(tr);
  });

  // TACTURI
  if(tactBody){
    tactBody.innerHTML = "";
    (h.tacturi || []).forEach((r, idx)=>{
      const tr = document.createElement("tr");

      function cellInput(key, placeholder, ro){
        const td = document.createElement("td");
        td.className = "cell";
        const inp = document.createElement("input");
        inp.value = (r[key] ?? "") === null ? "" : (r[key] ?? "");
        inp.placeholder = placeholder || "";
        if(ro) inp.disabled = true;
        inp.addEventListener("input", ()=>{ r[key] = inp.value; });
        td.appendChild(inp);
        return td;
      }

      // internal keys: Reper, Utilaj, Tact_sec, Cheie
      tr.appendChild(cellInput("Reper","ex: 106-1625"));
      tr.appendChild(cellInput("Utilaj","ex: 3 T BR"));
      tr.appendChild(cellInput("Tact_sec","ex: 16"));
      const cheie = ((r.Reper||"").toString().trim() + "|" + (r.Utilaj||"").toString().trim()).replace(/^\|+|\|+$/g,"");
      r.Cheie = cheie;
      tr.appendChild(cellInput("Cheie","Reper|Utilaj", true));

      const tdDel = document.createElement("td");
      const b = document.createElement("button");
      b.className = "btn danger";
      b.textContent = "Șterge";
      b.addEventListener("click", ()=>{
        h.tacturi.splice(idx,1);
        render();
      });
      tdDel.appendChild(b);
      tr.appendChild(tdDel);

      tactBody.appendChild(tr);
    });
  }

  // REPERE FORJATE
  if(forjBody){
    forjBody.innerHTML = "";
    (h.repere_forjate || []).forEach((r, idx)=>{
      const tr = document.createElement("tr");

      function cellInput(key, placeholder){
        const td = document.createElement("td");
        td.className = "cell";
        const inp = document.createElement("input");
        inp.value = (r[key] ?? "") === null ? "" : (r[key] ?? "");
        inp.placeholder = placeholder || "";
        inp.addEventListener("input", ()=>{ r[key] = inp.value; });
        td.appendChild(inp);
        return td;
      }

      tr.appendChild(cellInput("REPER_FORJAT","ex: 229-6909"));
      tr.appendChild(cellInput("REPER_DEBITARE_ORIGINE","ex: 229-6909/10"));
      tr.appendChild(cellInput("DIMENSIUNE_OTEL","ex: 63"));
      tr.appendChild(cellInput("CALITATE_OTEL","ex: 1E-1287/15B34"));
      tr.appendChild(cellInput("KG_BUC_FORJAT","ex: 6.145"));

      const tdDel = document.createElement("td");
      const b = document.createElement("button");
      b.className = "btn danger";
      b.textContent = "Șterge";
      b.addEventListener("click", ()=>{
        h.repere_forjate.splice(idx,1);
        render();
      });
      tdDel.appendChild(b);
      tr.appendChild(tdDel);

      forjBody.appendChild(tr);
    });
  }
}

function normalizeFromUI(){
  const h = HELPERS || defaultHelpers();

  // utilaje
  h.utilaje_debitare = parseLines(taUtilajeDebitare.value);
  h.utilaje_forja = parseLines(taUtilajeForja.value);

  // META
  h.meta_rows = (h.meta_rows || []).map(x=>({
    KEY: (x.KEY ?? "").toString().trim(),
    VALUE: (x.VALUE ?? "").toString()
  })).filter(r=>r.KEY);

  // version from meta (if present)
  const vRow = h.meta_rows.find(r=>_normKey(r.KEY) === "VERSION");
  if(vRow){
    const vn = Number((vRow.VALUE ?? "").toString().replace(",", "."));
    if(!Number.isNaN(vn)) h.version = vn;
  }

  // update updated_at everywhere (hard source of truth)
  const now = new Date().toISOString();
  h.updated_at = now;
  let uRow = h.meta_rows.find(r=>_normKey(r.KEY) === "UPDATED_AT");
  if(uRow) uRow.VALUE = now;
  else h.meta_rows.push({ KEY:"updated_at", VALUE: now });

  // ensure version row exists
  if(!h.meta_rows.find(r=>_normKey(r.KEY) === "VERSION")){
    h.meta_rows.unshift({ KEY:"version", VALUE: h.version ?? 2 });
  } else {
    // keep it synced
    const vr = h.meta_rows.find(r=>_normKey(r.KEY) === "VERSION");
    vr.VALUE = (h.version ?? 2).toString();
  }

  // REPERE DEBITARE
  h.repere_debitare = (h.repere_debitare || []).map(x=>({
    REPER_DEBITARE: (x.REPER_DEBITARE ?? "").toString().trim(),
    DIAMETRU_OTEL: numOrNull(x.DIAMETRU_OTEL),
    CALITATE_OTEL: (x.CALITATE_OTEL ?? "").toString().trim(),
    KG_BUC_DEBITAT: numOrNull(x.KG_BUC_DEBITAT),
    LUNGIME_DEBITARE_MM: numOrNull(x.LUNGIME_DEBITARE_MM),
    OBSERVATII: (x.OBSERVATII ?? "").toString().trim() || null
  })).filter(r=>r.REPER_DEBITARE);

  // TACTURI (internal keys)
  h.tacturi = (h.tacturi || []).map(x=>{
    const reper = (x.Reper ?? x.REPER ?? "").toString().trim();
    const utilaj = (x.Utilaj ?? x.UTILAJ ?? "").toString().trim();
    const tact = numOrNull(x.Tact_sec ?? x["Tact (sec)"] ?? x.TACT_SEC ?? x.TACT ?? "");
    const cheie = (reper && utilaj) ? (reper + "|" + utilaj) : ((x.Cheie ?? x.CHEIE ?? "").toString().trim());
    return {
      Cheie: cheie,
      Reper: reper,
      Utilaj: utilaj,
      Tact_sec: tact
    };
  }).filter(r=>r.Reper && r.Utilaj);

  // REPERE FORJATE
  h.repere_forjate = (h.repere_forjate || []).map(x=>({
    REPER_FORJAT: (x.REPER_FORJAT ?? x.REPER ?? "").toString().trim(),
    REPER_DEBITARE_ORIGINE: (x.REPER_DEBITARE_ORIGINE ?? x.REPER_DEBITARE ?? "").toString().trim(),
    DIMENSIUNE_OTEL: numOrNull(x.DIMENSIUNE_OTEL ?? x.DIAMETRU_OTEL ?? x.DIAMETRU ?? ""),
    CALITATE_OTEL: (x.CALITATE_OTEL ?? "").toString().trim(),
    KG_BUC_FORJAT: numOrNull(x.KG_BUC_FORJAT ?? x.KG_BUC ?? "")
  })).filter(r=>r.REPER_FORJAT);

  // convenience
  h.lista_repere_debitare = Array.from(new Set(h.repere_debitare.map(r=>r.REPER_DEBITARE))).sort();

  HELPERS = h;
  return h;
}
function saveLocal(h){
  try{ localStorage.setItem(HELPERS_LS_KEY, JSON.stringify(h)); }catch(_e){}
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(HELPERS_LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_e){ return null; }
}

async function getMe(){
  const { data } = await sb.auth.getSession();
  const u = data?.session?.user || null;
  if(!u) return null;

  let role = "viewer";
  let profileOk = false;

  // 1) preferred: profiles.role
  try{
    const r = await sb.from("profiles").select("role").eq("id", u.id).maybeSingle();
    if(r && !r.error){
      role = r?.data?.role || "viewer";
      profileOk = true;
    }
  }catch(_e){}

  // 2) fallback: if profiles isn't readable OR returns viewer but user is actually admin,
  // try Edge Function 'admin-control/list-users'. Only admin can call it -> if OK, we're admin.
  if(role !== "admin"){
    try{
      const token = data?.session?.access_token;
      if(token){
        const url = `${SUPABASE_URL}/functions/v1/admin-control/list-users`;
        const res = await fetch(url, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + token,
            "apikey": SUPABASE_ANON_KEY
          },
          body: "{}"
        });
        if(res.ok) role = "admin";
      }
    }catch(_e){}
  }

  return { id: u.id, email: u.email, role, profileOk };
}


async function pullCloud(){
  setCloud("încarc…", "warn");
  const { data, error } = await sb.from(DOC_TABLE).select("data,updated_at").eq("doc_key", DOC_KEY).maybeSingle();
  if(error) throw error;
  if(!data || !data.data){
    setCloud("gol", "warn");
    HELPERS = defaultHelpers();
    render();
    return;
  }
  const ts = data.updated_at || null;
  if(lastCloudTs && ts && new Date(ts) <= new Date(lastCloudTs)) {
    setCloud("OK", "ok");
    return;
  }
  lastCloudTs = ts || new Date().toISOString();
  HELPERS = data.data;
  saveLocal(HELPERS);
  render();
  setCloud("OK", "ok");
  toast("Încărcat din cloud.");
}

async function pushCloud(){
  if(!ME || ME.role !== "admin") {
    toast("Doar admin poate salva.");
    return;
  }
  const h = normalizeFromUI();
  setCloud("salvez…", "warn");
  const up = { doc_key: DOC_KEY, data: h, updated_at: h.updated_at };
  const { error } = await sb.from(DOC_TABLE).upsert(up, { onConflict:"doc_key" });
  if(error) throw error;
  lastCloudTs = up.updated_at;
  saveLocal(h);
  setCloud("salvat", "ok");
  toast("Salvat în cloud + local.");
  try{ window.postMessage({ type:"HELPERS_UPDATED" }, "*"); }catch(_e){}
}

function exportJson(){
  const h = normalizeFromUI();
  const blob = new Blob([JSON.stringify(h, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "helpers.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


function exportXlsx(){
  try{
    if(!window.XLSX){
      alert("Librăria Excel (XLSX) nu s-a încărcat. Verifică conexiunea la internet / CDN.");
      return;
    }
    const h = normalizeFromUI();
    const wb = XLSX.utils.book_new();

    // meta (KEY/VALUE)
    const metaRows = (h.meta_rows && h.meta_rows.length) ? h.meta_rows : [
      { KEY: "version", VALUE: h.version ?? "" },
      { KEY: "updated_at", VALUE: h.updated_at ?? "" }
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(metaRows.length ? metaRows : [{KEY:"",VALUE:""}]), "meta");

    function addListSheet(name, arr, col){
      const rows = (arr||[]).map(v=>({ [col]: v }));
      const ws = XLSX.utils.json_to_sheet(rows.length ? rows : [{ [col]: "" }]);
      XLSX.utils.book_append_sheet(wb, ws, name);
    }

    addListSheet("utilaje_debitare", h.utilaje_debitare, "UTILAJ");
    addListSheet("utilaje_forja", h.utilaje_forja, "UTILAJ");

    // repere_debitare (fixed columns)
    const repRows = (h.repere_debitare||[]).map(r=>({
      REPER_DEBITARE: r.REPER_DEBITARE ?? "",
      DIAMETRU_OTEL: r.DIAMETRU_OTEL ?? "",
      CALITATE_OTEL: r.CALITATE_OTEL ?? "",
      KG_BUC_DEBITAT: r.KG_BUC_DEBITAT ?? "",
      LUNGIME_DEBITARE_MM: r.LUNGIME_DEBITARE_MM ?? "",
      OBSERVATII: r.OBSERVATII ?? ""
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(repRows.length ? repRows : [{
      REPER_DEBITARE:"", DIAMETRU_OTEL:"", CALITATE_OTEL:"", KG_BUC_DEBITAT:"", LUNGIME_DEBITARE_MM:"", OBSERVATII:""
    }]), "repere_debitare");

    // tacturi (fixed columns + header 'Tact (sec)')
    const tactRows = (h.tacturi||[]).map(r=>({
      Cheie: r.Cheie ?? "",
      Reper: r.Reper ?? "",
      Utilaj: r.Utilaj ?? "",
      "Tact (sec)": r.Tact_sec ?? ""
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tactRows.length ? tactRows : [{
      Cheie:"", Reper:"", Utilaj:"", "Tact (sec)":""
    }]), "tacturi");

    // repere_forjate (fixed columns)
    const forjRows = (h.repere_forjate||[]).map(r=>({
      REPER_FORJAT: r.REPER_FORJAT ?? "",
      REPER_DEBITARE_ORIGINE: r.REPER_DEBITARE_ORIGINE ?? "",
      DIMENSIUNE_OTEL: r.DIMENSIUNE_OTEL ?? "",
      CALITATE_OTEL: r.CALITATE_OTEL ?? "",
      KG_BUC_FORJAT: r.KG_BUC_FORJAT ?? ""
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(forjRows.length ? forjRows : [{
      REPER_FORJAT:"", REPER_DEBITARE_ORIGINE:"", DIMENSIUNE_OTEL:"", CALITATE_OTEL:"", KG_BUC_FORJAT:""
    }]), "repere_forjate");

    const fn = "helper-data_" + new Date().toISOString().slice(0,10) + ".xlsx";
    XLSX.writeFile(wb, fn);
    toast("Export Excel OK.");
  }catch(e){
    console.error(e);
    toast("Eroare export Excel: " + (e?.message || e));
  }
}

function _normKey(k){
  return (k||"").toString().trim().toUpperCase()
    .replace(/Ă/g,"A").replace(/Â/g,"A").replace(/Î/g,"I").replace(/Ș/g,"S").replace(/Ţ/g,"T").replace(/Ț/g,"T")
    .replace(/[^A-Z0-9_]+/g,"_");
}

function importXlsx(file){
  if(!window.XLSX){
    alert("Librăria Excel (XLSX) nu s-a încărcat. Verifică conexiunea la internet / CDN.");
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = new Uint8Array(reader.result);
      const wb = XLSX.read(data, { type:"array" });

      const h = defaultHelpers();

      // META
      {
        const ws = wb.Sheets["meta"];
        if(ws){
          const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
          const out = [];
          rows.forEach(r=>{
            const k = (r.KEY ?? r.Key ?? r.key ?? "").toString().trim();
            const v = (r.VALUE ?? r.Value ?? r.value ?? "").toString();
            if(k) out.push({ KEY:k, VALUE:v });
          });
          if(out.length) h.meta_rows = out;
          const vRow = h.meta_rows.find(x=>_normKey(x.KEY)==="VERSION");
          if(vRow){
            const vn = Number((vRow.VALUE||"").toString().replace(",", "."));
            if(!Number.isNaN(vn)) h.version = vn;
          }
          const uRow = h.meta_rows.find(x=>_normKey(x.KEY)==="UPDATED_AT");
          if(uRow && uRow.VALUE) h.updated_at = uRow.VALUE.toString();
        }
      }

      function readListSheet(sheetName){
        const ws = wb.Sheets[sheetName];
        if(!ws) return [];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
        const out = [];
        for(let i=0;i<rows.length;i++){
          const row = rows[i] || [];
          if(i===0 && row[0] && _normKey(row[0]) === "UTILAJ") continue;
          const v = (row[0] ?? "").toString().trim();
          if(v) out.push(v);
        }
        return out;
      }

      h.utilaje_debitare = readListSheet("utilaje_debitare");
      h.utilaje_forja = readListSheet("utilaje_forja");

      // REPERE_DEBITARE
      {
        const ws = wb.Sheets["repere_debitare"];
        if(ws){
          const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
          const map = {
            "REPER_DEBITARE":"REPER_DEBITARE",
            "REPER":"REPER_DEBITARE",
            "REPER_DEB":"REPER_DEBITARE",

            "DIAMETRU_OTEL":"DIAMETRU_OTEL",
            "DIAMETRU":"DIAMETRU_OTEL",

            "CALITATE_OTEL":"CALITATE_OTEL",
            "CALITATE":"CALITATE_OTEL",

            "KG_BUC_DEBITAT":"KG_BUC_DEBITAT",
            "KG_BUC":"KG_BUC_DEBITAT",

            "LUNGIME_DEBITARE_MM":"LUNGIME_DEBITARE_MM",
            "LUNGIME_MM":"LUNGIME_DEBITARE_MM",
            "LUNGIME":"LUNGIME_DEBITARE_MM",

            "OBSERVATII":"OBSERVATII",
            "OBS":"OBSERVATII"
          };

          h.repere_debitare = rows.map(r=>{
            const obj = {};
            for(const k in r){
              const nk = _normKey(k);
              const dest = map[nk] || nk;
              obj[dest] = r[k];
            }
            return {
              REPER_DEBITARE: (obj.REPER_DEBITARE ?? "").toString().trim(),
              DIAMETRU_OTEL: numOrNull(obj.DIAMETRU_OTEL),
              CALITATE_OTEL: (obj.CALITATE_OTEL ?? "").toString().trim(),
              KG_BUC_DEBITAT: numOrNull(obj.KG_BUC_DEBITAT),
              LUNGIME_DEBITARE_MM: numOrNull(obj.LUNGIME_DEBITARE_MM),
              OBSERVATII: (obj.OBSERVATII ?? "").toString().trim() || null
            };
          }).filter(x=>x.REPER_DEBITARE);
        }
      }

      // TACTURI
      {
        const ws = wb.Sheets["tacturi"];
        if(ws){
          const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
          h.tacturi = rows.map(r=>{
            const cheie = (r.Cheie ?? r.CHEIE ?? "").toString().trim();
            const reper = (r.Reper ?? r.REPER ?? "").toString().trim();
            const utilaj = (r.Utilaj ?? r.UTILAJ ?? "").toString().trim();
            const tact = numOrNull(r["Tact (sec)"] ?? r.Tact_sec ?? r.TACT_SEC ?? r.Tact ?? "");
            const kk = (reper && utilaj) ? (reper + "|" + utilaj) : cheie;
            return { Cheie: kk, Reper: reper, Utilaj: utilaj, Tact_sec: tact };
          }).filter(x=>x.Reper && x.Utilaj);
        }
      }

      // REPERE_FORJATE
      {
        const ws = wb.Sheets["repere_forjate"];
        if(ws){
          const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
          h.repere_forjate = rows.map(r=>({
            REPER_FORJAT: (r.REPER_FORJAT ?? r.REPER ?? "").toString().trim(),
            REPER_DEBITARE_ORIGINE: (r.REPER_DEBITARE_ORIGINE ?? r.REPER_DEBITARE ?? "").toString().trim(),
            DIMENSIUNE_OTEL: numOrNull(r.DIMENSIUNE_OTEL ?? r.DIAMETRU_OTEL ?? r.DIAMETRU ?? ""),
            CALITATE_OTEL: (r.CALITATE_OTEL ?? "").toString().trim(),
            KG_BUC_FORJAT: numOrNull(r.KG_BUC_FORJAT ?? r.KG_BUC ?? "")
          })).filter(x=>x.REPER_FORJAT);
        }
      }

      // timestamps + convenience
      const now = new Date().toISOString();
      h.updated_at = now;
      // sync updated_at in meta_rows
      if(!h.meta_rows) h.meta_rows = [];
      let uRow = h.meta_rows.find(x=>_normKey(x.KEY)==="UPDATED_AT");
      if(uRow) uRow.VALUE = now;
      else h.meta_rows.push({ KEY:"updated_at", VALUE: now });
      // ensure version row
      let vRow = h.meta_rows.find(x=>_normKey(x.KEY)==="VERSION");
      if(vRow) vRow.VALUE = (h.version ?? 2).toString();
      else h.meta_rows.unshift({ KEY:"version", VALUE: (h.version ?? 2).toString() });

      h.lista_repere_debitare = Array.from(new Set((h.repere_debitare||[]).map(x=>x.REPER_DEBITARE))).sort();

      HELPERS = h;
      saveLocal(h);
      render();
      toast("Import Excel OK. Nu uita: Save Cloud (ca să fie live pe toate dispozitivele).");
    }catch(e){
      console.error(e);
      toast("Eroare import Excel: " + (e?.message || e));
    }
  };
  reader.readAsArrayBuffer(file);
}



function importJson(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result);
      HELPERS = obj;
      saveLocal(HELPERS);
      render();
      toast("Import OK. Apasă Save Cloud ca să salvezi.");
    }catch(e){ toast("Import eșuat: " + e.message); }
  };
  r.readAsText(file);
}

document.getElementById("btnAddReper").addEventListener("click", ()=>{
  HELPERS = HELPERS || defaultHelpers();
  HELPERS.repere_debitare = HELPERS.repere_debitare || [];
  HELPERS.repere_debitare.push({
    REPER_DEBITARE:"",
    DIAMETRU_OTEL:null,
    CALITATE_OTEL:"",
    KG_BUC_DEBITAT:null,
    LUNGIME_DEBITARE_MM:null,
    OBSERVATII:null
  });
  render();
});

document.getElementById("btnAddMeta")?.addEventListener("click", ()=>{
  HELPERS = HELPERS || defaultHelpers();
  HELPERS.meta_rows = HELPERS.meta_rows || [];
  HELPERS.meta_rows.push({ KEY:"", VALUE:"" });
  render();
});

document.getElementById("btnAddTact")?.addEventListener("click", ()=>{
  HELPERS = HELPERS || defaultHelpers();
  HELPERS.tacturi = HELPERS.tacturi || [];
  HELPERS.tacturi.push({ Cheie:"", Reper:"", Utilaj:"", Tact_sec:null });
  render();
});

document.getElementById("btnAddForjat")?.addEventListener("click", ()=>{
  HELPERS = HELPERS || defaultHelpers();
  HELPERS.repere_forjate = HELPERS.repere_forjate || [];
  HELPERS.repere_forjate.push({
    REPER_FORJAT:"",
    REPER_DEBITARE_ORIGINE:"",
    DIMENSIUNE_OTEL:null,
    CALITATE_OTEL:"",
    KG_BUC_FORJAT:null
  });
  render();
});

document.getElementById("btnLoadCloud").addEventListener("click", async ()=>{
  try{ await pullCloud(); }catch(e){ console.error(e); toast("Eroare cloud: " + e.message); setCloud("eroare","bad"); }
});

document.getElementById("btnSaveCloud").addEventListener("click", async ()=>{
  try{ await pushCloud(); }catch(e){ console.error(e); toast("Eroare cloud: " + e.message); setCloud("eroare","bad"); }
});

document.getElementById("btnLoadLocal").addEventListener("click", ()=>{
  const l = loadLocal();
  HELPERS = l || defaultHelpers();
  render();
  toast(l ? "Încărcat din local." : "Nu există local, am folosit reset (gol).");
});

document.getElementById("btnExport").addEventListener("click", exportJson);

document.getElementById("btnExportXlsx").addEventListener("click", exportXlsx);
document.getElementById("fileImportXlsx").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) importXlsx(f);
  e.target.value = "";
});
document.getElementById("fileImport").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) importJson(f);
  e.target.value = "";
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  const ok = confirm("Reset la gol? (nu salvează automat în cloud)");
  if(!ok) return;
  HELPERS = defaultHelpers();
  saveLocal(HELPERS);
  render();
  toast("Reset OK. Apasă Save Cloud ca să salvezi.");
});

(async function boot(){
  try{
    ME = await getMe();
    if(!ME){
      mePill.textContent = "neautentificat";
      setCloud("standby", "warn");
      toast("Te rog autentifică-te în Dashboard, apoi revino aici.");
      HELPERS = loadLocal() || defaultHelpers();
      render();
      return;
    }
    mePill.textContent = `${ME.email} • ${ME.role}`;
    if(ME.role !== "admin"){
      setCloud("read-only", "warn");
      toast("Doar admin poate vedea și edita această pagină.");
      document.querySelectorAll("button, textarea, input, select").forEach(el=>{
        if(el.id === "btnLoadCloud" || el.id === "btnLoadLocal" || el.id === "btnExport" || el.id === "fileImport") return;
        el.disabled = true;
      });
      HELPERS = loadLocal() || defaultHelpers();
      render();
      return;
    }
    HELPERS = loadLocal() || defaultHelpers();
    render();
    await pullCloud();
  }catch(e){
    console.error(e);
    toast("Eroare: " + (e?.message || e));
    setCloud("eroare", "bad");
  }
})();
</script>
</body>
</html>
