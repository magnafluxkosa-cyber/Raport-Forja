<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HELPER • Admin Control Panel</title>
  <meta name="theme-color" content="#0b1020"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b1020;
      --border:rgba(165,184,210,.18);
      --text:#eaf0ff;
      --muted:#a7b6d6;
      --glow1: rgba(99, 179, 237, .18);
      --glow2: rgba(129, 230, 217, .12);
      --glow3: rgba(190, 227, 248, .08);
      --shadow: 0 18px 45px rgba(0,0,0,.32);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 15% -10%, var(--glow1), transparent 60%),
        radial-gradient(1000px 600px at 105% 0%, var(--glow2), transparent 55%),
        radial-gradient(900px 500px at 50% 120%, var(--glow3), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #070a14 100%);
    }
    .shell{max-width:1200px;margin:0 auto;padding:20px 14px 24px;}
    .header{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(20,28,52,.70), rgba(13,19,38,.70));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: 20px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .title{font-size:18px;font-weight:1000;letter-spacing:.2px;padding:6px 10px;}
    .spacer{flex:1}
    .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(34,197,94,.35); color:#bbf7d0;}
    .pill.warn{border-color: rgba(245,158,11,.35); color:#fde68a;}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#fecaca;}

    .btnTop{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(10,14,30,.35);
      color:var(--text);
      font-weight:900;
      padding:8px 12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btnTop.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(20,28,52,.55), rgba(13,19,38,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardTitle{font-weight:1000}
    .cardBody{padding:12px 14px}

    label{display:block;color:var(--muted);font-weight:900;font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(165,184,210,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .note{color:var(--muted);font-size:12px;line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    table{width:100%;border-collapse:collapse;font-size:12.5px;}
    th,td{padding:9px 8px;border-bottom:1px solid rgba(165,184,210,.14);text-align:left;white-space:nowrap;}
    th{color:var(--muted);font-weight:1000;}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border-radius: 12px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      color:var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.22);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:11px;color:var(--muted);background:rgba(2,6,23,.35)}
    .badge.admin{color:#bbf7d0;border-color: rgba(34,197,94,.35)}
    .badge.editor{color:#dbeafe;border-color: rgba(99,179,237,.35)}
    .badge.viewer{color:#fde68a;border-color: rgba(245,158,11,.35)}
    .badge.disabled{color:#fecaca;border-color: rgba(239,68,68,.35)}

    .searchbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .searchbar input{flex:1;min-width:240px}

    /* Login modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:100;
    }
    .backdrop.open{display:flex}
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(20,28,52,.88), rgba(13,19,38,.88));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{font-weight:1000}
    .modalBody{padding:14px}
    .btnModal{
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(2,6,23,.35);
      color: var(--text);
      font-weight:900;
      padding:10px 12px;
      cursor:pointer;
    }
    .btnModal.primary{
      border-color: rgba(99,179,237,.35);
      background: linear-gradient(180deg, rgba(99,179,237,.22), rgba(99,179,237,.10));
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="header">
    <div class="title">HELPER • Admin Control Panel</div>
    <a class="btnTop" href="index.html">⬅ Dashboard</a>
    <div class="spacer"></div>
    <div class="pills">
      <span id="cloudPill" class="pill warn">Cloud: standby</span>
      <span id="userPill" class="pill">Utilizator: neautentificat</span>
      <button id="btnOpenLogin" class="btnTop primary">Login</button>
      <button id="btnLogout" class="btnTop" style="display:none">Ieșire</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Utilizatori</div>
          <div class="note">Doar admin. De aici setezi rol/parolă și activezi/dezactivezi acces.</div>
        </div>
        <div class="actions">
          <button id="btnRefresh" class="btn primary" disabled>Reîncarcă</button>
        </div>
      </div>
      <div class="cardBody">
        <div class="searchbar">
          <input id="q" placeholder="Caută email (ex: editor)..." disabled />
          <select id="filterRole" disabled>
            <option value="">toate rolurile</option>
            <option value="admin">admin</option>
            <option value="editor">editor</option>
            <option value="viewer">viewer</option>
          </select>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Rol</th>
                <th>Status</th>
                <th>Ultima actualizare</th>
                <th>Acțiuni</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td class="note" colspan="5">Neautentificat.</td></tr>
            </tbody>
          </table>
        </div>
        <div id="msg" class="note" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Acțiune rapidă</div>
          <div class="note">Selectează un user din listă (buton Selectează).</div>
        </div>
      </div>
      <div class="cardBody">
        <label>User ID (uuid)</label>
        <input id="uid" placeholder="se completează când alegi un user" disabled />

        <label>Email</label>
        <input id="email" placeholder="se completează când alegi un user" disabled />

        <label>Rol</label>
        <select id="role" disabled>
          <option value="viewer">viewer</option>
          <option value="editor">editor</option>
          <option value="admin">admin</option>
        </select>

        <label>Parolă nouă</label>
        <input id="newpass" type="password" placeholder="minim 12 caractere recomandat" disabled />

        <div class="row2" style="margin-top:12px">
          <button id="btnSetRole" class="btn primary" disabled>Setează rol</button>
          <button id="btnSetPass" class="btn primary" disabled>Setează parolă</button>
        </div>

        <div class="row2" style="margin-top:10px">
          <button id="btnDisable" class="btn danger" disabled>Dezactivează acces</button>
          <button id="btnEnable" class="btn" disabled>Reactivează acces</button>
        </div>
        <div class="row2" style="margin-top:10px">
          <button id="btnDeleteUser" class="btn danger" disabled>Șterge cont (permanent)</button>
        </div>


        <hr style="border:0;border-top:1px solid rgba(165,184,210,.14);margin:14px 0">

        <div class="note" style="font-weight:1000;margin-bottom:4px">Creează cont nou</div>
        <div class="note" style="margin-bottom:8px">
          Poți folosi email real (ex: <span class="mono">nume@gmail.com</span>) sau fictiv
          (ex: <span class="mono">rf-user-93k@raportforja.local</span>).
        </div>

        <label>Email nou</label>
        <input id="newEmail" placeholder="rf-user-93k@raportforja.local" disabled>

        <label>Parolă inițială</label>
        <input id="newUserPass" type="password" placeholder="min 12 caractere" disabled>

        <label>Rol</label>
        <select id="newUserRole" disabled>
          <option value="viewer">viewer</option>
          <option value="editor">editor</option>
          <option value="admin">admin</option>
        </select>

        <button id="btnCreateUser" class="btn primary" disabled style="margin-top:10px;width:100%">
          Creează utilizator
        </button>

        <div class="row2" style="margin-top:10px">
          <button id="btnGenFictiv" class="btn" disabled>Generează fictiv + parolă</button>
          <button id="btnCopyCreds" class="btn" disabled>Copiază credențiale</button>
        </div>
        <div class="note" style="margin-top:8px">
          Generează un email fictiv de forma <span class="mono">rf-XXXX@raportforja.local</span> și o parolă random puternică.
        </div>


        <div class="note" style="margin-top:12px">
          Edge Function: <span class="mono">admin-control</span> • routes:
          <span class="mono">list-users</span>,
          <span class="mono">create-user</span>,
          <span class="mono">set-role</span>,
          <span class="mono">set-password</span>,
          <span class="mono">set-disabled</span>,
          <span class="mono">delete-user</span>.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginBackdrop" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modalHead">
      <div class="modalTitle" id="loginTitle">Autentificare</div>
      <button id="btnCloseLogin" class="btnModal">✕</button>
    </div>
    <div class="modalBody">
      <div class="note">Login cu cont Supabase. Doar <b>admin</b> poate folosi acest panou.</div>

      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="forja.editor@gmail.com"/>

      <label>Parolă</label>
      <input id="loginPass" type="password" placeholder="••••••••"/>

      <div class="actions" style="margin-top:12px">
        <button id="btnDoLogin" class="btnModal primary">Intră</button>
      </div>

      <div id="loginMsg" class="note" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://rhjcnydkdhjzazygybcc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoamNueWRrZGhqemF6eWd5YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4ODEzMzYsImV4cCI6MjA4NzQ1NzMzNn0.ompOZWqnFGsnOQzPiAv2QBwuaNiKtnz5PciRwCWh0Hk"; // <-- Anon Key (Legacy)

const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* UI */
const cloudPill = document.getElementById("cloudPill");
const userPill = document.getElementById("userPill");
const btnOpenLogin = document.getElementById("btnOpenLogin");
const btnLogout = document.getElementById("btnLogout");

const btnRefresh = document.getElementById("btnRefresh");
const tbody = document.getElementById("tbody");
const msg = document.getElementById("msg");
const q = document.getElementById("q");
const filterRole = document.getElementById("filterRole");

const uidEl = document.getElementById("uid");
const emailEl = document.getElementById("email");
const roleEl = document.getElementById("role");
const newpassEl = document.getElementById("newpass");
const btnSetRole = document.getElementById("btnSetRole");
const btnSetPass = document.getElementById("btnSetPass");
const btnDisable = document.getElementById("btnDisable");
const btnEnable = document.getElementById("btnEnable");
const btnDeleteUser = document.getElementById("btnDeleteUser");

/* Create user */
const newEmailEl = document.getElementById("newEmail");
const newUserPassEl = document.getElementById("newUserPass");
const newUserRoleEl = document.getElementById("newUserRole");
const btnCreateUser = document.getElementById("btnCreateUser");
const btnGenFictiv = document.getElementById("btnGenFictiv");
const btnCopyCreds = document.getElementById("btnCopyCreds");

/* login modal */
const loginBackdrop = document.getElementById("loginBackdrop");
const btnCloseLogin = document.getElementById("btnCloseLogin");
const loginEmail = document.getElementById("loginEmail");
const loginPass = document.getElementById("loginPass");
const btnDoLogin = document.getElementById("btnDoLogin");
const loginMsg = document.getElementById("loginMsg");

let session = null;
let myRole = "viewer";
let usersCache = [];

function setCloud(text, kind="warn"){
  cloudPill.classList.remove("ok","warn","bad");
  cloudPill.classList.add(kind);
  cloudPill.textContent = "Cloud: " + text;
}
function setUser(text){
  userPill.textContent = "Utilizator: " + text;
}
function canUsePanel(){
  return !!session && myRole === "admin";
}

function openLogin(){
  loginBackdrop.classList.add("open");
  loginBackdrop.setAttribute("aria-hidden","false");
  loginMsg.textContent = "";
  setTimeout(()=>loginEmail.focus(), 50);
}
function closeLogin(){
  loginBackdrop.classList.remove("open");
  loginBackdrop.setAttribute("aria-hidden","true");
}

async function fetchMyRole(){
  if(!session?.user) return "viewer";
  const { data } = await sb.from("profiles").select("role").eq("id", session.user.id).maybeSingle();
  return data?.role || "viewer";
}

async function callAdminControl(path, body){
  const { data } = await sb.auth.getSession();
  const token = data?.session?.access_token;
  if(!token) throw new Error("Nu există sesiune. Re-login.");

  const url = `${SUPABASE_URL}/functions/v1/admin-control/${path}`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "Authorization": "Bearer " + token,
      "apikey": SUPABASE_ANON_KEY
    },
    body: JSON.stringify(body || {})
  });

  const txt = await res.text();
  let out = null;
  try { out = JSON.parse(txt); } catch { out = { raw: txt }; }
  if(!res.ok) throw new Error(out?.error || res.statusText);
  return out;
}

function badgeRole(r){
  const cls = r === "admin" ? "admin" : (r === "editor" ? "editor" : "viewer");
  return `<span class="badge ${cls}">${r}</span>`;
}
function badgeStatus(disabled){
  return disabled ? `<span class="badge disabled">dezactivat</span>` : `<span class="badge">activ</span>`;
}

function setEnabledUI(){
  const ok = canUsePanel();

  btnRefresh.disabled = !ok;
  btnSetRole.disabled = !ok;
  btnSetPass.disabled = !ok;
  btnDisable.disabled = !ok;
  btnEnable.disabled = !ok;
  btnDeleteUser.disabled = !ok;

  btnCreateUser.disabled = !ok;
  btnGenFictiv.disabled = !ok;
  btnCopyCreds.disabled = !ok;

  q.disabled = !ok;
  filterRole.disabled = !ok;

  uidEl.disabled = !ok;
  emailEl.disabled = !ok;
  roleEl.disabled = !ok;
  newpassEl.disabled = !ok;

  newEmailEl.disabled = !ok;
  newUserPassEl.disabled = !ok;
  newUserRoleEl.disabled = !ok;
}

function renderUsers(){
  const needle = (q.value||"").toLowerCase().trim();
  const rf = filterRole.value;

  const list = usersCache.filter(u=>{
    const okEmail = !needle || (u.email||"").toLowerCase().includes(needle);
    const okRole = !rf || (u.role === rf);
    return okEmail && okRole;
  });

  if(!canUsePanel()){
    tbody.innerHTML = `<tr><td class="note" colspan="5">Doar admin poate vedea această pagină.</td></tr>`;
    return;
  }

  if(!list.length){
    tbody.innerHTML = `<tr><td class="note" colspan="5">Nu există rezultate.</td></tr>`;
    return;
  }

  tbody.innerHTML = list.map(u=>{
    const last = u.updated_at ? new Date(u.updated_at).toLocaleString("ro-RO") : "";
    return `<tr>
      <td>${u.email || ""}</td>
      <td>${badgeRole(u.role || "viewer")}</td>
      <td>${badgeStatus(!!u.disabled)}</td>
      <td>${last}</td>
      <td class="actions">
        <button class="btn primary pick" data-uid="${u.id}">Selectează</button>
        <button class="btn danger del" data-uid="${u.id}" style="margin-left:8px">Șterge</button>
      </td>
    </tr>`;
  }).join("");
}

async function refreshUsers(){
  msg.textContent = "";
  setCloud("încarc utilizatori…", "warn");
  try{
    const data = await callAdminControl("list-users", {});
    usersCache = data.users || [];
    renderUsers();
    setCloud("conectat", "ok");
    msg.textContent = `Încărcați: ${usersCache.length} utilizatori.`;
  }catch(e){
    setCloud("eroare", "bad");
    msg.textContent = "Eroare: " + e.message;
  }
}

function pickUser(uid){
  const u = usersCache.find(x=>x.id===uid);
  if(!u) return;
  uidEl.value = u.id;
  emailEl.value = u.email || "";
  roleEl.value = u.role || "viewer";
  msg.textContent = `Selectat: ${u.email || u.id}`;
}

tbody.addEventListener("click", (e)=>{
  const pick = e.target.closest(".pick");
  if(pick){
    pickUser(pick.dataset.uid);
    return;
  }
  const del = e.target.closest(".del");
  if(del){
    if(!canUsePanel()) return;
    const uid = del.dataset.uid;
    if(!uid) return;
    const ok = confirm("Sigur ștergi permanent acest cont? Acțiune ireversibilă.");
    if(!ok) return;
    msg.textContent = "Șterg cont…";
    try{
      await callAdminControl("delete-user", { user_id: uid });
      msg.textContent = "Cont șters.";
      // dacă tocmai ai șters contul selectat
      if(uidEl.value.trim() === uid){
        uidEl.value=""; emailEl.value=""; roleEl.value="viewer"; newpassEl.value="";
              }
      await refreshUsers();
    }catch(e){
      // fallback: disable access (soft delete)
      try{
        await callAdminControl("set-disabled", { user_id: uid, disabled: true });
        msg.textContent = "Nu există delete-user. Am dezactivat accesul (fallback).";
        await refreshUsers();
      }catch(e2){
        msg.textContent = "Eroare: " + (e?.message || e);
      }
    }
  }
});

q.addEventListener("input", renderUsers);
filterRole.addEventListener("change", renderUsers);
btnRefresh.addEventListener("click", refreshUsers);

btnSetRole.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const uid = uidEl.value.trim();
  const r = roleEl.value;
  if(!uid) { msg.textContent = "Selectează un user."; return; }
  msg.textContent = "Setez rol…";
  try{
    await callAdminControl("set-role", { user_id: uid, role: r });
    msg.textContent = "Rol setat.";
    await refreshUsers();
  }catch(e){ msg.textContent = "Eroare: " + e.message; }
});

btnSetPass.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const uid = uidEl.value.trim();
  const pw = newpassEl.value;
  if(!uid) { msg.textContent = "Selectează un user."; return; }
  if(!pw || pw.length < 12) { msg.textContent = "Parola trebuie să aibă minim 12 caractere."; return; }
  msg.textContent = "Setez parolă…";
  try{
    await callAdminControl("set-password", { user_id: uid, password: pw });
    newpassEl.value = "";
    msg.textContent = "Parola a fost schimbată.";
  }catch(e){ msg.textContent = "Eroare: " + e.message; }
});

btnDisable.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const uid = uidEl.value.trim();
  if(!uid) { msg.textContent = "Selectează un user."; return; }
  if(!confirm("Dezactivezi accesul pentru acest user?")) return;
  msg.textContent = "Dezactivez…";
  try{
    await callAdminControl("set-disabled", { user_id: uid, disabled: true });
    msg.textContent = "User dezactivat.";
    await refreshUsers();
  }catch(e){ msg.textContent = "Eroare: " + e.message; }
});

btnEnable.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const uid = uidEl.value.trim();
  if(!uid) { msg.textContent = "Selectează un user."; return; }
  msg.textContent = "Reactivez…";
  try{
    await callAdminControl("set-disabled", { user_id: uid, disabled: false });
    msg.textContent = "User reactivat.";
    await refreshUsers();
  }catch(e){ msg.textContent = "Eroare: " + e.message; }
});

btnDeleteUser.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const uid = uidEl.value.trim();
  if(!uid) { msg.textContent = "Selectează un user."; return; }
  const ok = confirm("Sigur ștergi permanent acest cont? Acțiune ireversibilă.");
  if(!ok) return;
  msg.textContent = "Șterg cont…";
  try{
    await callAdminControl("delete-user", { user_id: uid });
    msg.textContent = "Cont șters.";
    uidEl.value=""; emailEl.value=""; roleEl.value="viewer"; newpassEl.value="";
        await refreshUsers();
  }catch(e){
    // fallback: disable
    try{
      await callAdminControl("set-disabled", { user_id: uid, disabled: true });
      msg.textContent = "Nu există delete-user. Am dezactivat accesul (fallback).";
      await refreshUsers();
    }catch(e2){
      msg.textContent = "Eroare: " + (e?.message || e);
    }
  }
});



btnCreateUser.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const email = (newEmailEl.value || "").trim();
  const password = newUserPassEl.value || "";
  const role = newUserRoleEl.value;

  if(!email){ msg.textContent = "Completează email nou."; return; }
  if(password.length < 12){ msg.textContent = "Parola trebuie să aibă minim 12 caractere."; return; }

  msg.textContent = "Creez user…";
  try{
    const res = await callAdminControl("create-user", { email, password, role });
    msg.textContent = `Creat: ${res.user.email} (${res.user.role}).`;
    newUserPassEl.value = "";
    await refreshUsers();
  }catch(e){
    msg.textContent = "Eroare: " + e.message;
  }
});


function randomId(n){
  const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789";
  let out = "";
  for(let i=0;i<n;i++) out += alphabet[Math.floor(Math.random()*alphabet.length)];
  return out;
}
function randomPassword(n){
  const upper = "ABCDEFGHJKLMNPQRSTUVWXYZ";
  const lower = "abcdefghijkmnopqrstuvwxyz";
  const nums  = "23456789";
  const sym   = "!@#$%*_+-=";
  const all = upper+lower+nums+sym;
  let out = "";
  // ensure at least one from each bucket
  out += upper[Math.floor(Math.random()*upper.length)];
  out += lower[Math.floor(Math.random()*lower.length)];
  out += nums[Math.floor(Math.random()*nums.length)];
  out += sym[Math.floor(Math.random()*sym.length)];
  for(let i=4;i<n;i++) out += all[Math.floor(Math.random()*all.length)];
  return out.split("").sort(()=>Math.random()-0.5).join("");
}

btnGenFictiv.addEventListener("click", ()=>{
  if(!canUsePanel()) return;
  const id = randomId(6);
  newEmailEl.value = `rf-${id}@raportforja.local`;
  newUserPassEl.value = randomPassword(18);
  newUserRoleEl.value = "viewer";
  msg.textContent = "Generate: completat email fictiv + parolă. Poți apăsa Creează utilizator.";
});

btnCopyCreds.addEventListener("click", async ()=>{
  if(!canUsePanel()) return;
  const email = (newEmailEl.value||"").trim();
  const pw = newUserPassEl.value || "";
  if(!email || !pw){
    msg.textContent = "Nu am ce copia. Generează sau completează Email nou + Parolă inițială.";
    return;
  }
  const text = `Email: ${email}\nParola: ${pw}\nRol: ${newUserRoleEl.value}`;
  try{
    await navigator.clipboard.writeText(text);
    msg.textContent = "Credențialele au fost copiate în clipboard.";
  }catch{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    msg.textContent = "Credențialele au fost copiate (fallback).";
  }
});


/* Auth */
function applyAuthUI(){
  if(session){
    btnOpenLogin.style.display = "none";
    btnLogout.style.display = "";
    setUser(session.user.email + " • " + myRole);
    setCloud("conectat", myRole==="admin" ? "ok" : "warn");
  } else {
    btnOpenLogin.style.display = "";
    btnLogout.style.display = "none";
    setUser("neautentificat");
    setCloud("standby", "warn");
  }

  setEnabledUI();

  if(canUsePanel()){
    refreshUsers();
  } else {
    tbody.innerHTML = `<tr><td class="note" colspan="5">Doar admin poate vedea această pagină.</td></tr>`;
  }
}

btnOpenLogin.addEventListener("click", openLogin);
btnCloseLogin.addEventListener("click", closeLogin);
loginBackdrop.addEventListener("click", (e)=>{ if(e.target === loginBackdrop) closeLogin(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && loginBackdrop.classList.contains("open")) closeLogin(); });

btnDoLogin.addEventListener("click", async ()=>{
  const email = loginEmail.value.trim();
  const password = loginPass.value;
  if(!email || !password){ loginMsg.textContent = "Completează email + parolă."; return; }
  loginMsg.textContent = "Autentific…";
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ loginMsg.textContent = "Login: " + error.message; return; }
  session = data.session;
  myRole = await fetchMyRole();
  closeLogin();
  applyAuthUI();
});

btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  session = null;
  myRole = "viewer";
  applyAuthUI();
});

(async function init(){
  setCloud("standby","warn");
  const { data } = await sb.auth.getSession();
  session = data?.session || null;
  if(session) myRole = await fetchMyRole();
  applyAuthUI();

  sb.auth.onAuthStateChange(async (_evt, sess)=>{
    session = sess;
    myRole = session ? await fetchMyRole() : "viewer";
    applyAuthUI();
  });
})();
</script>
</body>
</html>
